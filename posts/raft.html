<!DOCTYPE html><html class=scrollbar-none lang=zh><head><meta charset=utf-8><link href=http://jzhu.xyz/posts/raft.html rel=canonical><meta content="width=device-width,initial-scale=1" name=viewport><meta content="ie=edge" http-equiv=x-ua-compatible><link href=/favicon.ico rel=icon><link href=/apple-touch-icon.png rel=apple-touch-icon><title>Raft Notes</title><meta content="Raft Notes" name=title><meta name=description><link href=/rss.xml rel=alternate title="Junhui's garage RSS Feed" type=application/rss+xml><link href=/sitemap-index.xml rel=sitemap title="Junhui's garage site map" type=application/xml><meta content=http://jzhu.xyz/posts/raft.html property=og:url><meta content="Raft Notes" property=og:title><meta content=website property=og:type><meta property=og:description><meta content=http://jzhu.xyz/posts/raft.html.png property=og:image><meta content="Junhui's garage" property=og:site_name><meta content=summary_large_image name=twitter:card><meta content=http://jzhu.xyz/posts/raft.html name=twitter:url><meta content="Raft Notes" name=twitter:title><meta name=twitter:description><meta content=http://jzhu.xyz/posts/raft.html.png name=twitter:image><meta content=true name=astro-view-transitions-enabled><meta content=animate name=astro-view-transitions-fallback><link href=/_astro/about.BrhoeKCr.css rel=stylesheet><link href=/_astro/about.44ThaYkS.css rel=stylesheet><script type=module src=/_astro/hoisted.CfD9_vnQ.js></script><script type=module src=/_astro/page.si7EJ8pT.js></script></head><body class="flex flex-col bg-local bg-[#f7f7f7] dark:bg-[#202124] dark:text-neutral-50 justify-between lg:pb-[3dvh] lg:pt-[6dvh] min-h-dvh py-[2dvh] text-neutral-600"><div class="flex flex-col bg-local bg-neutral-50 dark:bg-[#212223] dark:shadow-[0_0_0.5em_0.25em_rgba(136,136,136,0.35)] grow lg:p-[2dvw] max-w-[1400px] mx-auto p-[3dvw] shadow-[0_0.5em_1em_0_rgba(236,236,236,0.86)] w-[90dvw]"><header class="grid grid-cols-2 items-start justify-between lg:flex"><a href=/ class="" aria-label="go to index" data-astro-transition-persist=astro-tpw7oqt3-1>Junhui's garage </a><button aria-label="open menu" class="justify-self-end lg:hidden" title="open menu" data-astro-transition-persist=astro-rgoj5e2l-2 id=menu-btn aria-controls=menu-items aria-expanded=false><svg class=size-8 viewBox="0 0 24 24" data-icon=ri:menu-fill height=1em width=1em><symbol id=ai:ri:menu-fill><path d="M3 4h18v2H3zm0 7h18v2H3zm0 7h18v2H3z" fill=currentColor /></symbol><use xlink:href=#ai:ri:menu-fill></use></svg></button><div class="flex-col gap-3 col-span-2 hidden lg:flex lg:items-end text-center" id=menu><div class="flex flex-col lg:flex-row gap-3 items-center lg:gap-8 lg:mb-7 mb-[2dvh]"><nav><ul class="flex flex-col lg:flex-row gap-3 font-default-sans"><li><button aria-label="Navigate to Home" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=false type=button data-nav=Home><a href=/ >Home</a></button></li><li><button aria-label="Navigate to Blog" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=true type=button data-nav=Blog><a href=/blog>Blog</a></button></li><li><button aria-label="Navigate to Tags" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=false type=button data-nav=Tags><a href=/tags>Tags</a></button></li><li><button aria-label="Navigate to Archives" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=false type=button data-nav=Archives><a href=/archives>Archives</a></button></li><li><button aria-label="Navigate to About" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=false type=button data-nav=About><a href=/about>About</a></button></li></ul></nav><a href=/search aria-label="Navigate to search page" title="Navigate to search page"><svg class="hover:opacity-100 opacity-75" viewBox="0 0 24 24" data-icon=ri:search-2-line height=1em width=1em><symbol id=ai:ri:search-2-line><path d="M11 2c4.968 0 9 4.032 9 9s-4.032 9-9 9s-9-4.032-9-9s4.032-9 9-9m0 16c3.867 0 7-3.133 7-7s-3.133-7-7-7s-7 3.133-7 7s3.133 7 7 7m8.485.071l2.829 2.828l-1.415 1.415l-2.828-2.829z" fill=currentColor /></symbol><use xlink:href=#ai:ri:search-2-line></use></svg></a><div class="flex gap-3 forced-colors:hidden" data-astro-transition-persist=astro-t5bszqxv-6><button aria-label="Switch to os-default theme" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 theme-toggler" aria-pressed=false type=button data-theme=os-default><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:contrast-fill height=1em width=1em><symbol id=ai:ri:contrast-fill><path d="M12 21.997c-5.523 0-10-4.477-10-10s4.477-10 10-10s10 4.477 10 10s-4.477 10-10 10m0-2v-16a8 8 0 0 0 0 16" fill=currentColor /></symbol><use xlink:href=#ai:ri:contrast-fill></use></svg></button><button aria-label="Switch to light theme" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 theme-toggler" aria-pressed=false type=button data-theme=light><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:sun-fill height=1em width=1em><symbol id=ai:ri:sun-fill><path d="M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12M11 1h2v3h-2zm0 19h2v3h-2zM3.515 4.929l1.414-1.414L7.05 5.636L5.636 7.05zM16.95 18.364l1.414-1.414l2.121 2.121l-1.414 1.414zm2.121-14.85l1.414 1.415l-2.121 2.121l-1.414-1.414zM5.636 16.95l1.414 1.414l-2.121 2.121l-1.414-1.414zM23 11v2h-3v-2zM4 11v2H1v-2z" fill=currentColor /></symbol><use xlink:href=#ai:ri:sun-fill></use></svg></button><button aria-label="Switch to dark theme" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 theme-toggler" aria-pressed=false type=button data-theme=dark><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:moon-line height=1em width=1em><symbol id=ai:ri:moon-line><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2h.1A6.98 6.98 0 0 0 10 7m-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938A8 8 0 0 0 4 12" fill=currentColor /></symbol><use xlink:href=#ai:ri:moon-line></use></svg></button></div></div><div>再见无脚鸟</div><div class="flex gap-3 flex-wrap justify-center lg:mt-0 mt-[2dvh]"><a href=edison.jzhu@gmail.com aria-label=mail><svg class="hover:opacity-100 opacity-75 fill-current" viewBox="0 0 24 24" data-icon=ri:mail-fill height=1em width=1em><title>mail</title><symbol id=ai:ri:mail-fill><path d="M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1m9.06 8.683L5.648 6.238L4.353 7.762l7.72 6.555l7.581-6.56l-1.308-1.513z" fill=currentColor /></symbol><use xlink:href=#ai:ri:mail-fill></use></svg> </a><a href=https://github.com/jblueberry aria-label=github><svg class="hover:opacity-100 opacity-75 fill-current" viewBox="0 0 24 24" data-icon=ri:github-fill height=1em width=1em><title>github</title><symbol id=ai:ri:github-fill><path d="M12.001 2c-5.525 0-10 4.475-10 10a9.99 9.99 0 0 0 6.837 9.488c.5.087.688-.213.688-.476c0-.237-.013-1.024-.013-1.862c-2.512.463-3.162-.612-3.362-1.175c-.113-.288-.6-1.175-1.025-1.413c-.35-.187-.85-.65-.013-.662c.788-.013 1.35.725 1.538 1.025c.9 1.512 2.337 1.087 2.912.825c.088-.65.35-1.087.638-1.337c-2.225-.25-4.55-1.113-4.55-4.938c0-1.088.387-1.987 1.025-2.687c-.1-.25-.45-1.275.1-2.65c0 0 .837-.263 2.75 1.024a9.3 9.3 0 0 1 2.5-.337c.85 0 1.7.112 2.5.337c1.913-1.3 2.75-1.024 2.75-1.024c.55 1.375.2 2.4.1 2.65c.637.7 1.025 1.587 1.025 2.687c0 3.838-2.337 4.688-4.562 4.938c.362.312.675.912.675 1.85c0 1.337-.013 2.412-.013 2.75c0 .262.188.574.688.474A10.02 10.02 0 0 0 22 12c0-5.525-4.475-10-10-10" fill=currentColor /></symbol><use xlink:href=#ai:ri:github-fill></use></svg> </a><a href=/rss.xml aria-label="the RSS link"><svg class="hover:opacity-100 opacity-75 fill-current" viewBox="0 0 24 24" data-icon=ri:rss-fill height=1em width=1em><title>the RSS link</title><symbol id=ai:ri:rss-fill><path d="M3 3c9.941 0 18 8.059 18 18h-3c0-8.284-6.716-15-15-15zm0 7c6.075 0 11 4.925 11 11h-3a8 8 0 0 0-8-8zm0 7a4 4 0 0 1 4 4H3z" fill=currentColor /></symbol><use xlink:href=#ai:ri:rss-fill></use></svg></a></div></div></header><main class="pt-[2dvh] lg:pt-[6dvh] px-[2dvw]"><h1 class="font-extrabold text-5xl">Raft Notes</h1><div class="dark:text-neutral-300 lg:my-[3dvh] my-[1dvh] text-neutral-600"><div class="flex flex-col lg:flex-row *:flex *:items-center lg:gap-4 opacity-70"><time datetime=2024-07-21T08:40:27.701Z><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:time-line height=1em width=1em aria-label=date><title>date</title><symbol id=ai:ri:time-line><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10m0-2a8 8 0 1 0 0-16a8 8 0 0 0 0 16m1-8h4v2h-6V7h2z" fill=currentColor /></symbol><use xlink:href=#ai:ri:time-line></use></svg> 7/21/2024, 8:40:27 AM </time><time datetime=2024-07-21T08:40:27.701Z><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:history-line height=1em width=1em aria-label="last modified date"><title>last modified date</title><symbol id=ai:ri:history-line><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12h2a8 8 0 1 0 1.385-4.5H8v2H2v-6h2V6a9.99 9.99 0 0 1 8-4m1 5v4.585l3.243 3.243l-1.415 1.415L11 12.413V7z" fill=currentColor /></symbol><use xlink:href=#ai:ri:history-line></use></svg> 7/21/2024, 8:40:27 AM </time><span><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:hourglass-fill height=1em width=1em aria-label="read time"><title>read time</title><symbol id=ai:ri:hourglass-fill><path d="M6 4H4V2h16v2h-2v2c0 1.615-.816 2.915-1.844 3.977c-.703.726-1.558 1.395-2.425 2.023c.867.628 1.722 1.297 2.425 2.023C17.184 15.085 18 16.385 18 18v2h2v2H4v-2h2v-2c0-1.615.816-2.915 1.844-3.977c.703-.726 1.558-1.395 2.425-2.023c-.867-.628-1.722-1.297-2.425-2.023C6.816 8.915 6 7.615 6 6zm2 0v2c0 .685.26 1.335.771 2h6.458c.51-.665.771-1.315.771-2V4zm4 9.222c-1.045.738-1.992 1.441-2.719 2.192a7 7 0 0 0-.51.586h6.458a7 7 0 0 0-.51-.586c-.727-.751-1.674-1.454-2.719-2.192" fill=currentColor /></symbol><use xlink:href=#ai:ri:hourglass-fill></use></svg> 14 min read</span></div><div><a href=/tags/Golang/1 class="hover:opacity-100 mr-2 opacity-80 text-xl" aria-label="More posts of tag Golang">Golang </a><a href="/tags/Distributed Systems/1" class="hover:opacity-100 mr-2 opacity-80 text-xl" aria-label="More posts of tag Distributed Systems">Distributed Systems</a></div></div><article class="[&#38;_.toc-item]:my-0 [&#38;_.toc-level]:mt-0 [&#38;_iframe]:rounded-lg [&#38;_p_code]:after:content-none [&#38;_p_code]:before:content-none [&#38;_p_code]:bg-neutral-100 [&#38;_p_code]:p-1 [&#38;_p_code]:rounded dark:[&#38;_p_code]:bg-[#121212] dark:prose-invert max-w-full prose prose-img:rounded-lg prose-p:hyphens-auto prose-p:text-justify prose-pre:!bg-neutral-100 prose-pre:rounded-lg prose-video:rounded-lg"><nav class=toc><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a href=#raft class="toc-link toc-link-h2">Raft</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a href=#leader-election class="toc-link toc-link-h3">Leader election</a></li><li class="toc-item toc-item-h3"><a href=#log-replication class="toc-link toc-link-h3">Log replication</a></li><li class="toc-item toc-item-h3"><a href=#safety class="toc-link toc-link-h3">Safety</a></li></ol></li><li class="toc-item toc-item-h2"><a href=#6824-lab2 class="toc-link toc-link-h2">6.824 lab2</a></li></ol></nav><p>2023.02.05 update: 实际上这个 lab 我做的复杂了，不一定需要用条件变量。</p><p>2024.07.21 update: 从现在的经验上看，用多线程或者 goroutine 是很危险的事情。</p><h2 id=raft>Raft</h2><p>Raft 是简化版的、工程化的 Paxos，分成了 Leader election、Log replication 和 Safety 三个相对独立的模块。</p><p><a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf rel=nofollow target=_blank>Extended Raft paper</a> 详细阐明了 Raft 的逻辑，6.824 的 2A、2B 和 2C 都可以用 paper 里的 Figure 2 来概括。</p><p><img alt=Raft decoding=async height=1136 loading=lazy src=/_astro/raft.D5s_aD-R_jOeFb.webp width=901></p><h3 id=leader-election>Leader election</h3><ol><li>每一个 server 都有内部的 term （从 1 开始）和投票状态 <code>votedFor</code>。term 在 Raft 中是一个非常特殊的状态变量，对于某一个 server 来说，只有在<strong>在一定时间没有收到 leader 的 heartbeat</strong> 后（包括出现 split votes 的情况下），才会引发 term 的自增，而 term 的自增总会伴随着一阵新的 election。</li><li>每一个 candidate 向 peer 发送 <code>RequestVote</code> 后，如果得到了超过半数的 votes，便会转化为 leader。自此，该 server 会尝试着维持现在的 term，并作为 leader 周期性 heartbeat followers。</li><li>当 follower 收到某个 leader 的 heartbeat 后，如果（在这个 RPC 中）该 leader 的 term 比自己的 term 小（这意味着该 leader 不应该再是 leader，因为一定存在一个 server 已经自增 term 并尝试成为新的 leader），此时需要将该信息 response 给该 leader，让其退化为 follower。<strong>这里的该 leader 的真实状态不一定真的是 leader，因为可能存在网络延迟的问题，这个 heartbeat RPC 被推迟送达。</strong></li><li>当某个 leader 的 heartbeat 信息中的 term 大于等于 follower 的 term 时，follower <strong>无条件</strong>认可该 leader 的信息。可能会觉得 follower 的行为过于被动，但是 follower 用 <strong>term</strong> 对 leader 的 check 本身就保证了安全性。<strong>对于每一个 follower 本身来说，只要 leader 的 term 至少比我的 term 大，那它的状态便是超前于我的，我便可以接受它的指令，即使它现在可能早就不是 leader 了。</strong></li><li>Raft 采用 random election timeouts 来避免 split votes。</li></ol><h3 id=log-replication>Log replication</h3><ol><li>每一个 leader 需要维护 peers 的 matchIndex 和 nextIndex 状态。<ol><li>每一个 heartbeat RPC 里携带了需要给该 follower 同步的 log entries，在 <a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf rel=nofollow target=_blank>Extended Raft paper</a> 里每个 RPC 只有一个或者零个（pure heartbeat），但是在 6.824 lab2C 里会优化这个机制，让每个 RPC 携带多个 entries，提高效率。<strong>而对于每个 follower 来说，其 heartbeat RPC 里要放哪些 entries，取决于该 leader 为其维护的 nextIndex。</strong></li><li>当某个 heartbeat 携带了 entries 并得到了对方 follower 的肯定回复时，该 leader 便可以断定该 follower 已经同步了 heartbeat 中涵盖的 log 信息，也就是，完成了 replication，此时可以修改该 follower 的 matchIndex 和 nextIndex。</li><li>每一个 heartbeat RPC 都包含着发送该 RPC 的 leader 认为该 follower 当前所需要同步的 entry index。显然这并不是任何时候都成立的，因此，对于某个 follower，假如该 heartbeat 是合法的（term checked），但是 leader 搞错了 follower 实际需要的 entry index，follower 便会返回 <code>false</code>，让 leader 去修正其为该 follower 维护的 nextIndex，<strong>直到被 follower 肯定回复</strong>。</li><li>在某个 server 刚刚转化为 leader 时，初始化每个 follower 的 matchIndex 为 <code>0</code>，并初始化每个 follower 的 nextIndex 为 <code>nextLogIndex</code>。每一个 server 的 <code>nextLogIndex</code> 是该 server 下一个 potential log entry 的 index。</li></ol></li><li>每一个 server 都需要维护 commitIndex 和 lastApplied。commitIndex 表示：到 commitIndex 之前，所有的 log entry 都被该系统中的 majority 所认可，可以直接放心作用于状态机；lastApplied 表示当前真正已经被作用于状态机（这个动作称为 apply）的最后一个 entry 的 index。<ol><li>对于 leader 来说，由于外部（上层应用的）entry 只能被 leader 所接受，而也只有 leader 会尝试将 entry 同步给 followers，因此 leader 会在某些 entry 被大部分机器所承认时，<strong>主动</strong>修改 commitIndex（在这里，这些 entry 被成为<strong>被 commit</strong> 了。），并将其作为 heartbeat RPC 的一部分信息同步给 followers；</li><li>对于 follower 来说，所有对 commitIndex 的修改都源自于 leader 的 heartbeat。在一般情况下，当 leader 的 commitIndex 大于自身的时，便同步成 leader 的。</li><li>每一个 server 都需要检查自身的 commitIndex 和 lastApplied，当前者大于后者时，便意味着有事情做了，可以把一些 entry 给 apply 掉了。</li></ol></li></ol><h3 id=safety>Safety</h3><p>Leader election 和 log replication 显然是需要某些约束才能保证 Raft 的正确性的。<a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf rel=nofollow target=_blank>Extended Raft paper</a> 中笼统概括了一些 Safety properties，但是在写 lab 的时候，其实有更多的细节需要去考虑到。</p><ol><li>首先，当所有的 RPC 中包含的 term 小于 server 自身的 term 时，忽略它，或者是返回 <code>false</code>（如果有）。</li><li>当一个 candidate 向其他 server requests votes 时，对于某一个特定的 server，只有该 candidate 的 log 与它自己的 log 相比 <strong>least as up-to-date</strong> 时，才会给予 vote。Log 之间的 up-to-date 是一个非常微妙的比较关系，参考 paper 第 8 页。</li><li>Leader 绝对不可以 commit 不是当前 term 的 entry，即使它确实已经被集群 majority 所共识。该性质解决了 paper 中 Figure 8 阐述的问题，简单来说便是，如果 leader 可以随意 commit 任意被集群多数所共识的 entry，会产生某个 index 的 entry 被 apply 多次的灾难现象，而这是绝对不允许的。<a href=https://zhuanlan.zhihu.com/p/369989974 rel=nofollow target=_blank>这篇知乎文章</a>详细解释了 Figure 8，并使用了一个 no-op 来解决这个问题，我最后的代码实现并没有采用额外的 no-op 来做这件事，而是<strong>在 leader 尝试进行 commitIndex 前，进行额外的 term 对比</strong>，假如该 leader 只能找到不是当前 term 的、但是被多数机器所认可的 entry，便<strong>不修改 commitIndex</strong>。</li></ol><h2 id=6824-lab2>6.824 lab2</h2><p>即使看懂了 paper 里 election、replication 和 safety 的三块阐述，编写 lab2 时还是会出现各种各样的奇怪 bug，我最后的版本在连续跑了 800 次 test 后没有报错，提一些细节处理。</p><ol><li>控制锁的粒度，就像 <a href="https://www.youtube.com/watch?v=UzzcUS2OHqo&#x26;list=PLrw6a1wE39_tb2fErI4-WkMbsvGQk9_UB&#x26;index=5" rel=nofollow target=_blank>6.824 助教说的</a>一样，千万不要用很多小锁来保护各种各样的 shared data，锁的粒度太小时跟没有锁是一样的。<strong>锁的终极目的，并不是为了保护 shared data 的原子读写，而是让某些代码（某些行为）连续发生，因此要站在程序运行的角度上去考虑锁的用处。</strong></li><li>尽量用一把大锁去保护临界区，控制并发的力度，可以先从不并发的串行程序开始，小心慢慢提高并发的力度。并发的力度太大会导致很多难以理解的行为，个人建议只需让“真正发送 RPC” 这件事（也就是调用 Call）并发化，会减少很多问题的产生。</li><li><code>votedFor</code> 这个变量需要额外小心，它需要一个 default value（比如 <code>-1</code> ）。<ol><li>根据 Figure 2 和 <a href=https://raft.github.io rel=nofollow target=_blank>Raft 演示</a>，当 follower 做出投票行为时，需要修改 <code>votedFor</code>；</li><li>在 server 收到 RequestVote RPC 时，如果它在先前已经投票给了一个 server，而此时新的 candidate 的 term 更超前时，首先要修改 <code>votedFor</code> 为 default value（意味着回到没有给出投票的状态）；</li><li>在 server 接收 leader 的 heartbeat 时，如果该 server 先前没有投票给该 leader，set <code>votedFor</code> to default value。拍脑袋一想，会觉得这是没有必要的，因为 2 已经保证了 election 开始时，server 会检查 term 重置 <code>votedFor</code>，但在网络不稳定的 Figure 8 的情况下，会更容易产生谁都选不上的活锁；</li><li>在所有的 RPC 调用之后，需要检查 reply 中的 term，如果对方的 term 比自己还要超前，便退化为 follower，退化时也要 <strong>set <code>votedFor</code> to default value</strong>。</li></ol></li><li>在 leader 真正发送 heartbeat RPC 和 candidate 真正发送 <code>ReuqustVote</code> 之前（调用 labrpc 中 Call 方法前），检查当前 go routine 是否已经过期。举个例子，因为调度器的原因，某个过期 leader 的 heartbeat routine 在它被其他 leader heartbeat 后才刚刚被调度运行，而此时的 term 已经超前于创建该 routine 时候的 term，需要设计一个机制来过滤这样的过期 routine（在创建时传入当前 term）；</li><li>用多个 routine 对 commitIndex 和 lastApplied 进行监控，用条件变量进行 routine 之间的通信；</li><li>对 nextIndex 定位的优化可以参考 <a href=https://thesquareplanet.com/blog/students-guide-to-raft/ rel=nofollow target=_blank>6.824 助教的文章</a>，这篇文章也提到了许多实现 Raft 时需要注意的细节。要注意，这篇文章假定了 log entry 的 index 从 0 开始，如果你和我一样严格遵守 Figure 2 让 entry index 从 1 开始，需要自己在其思路上额外做一些修改，<strong>并且在完成 lab2D Snapshot 部分时，也需要针对该 optimization 再处理一些额外的边界条件</strong>；</li><li>在发送 apply entry 时（发送 ApplyMsg 给 channel 时），需要注意<strong>锁</strong>。一个推荐的行为是，在等待 channel 消费 ApplyMsg 时把锁释放，换句话说，在 <code>rf.applyCh &#x3C;- msg</code> 前把锁释放，否则在 2D 有可能会产生无限等待的死锁情况（这个死锁还不会被检测到）。</li></ol><p>最终实现的版本的测试结果的 time consuming、RPC numbers 可以参考：</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">bash</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=bash lang=bash style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#59873a;--shiki-dark:#80A665>➜</span><span style=color:#b56959;--shiki-dark:#C98A7D>  raft</span><span style=color:#b56959;--shiki-dark:#C98A7D> git:</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#59873a;--shiki-dark:#80A665>master</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#b56959;--shiki-dark:#C98A7D> ✗</span><span style=color:#b56959;--shiki-dark:#C98A7D> go</span><span style=color:#b56959;--shiki-dark:#C98A7D> test</span><span style=color:#a65e2b;--shiki-dark:#C99076> -race</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>Test</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> (2A): initial election ...</span></span>
<span class=line><span style=color:#998418;--shiki-dark:#B8A965>  ...</span><span style=color:#b56959;--shiki-dark:#C98A7D> Passed</span><span style=color:#a65e2b;--shiki-dark:#C99076> --</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   3.0</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  3</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   74</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   24538</span><span style=color:#2f798a;--shiki-dark:#4C9A91>    0</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>Test</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> (2A): election after network failure ...</span></span>
<span class=line><span style=color:#998418;--shiki-dark:#B8A965>  ...</span><span style=color:#b56959;--shiki-dark:#C98A7D> Passed</span><span style=color:#a65e2b;--shiki-dark:#C99076> --</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   4.5</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  3</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  156</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   31934</span><span style=color:#2f798a;--shiki-dark:#4C9A91>    0</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>Test</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> (2A): multiple elections ...</span></span>
<span class=line><span style=color:#998418;--shiki-dark:#B8A965>  ...</span><span style=color:#b56959;--shiki-dark:#C98A7D> Passed</span><span style=color:#a65e2b;--shiki-dark:#C99076> --</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   5.5</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  7</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  636</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  138233</span><span style=color:#2f798a;--shiki-dark:#4C9A91>    0</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>Test</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> (2B): basic agreement ...</span></span>
<span class=line><span style=color:#998418;--shiki-dark:#B8A965>  ...</span><span style=color:#b56959;--shiki-dark:#C98A7D> Passed</span><span style=color:#a65e2b;--shiki-dark:#C99076> --</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   0.7</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  3</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   16</span><span style=color:#2f798a;--shiki-dark:#4C9A91>    5272</span><span style=color:#2f798a;--shiki-dark:#4C9A91>    3</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>Test</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> (2B): RPC byte count ...</span></span>
<span class=line><span style=color:#998418;--shiki-dark:#B8A965>  ...</span><span style=color:#b56959;--shiki-dark:#C98A7D> Passed</span><span style=color:#a65e2b;--shiki-dark:#C99076> --</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   2.0</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  3</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   48</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  116836</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   11</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>Test</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> (2B): agreement after follower reconnects ...</span></span>
<span class=line><span style=color:#998418;--shiki-dark:#B8A965>  ...</span><span style=color:#b56959;--shiki-dark:#C98A7D> Passed</span><span style=color:#a65e2b;--shiki-dark:#C99076> --</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   5.8</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  3</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  156</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   48680</span><span style=color:#2f798a;--shiki-dark:#4C9A91>    8</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>Test</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> (2B): no agreement </span><span style=color:#1e754f;--shiki-dark:#4D9375>if</span><span style=color:#59873a;--shiki-dark:#80A665> too</span><span style=color:#b56959;--shiki-dark:#C98A7D> many</span><span style=color:#b56959;--shiki-dark:#C98A7D> followers</span><span style=color:#b56959;--shiki-dark:#C98A7D> disconnect</span><span style=color:#b56959;--shiki-dark:#C98A7D> ...</span></span>
<span class=line><span style=color:#998418;--shiki-dark:#B8A965>  ...</span><span style=color:#b56959;--shiki-dark:#C98A7D> Passed</span><span style=color:#a65e2b;--shiki-dark:#C99076> --</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   3.7</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  5</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  248</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   56540</span><span style=color:#2f798a;--shiki-dark:#4C9A91>    3</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>Test</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> (2B): concurrent </span><span style=color:#59873a;--shiki-dark:#80A665>Start</span><span style=color:#999;--shiki-dark:#666666>()</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>s ...</span></span>
<span class=line><span style=color:#998418;--shiki-dark:#B8A965>  ...</span><span style=color:#b56959;--shiki-dark:#C98A7D> Passed</span><span style=color:#a65e2b;--shiki-dark:#C99076> --</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   0.7</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  3</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   14</span><span style=color:#2f798a;--shiki-dark:#4C9A91>    4602</span><span style=color:#2f798a;--shiki-dark:#4C9A91>    6</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>Test</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> (2B): rejoin of partitioned leader ...</span></span>
<span class=line><span style=color:#998418;--shiki-dark:#B8A965>  ...</span><span style=color:#b56959;--shiki-dark:#C98A7D> Passed</span><span style=color:#a65e2b;--shiki-dark:#C99076> --</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   4.2</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  3</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  182</span><span style=color:#2f798a;--shiki-dark:#4C9A91>   44785</span><span style=color:#2f798a;--shiki-dark:#4C9A91>    4</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>Test</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> (2B): leader backs up quickly over incorrect follower logs ...</span></span>
<span class=line><span style=color:#998418;--shiki-dark:#B8A965>  ...</span><span style=color:#b56959;--shiki-dark:#C98A7D> Passed</span><span style=color:#a65e2b;--shiki-dark:#C99076> --</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  20.3</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  5</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 2256</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 1296886</span><span style=color:#2f798a;--shiki-dark:#4C9A91>  102</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>Test</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> (2B): RPC counts aren</span><span style=color:#b5695999;--shiki-dark:#C98A7D99>'</span><span style=color:#b56959;--shiki-dark:#C98A7D>t too high ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --   2.2  3   50   17328   12</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2C): basic persistence ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --   4.0  3  112   31325    6</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2C): more persistence ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --  16.6  5 1168  272848   16</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2C): partitioned leader and one follower crash, leader restarts ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --   1.8  3   42   12032    4</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2C): Figure 8 ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --  34.7  5 1528  341677   36</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2C): unreliable agreement ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --   4.2  5  212   84694  246</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2C): Figure 8 (unreliable) ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --  38.8  5 4064 7936640  209</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2C): churn ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --  16.6  5  912  837728  251</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2C): unreliable churn ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --  16.3  5  620  216412   50</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2D): snapshots basic ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --   5.6  3  140   57416  220</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2D): install snapshots (disconnect) ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --  62.2  3 1758  727536  308</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2D): install snapshots (disconnect+unreliable) ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --  75.2  3 2098  838116  355</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2D): install snapshots (crash) ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --  32.3  3  818  412298  335</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2D): install snapshots (unreliable+crash) ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --  38.0  3  956  409544  268</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>Test (2D): crash and restart all servers ...</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>  ... Passed --  10.0  3  248   84358   53</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>PASS</span></span>
<span class=line><span style=color:#b56959;--shiki-dark:#C98A7D>ok      6.824/raft      410.052s</span></span>
<span class=line></span></code></pre></div></article><hr class="bg-zinc-200 border-0 dark:bg-zinc-700 h-1 md:my-10 mx-auto my-4 rounded w-48"><div class="[&_main]:transition-colors giscus"></div></main></div><footer class="lg:mt-[4dvh] mt-[3dvh] text-center" data-astro-transition-persist=astro-tvayyljk-4><p class="lg:mb-[2dvh] mb-[1dvh]">In Search of Identity</p><p class="opacity-75 text-neutral-700 dark:text-neutral-300">&copy; 2024 Ladit. Powered by <a href=https://astro.build class=underline aria-label="Read more about Astro" rel=noopener target=_blank>Astro</a>. <a href=https://github.com/ladit/astro-blog-zozo class=underline aria-label="Read more about this theme" rel=noopener target=_blank>Theme</a> by Ladit.</p></footer><button aria-label="Back to top" class="hidden fixed 	bottom-6 	right-6 size-10 	cursor-pointer 	place-content-center 	rounded-full 	bg-[#f0f0f0] 	opacity-60 	hover:opacity-100 	dark:bg-[#555555]" title="Back to top" data-astro-transition-persist=astro-w6n6ksoh-5 id=back-to-top><svg class="fill-current self-center size-8" viewBox="0 0 24 24" data-icon=ri:arrow-up-double-fill height=1em width=1em><symbol id=ai:ri:arrow-up-double-fill><path d="m12 4.836l-6.207 6.207l1.414 1.414L12 7.664l4.793 4.793l1.414-1.414zm0 5.65l-6.207 6.207l1.414 1.414L12 13.314l4.793 4.793l1.414-1.414z" fill=currentColor /></symbol><use xlink:href=#ai:ri:arrow-up-double-fill></use></svg></button></body></html><script type=module>const copy=async t=>{const e=t.nextElementSibling?.children[0];e&&(await navigator.clipboard.writeText(e.textContent),t.setAttribute("aria-pressed","true"),setTimeout((()=>{t.setAttribute("aria-pressed","false")}),700))},copyButtons=Array.from(document.querySelectorAll(".prose button.copy"));for(const t of copyButtons)t.addEventListener("click",(()=>copy(t)))</script>