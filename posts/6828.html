<!DOCTYPE html><html class=scrollbar-none lang=zh><head><meta charset=utf-8><link href=http://jzhu.xyz/posts/6828.html rel=canonical><meta content="width=device-width,initial-scale=1" name=viewport><meta content="ie=edge" http-equiv=x-ua-compatible><link href=/favicon.ico rel=icon><link href=/apple-touch-icon.png rel=apple-touch-icon><title>Notes of 6.S081</title><meta content="Notes of 6.S081" name=title><meta name=description><link href=/rss.xml rel=alternate title="Junhui's garage RSS Feed" type=application/rss+xml><link href=/sitemap-index.xml rel=sitemap title="Junhui's garage site map" type=application/xml><meta content=http://jzhu.xyz/posts/6828.html property=og:url><meta content="Notes of 6.S081" property=og:title><meta content=website property=og:type><meta property=og:description><meta content=http://jzhu.xyz/posts/6828.html.png property=og:image><meta content="Junhui's garage" property=og:site_name><meta content=summary_large_image name=twitter:card><meta content=http://jzhu.xyz/posts/6828.html name=twitter:url><meta content="Notes of 6.S081" name=twitter:title><meta name=twitter:description><meta content=http://jzhu.xyz/posts/6828.html.png name=twitter:image><meta content=true name=astro-view-transitions-enabled><meta content=animate name=astro-view-transitions-fallback><link href=/_astro/about.BrhoeKCr.css rel=stylesheet><link href=/_astro/about.44ThaYkS.css rel=stylesheet><script type=module src=/_astro/hoisted.CfD9_vnQ.js></script><script type=module src=/_astro/page.si7EJ8pT.js></script></head><body class="flex flex-col bg-local bg-[#f7f7f7] dark:bg-[#202124] dark:text-neutral-50 justify-between lg:pb-[3dvh] lg:pt-[6dvh] min-h-dvh py-[2dvh] text-neutral-600"><div class="flex flex-col bg-local bg-neutral-50 dark:bg-[#212223] dark:shadow-[0_0_0.5em_0.25em_rgba(136,136,136,0.35)] grow lg:p-[2dvw] max-w-[1400px] mx-auto p-[3dvw] shadow-[0_0.5em_1em_0_rgba(236,236,236,0.86)] w-[90dvw]"><header class="justify-between grid grid-cols-2 items-start lg:flex"><a href=/ class="" aria-label="go to index" data-astro-transition-persist=astro-tpw7oqt3-1>Junhui's garage </a><button aria-label="open menu" class="justify-self-end lg:hidden" title="open menu" data-astro-transition-persist=astro-rgoj5e2l-2 id=menu-btn aria-controls=menu-items aria-expanded=false><svg class=size-8 viewBox="0 0 24 24" data-icon=ri:menu-fill height=1em width=1em><symbol id=ai:ri:menu-fill><path d="M3 4h18v2H3zm0 7h18v2H3zm0 7h18v2H3z" fill=currentColor /></symbol><use xlink:href=#ai:ri:menu-fill></use></svg></button><div class="hidden col-span-2 flex-col gap-3 lg:flex lg:items-end text-center" id=menu><div class="flex flex-col lg:flex-row gap-3 items-center lg:gap-8 lg:mb-7 mb-[2dvh]"><nav><ul class="flex flex-col lg:flex-row gap-3 font-default-sans"><li><button aria-label="Navigate to Home" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=false type=button data-nav=Home><a href=/ >Home</a></button></li><li><button aria-label="Navigate to Blog" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=true type=button data-nav=Blog><a href=/blog>Blog</a></button></li><li><button aria-label="Navigate to Tags" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=false type=button data-nav=Tags><a href=/tags>Tags</a></button></li><li><button aria-label="Navigate to Archives" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=false type=button data-nav=Archives><a href=/archives>Archives</a></button></li><li><button aria-label="Navigate to About" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=false type=button data-nav=About><a href=/about>About</a></button></li></ul></nav><a href=/search aria-label="Navigate to search page" title="Navigate to search page"><svg class="hover:opacity-100 opacity-75" viewBox="0 0 24 24" data-icon=ri:search-2-line height=1em width=1em><symbol id=ai:ri:search-2-line><path d="M11 2c4.968 0 9 4.032 9 9s-4.032 9-9 9s-9-4.032-9-9s4.032-9 9-9m0 16c3.867 0 7-3.133 7-7s-3.133-7-7-7s-7 3.133-7 7s3.133 7 7 7m8.485.071l2.829 2.828l-1.415 1.415l-2.828-2.829z" fill=currentColor /></symbol><use xlink:href=#ai:ri:search-2-line></use></svg></a><div class="flex gap-3 forced-colors:hidden" data-astro-transition-persist=astro-t5bszqxv-6><button aria-label="Switch to os-default theme" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 theme-toggler" aria-pressed=false type=button data-theme=os-default><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:contrast-fill height=1em width=1em><symbol id=ai:ri:contrast-fill><path d="M12 21.997c-5.523 0-10-4.477-10-10s4.477-10 10-10s10 4.477 10 10s-4.477 10-10 10m0-2v-16a8 8 0 0 0 0 16" fill=currentColor /></symbol><use xlink:href=#ai:ri:contrast-fill></use></svg></button><button aria-label="Switch to light theme" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 theme-toggler" aria-pressed=false type=button data-theme=light><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:sun-fill height=1em width=1em><symbol id=ai:ri:sun-fill><path d="M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12M11 1h2v3h-2zm0 19h2v3h-2zM3.515 4.929l1.414-1.414L7.05 5.636L5.636 7.05zM16.95 18.364l1.414-1.414l2.121 2.121l-1.414 1.414zm2.121-14.85l1.414 1.415l-2.121 2.121l-1.414-1.414zM5.636 16.95l1.414 1.414l-2.121 2.121l-1.414-1.414zM23 11v2h-3v-2zM4 11v2H1v-2z" fill=currentColor /></symbol><use xlink:href=#ai:ri:sun-fill></use></svg></button><button aria-label="Switch to dark theme" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 theme-toggler" aria-pressed=false type=button data-theme=dark><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:moon-line height=1em width=1em><symbol id=ai:ri:moon-line><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2h.1A6.98 6.98 0 0 0 10 7m-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938A8 8 0 0 0 4 12" fill=currentColor /></symbol><use xlink:href=#ai:ri:moon-line></use></svg></button></div></div><div>再见无脚鸟</div><div class="flex gap-3 flex-wrap justify-center lg:mt-0 mt-[2dvh]"><a href=mailto:edison.jzhu@gmail.com aria-label=mail><svg class="hover:opacity-100 opacity-75 fill-current" viewBox="0 0 24 24" data-icon=ri:mail-fill height=1em width=1em><title>mail</title><symbol id=ai:ri:mail-fill><path d="M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1m9.06 8.683L5.648 6.238L4.353 7.762l7.72 6.555l7.581-6.56l-1.308-1.513z" fill=currentColor /></symbol><use xlink:href=#ai:ri:mail-fill></use></svg> </a><a href=https://github.com/jblueberry aria-label=github><svg class="hover:opacity-100 opacity-75 fill-current" viewBox="0 0 24 24" data-icon=ri:github-fill height=1em width=1em><title>github</title><symbol id=ai:ri:github-fill><path d="M12.001 2c-5.525 0-10 4.475-10 10a9.99 9.99 0 0 0 6.837 9.488c.5.087.688-.213.688-.476c0-.237-.013-1.024-.013-1.862c-2.512.463-3.162-.612-3.362-1.175c-.113-.288-.6-1.175-1.025-1.413c-.35-.187-.85-.65-.013-.662c.788-.013 1.35.725 1.538 1.025c.9 1.512 2.337 1.087 2.912.825c.088-.65.35-1.087.638-1.337c-2.225-.25-4.55-1.113-4.55-4.938c0-1.088.387-1.987 1.025-2.687c-.1-.25-.45-1.275.1-2.65c0 0 .837-.263 2.75 1.024a9.3 9.3 0 0 1 2.5-.337c.85 0 1.7.112 2.5.337c1.913-1.3 2.75-1.024 2.75-1.024c.55 1.375.2 2.4.1 2.65c.637.7 1.025 1.587 1.025 2.687c0 3.838-2.337 4.688-4.562 4.938c.362.312.675.912.675 1.85c0 1.337-.013 2.412-.013 2.75c0 .262.188.574.688.474A10.02 10.02 0 0 0 22 12c0-5.525-4.475-10-10-10" fill=currentColor /></symbol><use xlink:href=#ai:ri:github-fill></use></svg> </a><a href=/rss.xml aria-label="the RSS link"><svg class="hover:opacity-100 opacity-75 fill-current" viewBox="0 0 24 24" data-icon=ri:rss-fill height=1em width=1em><title>the RSS link</title><symbol id=ai:ri:rss-fill><path d="M3 3c9.941 0 18 8.059 18 18h-3c0-8.284-6.716-15-15-15zm0 7c6.075 0 11 4.925 11 11h-3a8 8 0 0 0-8-8zm0 7a4 4 0 0 1 4 4H3z" fill=currentColor /></symbol><use xlink:href=#ai:ri:rss-fill></use></svg></a></div></div></header><main class="pt-[2dvh] lg:pt-[6dvh] px-[2dvw]"><h1 class="font-extrabold text-5xl">Notes of 6.S081</h1><div class="dark:text-neutral-300 lg:my-[3dvh] my-[1dvh] text-neutral-600"><div class="flex flex-col lg:flex-row *:flex *:items-center lg:gap-4 opacity-70"><time datetime=2024-07-21T16:44:01.843Z><svg class=fill-current viewBox="0 0 24 24" aria-label=date data-icon=ri:time-line height=1em width=1em><title>date</title><symbol id=ai:ri:time-line><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10m0-2a8 8 0 1 0 0-16a8 8 0 0 0 0 16m1-8h4v2h-6V7h2z" fill=currentColor /></symbol><use xlink:href=#ai:ri:time-line></use></svg> 7/21/2024, 4:44:01 PM </time><time datetime=2024-07-21T16:44:01.843Z><svg class=fill-current viewBox="0 0 24 24" aria-label="last modified date" data-icon=ri:history-line height=1em width=1em><title>last modified date</title><symbol id=ai:ri:history-line><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12h2a8 8 0 1 0 1.385-4.5H8v2H2v-6h2V6a9.99 9.99 0 0 1 8-4m1 5v4.585l3.243 3.243l-1.415 1.415L11 12.413V7z" fill=currentColor /></symbol><use xlink:href=#ai:ri:history-line></use></svg> 7/21/2024, 4:44:01 PM </time><span><svg class=fill-current viewBox="0 0 24 24" aria-label="read time" data-icon=ri:hourglass-fill height=1em width=1em><title>read time</title><symbol id=ai:ri:hourglass-fill><path d="M6 4H4V2h16v2h-2v2c0 1.615-.816 2.915-1.844 3.977c-.703.726-1.558 1.395-2.425 2.023c.867.628 1.722 1.297 2.425 2.023C17.184 15.085 18 16.385 18 18v2h2v2H4v-2h2v-2c0-1.615.816-2.915 1.844-3.977c.703-.726 1.558-1.395 2.425-2.023c-.867-.628-1.722-1.297-2.425-2.023C6.816 8.915 6 7.615 6 6zm2 0v2c0 .685.26 1.335.771 2h6.458c.51-.665.771-1.315.771-2V4zm4 9.222c-1.045.738-1.992 1.441-2.719 2.192a7 7 0 0 0-.51.586h6.458a7 7 0 0 0-.51-.586c-.727-.751-1.674-1.454-2.719-2.192" fill=currentColor /></symbol><use xlink:href=#ai:ri:hourglass-fill></use></svg> 28 min read</span></div><div><a href=/tags/OS/1 class="hover:opacity-100 mr-2 opacity-80 text-xl" aria-label="More posts of tag OS">OS </a><a href=/tags/Chinese/1 class="hover:opacity-100 mr-2 opacity-80 text-xl" aria-label="More posts of tag Chinese">Chinese</a></div></div><article class="[&#38;_.toc-item]:my-0 [&#38;_.toc-level]:mt-0 [&#38;_iframe]:rounded-lg [&#38;_p_code]:after:content-none [&#38;_p_code]:before:content-none [&#38;_p_code]:bg-neutral-100 [&#38;_p_code]:p-1 [&#38;_p_code]:rounded dark:[&#38;_p_code]:bg-[#121212] dark:prose-invert max-w-full prose prose-img:rounded-lg prose-p:hyphens-auto prose-p:text-justify prose-pre:!bg-neutral-100 prose-pre:rounded-lg prose-video:rounded-lg"><nav class=toc><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a href=#system-call class="toc-link toc-link-h2">System call</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a href=#syscall-system-call class="toc-link toc-link-h3">Syscall system call</a><ol class="toc-level toc-level-3"><li class="toc-item toc-item-h4"><a href=#遇到的一些疑问 class="toc-link toc-link-h4">遇到的一些疑问</a></li></ol></li><li class="toc-item toc-item-h3"><a href=#risc-v-系统调用的一些规则摘录 class="toc-link toc-link-h3">RISC-V 系统调用的一些规则摘录</a></li><li class="toc-item toc-item-h3"><a href=#sysinfo-system-call class="toc-link toc-link-h3">Sysinfo system call</a></li></ol></li><li class="toc-item toc-item-h2"><a href=#page-table class="toc-link toc-link-h2">Page table</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a href=#每个进程的-kernel-page-table class="toc-link toc-link-h3">每个进程的 kernel page table</a></li></ol></li><li class="toc-item toc-item-h2"><a href=#trap class="toc-link toc-link-h2">Trap</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a href=#user-mode-下的-trap class="toc-link toc-link-h3">User mode 下的 trap</a><ol class="toc-level toc-level-3"><li class="toc-item toc-item-h4"><a href=#trampolines-的部分代码 class="toc-link toc-link-h4">trampoline.S 的部分代码：</a></li><li class="toc-item toc-item-h4"><a href=#进入-usertrap-后 class="toc-link toc-link-h4">进入 usertrap() 后</a></li><li class="toc-item toc-item-h4"><a href=#usertrapret-干了什么 class="toc-link toc-link-h4">usertrapret() 干了什么</a></li><li class="toc-item toc-item-h4"><a href=#userret class="toc-link toc-link-h4">userret()</a></li></ol></li><li class="toc-item toc-item-h3"><a href=#syscall-中如何传递参数 class="toc-link toc-link-h3">Syscall 中如何传递参数</a></li><li class="toc-item toc-item-h3"><a href=#kernel-mode-下的-trap class="toc-link toc-link-h3">Kernel mode 下的 trap</a></li><li class="toc-item toc-item-h3"><a href=#trap-lab class="toc-link toc-link-h3">Trap lab</a></li></ol></li><li class="toc-item toc-item-h2"><a href=#lazy-page-allocation class="toc-link toc-link-h2">Lazy page allocation</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a href=#追溯-panic class="toc-link toc-link-h3">追溯 panic</a></li><li class="toc-item toc-item-h3"><a href=#解决-panic class="toc-link toc-link-h3">解决 panic</a></li></ol></li></ol></nav><p>因为其实一直都没有好好读过 OSTEP，所以我在最近一周一口气把这本书读完了，但还是感觉不够，因为我知道要学会这玩意必须要 make hands dirty。于是准备快速的把 6.S081 过完，然后把 lab 做掉，再配合读 xv6 的代码。</p><h2 id=system-call>System call</h2><h3 id=syscall-system-call>Syscall system call</h3><p>第一个 lab 没什么好记录的，只不过用 system call 小打小闹而已，从第二个 lab 开始才是真的对 kernel 做事情。</p><h4 id=遇到的一些疑问>遇到的一些疑问</h4><ul><li><p>英语太垃，看不懂这句话：</p><blockquote><p>Add a <code>sys_trace()</code> function in <code>kernel/sysproc.c</code> that implements the new system call by remembering its argument in a new variable in the proc structure (see <code>kernel/proc.h</code>). The functions to retrieve system call arguments from user space are in <code>kernel/syscall.c</code>, and you can see examples of their use in <code>kernel/sysproc.c</code>.</p></blockquote></li></ul><p>龙鸣翻译：要加一个新的函数，这个函数通过在 <code>proc</code> 结构中增加的一个新的变量来实现系统调用，从用户空间拿到系统调用参数的函数在 <code>syscall.c</code> 中。确实没怎么看懂，那就先看看代码。</p><p>一个很关键的汇编文件：<code>usys.S</code></p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">plaintext</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=plaintext lang=plaintext style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span>sleep:</span></span>
<span class=line><span> li a7, SYS_sleep</span></span>
<span class=line><span> ecall</span></span>
<span class=line><span> ret</span></span>
<span class=line><span>.global uptime</span></span>
<span class=line><span>uptime:</span></span>
<span class=line><span> li a7, SYS_uptime</span></span>
<span class=line><span> ecall</span></span>
<span class=line><span> ret</span></span>
<span class=line><span>.global trace</span></span>
<span class=line><span>trace:</span></span>
<span class=line><span> li a7, SYS_trace</span></span>
<span class=line><span> ecall</span></span>
<span class=line><span> ret</span></span>
<span class=line><span></span></span></code></pre></div><p>这个文件可以看到调用 system call 的一些指令，其中 <code>a7</code> 是 RISC-V 的一个寄存器，再看 <code>kernel/syscall.c</code> 当中的一个关键的函数：</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>void</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>syscall</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>void</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  int</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> num</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> proc </span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>p </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> myproc</span><span style=color:#999;--shiki-dark:#666666>();</span></span>
<span class=line></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  num </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#b07d48;--shiki-dark:#BD976A> p</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>trapframe</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>a7</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>num </span><span style=color:#ab5959;--shiki-dark:#CB7676>></span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#ab5959;--shiki-dark:#CB7676> &#x26;&#x26;</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> num </span><span style=color:#ab5959;--shiki-dark:#CB7676>&#x3C;</span><span style=color:#59873a;--shiki-dark:#80A665> NELEM</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>syscalls</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#ab5959;--shiki-dark:#CB7676> &#x26;&#x26;</span><span style=color:#b07d48;--shiki-dark:#BD976A> syscalls</span><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>num</span><span style=color:#999;--shiki-dark:#666666>])</span><span style=color:#999;--shiki-dark:#666666> {</span></span>
<span class=line><span style=color:#b07d48;--shiki-dark:#BD976A>    p</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>trapframe</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>a0</span><span style=color:#999;--shiki-dark:#666666> =</span><span style=color:#b07d48;--shiki-dark:#BD976A> syscalls</span><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>num</span><span style=color:#999;--shiki-dark:#666666>]();</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>  }</span><span style=color:#1e754f;--shiki-dark:#4D9375> else</span><span style=color:#999;--shiki-dark:#666666> {</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>    printf</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#b5695999;--shiki-dark:#C98A7D99>"</span><span style=color:#a65e2b;--shiki-dark:#C99076>%d</span><span style=color:#a65e2b;--shiki-dark:#C99076> %s</span><span style=color:#b56959;--shiki-dark:#C98A7D>: unknown sys call </span><span style=color:#a65e2b;--shiki-dark:#C99076>%d\n</span><span style=color:#b5695999;--shiki-dark:#C98A7D99>"</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#b07d48;--shiki-dark:#BD976A>            p</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>pid</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#b07d48;--shiki-dark:#BD976A> p</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>name</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> num</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#b07d48;--shiki-dark:#BD976A>    p</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>trapframe</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>a0</span><span style=color:#999;--shiki-dark:#666666> =</span><span style=color:#ab5959;--shiki-dark:#CB7676> -</span><span style=color:#2f798a;--shiki-dark:#4C9A91>1</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>  }</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span></code></pre></div><p>这个函数应该就是用户态和系统调用的接口，首先获取当前进程的 <code>a7</code> 寄存器，如果这个寄存器中的系统调用号存在（也就是 <code>num > 0 &#x26;&#x26; num &#x3C; NELEM(syscalls) &#x26;&#x26; syscalls[num]</code>语句为真），那就调用它并返回（把 <code>a0</code> 寄存器设置为返回值），否则就返回 <code>-1</code> 。</p><p>递归学习：看不太懂下面这个函数指针数组到底是什么玩意：</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>static</span><span style=color:#59873a;--shiki-dark:#80A665> uint64</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#b07d48;--shiki-dark:#BD976A>syscalls</span><span style=color:#ab5959;--shiki-dark:#CB7676>[]</span><span style=color:#999;--shiki-dark:#666666>)(</span><span style=color:#ab5959;--shiki-dark:#CB7676>void</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#999;--shiki-dark:#666666> =</span><span style=color:#999;--shiki-dark:#666666> {</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_fork</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    sys_fork</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_exit</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    sys_exit</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_wait</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    sys_wait</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_pipe</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    sys_pipe</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_read</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    sys_read</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_kill</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    sys_kill</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_exec</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    sys_exec</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_fstat</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>   sys_fstat</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_chdir</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>   sys_chdir</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_dup</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>     sys_dup</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_getpid</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  sys_getpid</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_sbrk</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    sys_sbrk</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_sleep</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>   sys_sleep</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_uptime</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  sys_uptime</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_open</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    sys_open</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_write</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>   sys_write</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_mknod</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>   sys_mknod</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_unlink</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  sys_unlink</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_link</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    sys_link</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_mkdir</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>   sys_mkdir</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>[</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>SYS_close</span><span style=color:#999;--shiki-dark:#666666>]</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>   sys_close</span><span style=color:#999;--shiki-dark:#666666>,</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>};</span></span>
<span class=line></span></code></pre></div><p>其实就是看不懂 <code>uint64 (*syscalls[])(void)</code> 的意思，参考之前知乎上看到的一个回答，把这个东西翻译成英文： an array of pointers to a function that returns uint64，也就是一个函数指针的数组，这个初始化的方式也确实给我整麻了，但无所谓看懂了就行，不纠结语法。</p><p>其实还有一个终极问题：当调用系统调用的时候，真正的流程到底是什么？很遗憾这可能需要用 gdb 目力调试才能知道，但其实在不知道这个事情的流程下也能够完成这个实验，只需要观察一下 <code>sys_exit</code> 的代码：</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>uint64</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>sys_exit</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>void</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  int</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> n</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#59873a;--shiki-dark:#80A665>argint</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#2f798a;--shiki-dark:#4C9A91>0</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#ab5959;--shiki-dark:#CB7676> &#x26;</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>n</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#ab5959;--shiki-dark:#CB7676> &#x3C;</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    return</span><span style=color:#ab5959;--shiki-dark:#CB7676> -</span><span style=color:#2f798a;--shiki-dark:#4C9A91>1</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>  exit</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>n</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  return</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>;</span><span style=color:#a0ada0;--shiki-dark:#758575DD>  // not reached</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span></code></pre></div><p>它调用了 <code>argint(0, &#x26;n)</code> 来获取了进程退出时的状态号，再看到 <code>syscall.c</code> 中对于 <code>argint</code> 函数的注释：<code>// Fetch the nth 32-bit system call argument.</code> 就可以知道这个函数就是用来获取系统调用的参数的，那直接先拿来用就好了（拿来主义）。</p><p>最终增加的关键代码如下：（还有一些杂七杂八的东西要加，比如系统调用的打印）</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>uint64</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>sys_trace</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>void</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  uint</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> mask</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#59873a;--shiki-dark:#80A665>argint</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#2f798a;--shiki-dark:#4C9A91>0</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#ab5959;--shiki-dark:#CB7676>int</span><span style=color:#ab5959;--shiki-dark:#CB7676> *</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#ab5959;--shiki-dark:#CB7676>&#x26;</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>mask</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#ab5959;--shiki-dark:#CB7676> &#x3C;</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    return</span><span style=color:#ab5959;--shiki-dark:#CB7676> -</span><span style=color:#2f798a;--shiki-dark:#4C9A91>1</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>  myproc</span><span style=color:#999;--shiki-dark:#666666>()-></span><span style=color:#b07d48;--shiki-dark:#BD976A>trace_mask</span><span style=color:#999;--shiki-dark:#666666> =</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> mask</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  return</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span></code></pre></div><h3 id=risc-v-系统调用的一些规则摘录>RISC-V 系统调用的一些规则摘录</h3><ul><li>syscall number is passed in <code>a7</code></li><li>syscall arguments are passed in <code>a0</code> to <code>a5</code></li><li>unused arguments are set to <code>0</code></li><li>return value is returned in <code>a0</code></li></ul><h3 id=sysinfo-system-call>Sysinfo system call</h3><p>差不多和前面的 system call 一样，需要把一些信息拷贝到 user 空间，要用到 <code>copyout()</code> 函数。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD>// Copy from kernel to user.</span></span>
<span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD>// Copy len bytes from src to virtual address dstva in a given page table.</span></span>
<span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD>// Return 0 on success, -1 on error.</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>int</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>copyout</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#998418;--shiki-dark:#B8A965>pagetable_t</span><span style=color:#b07d48;--shiki-dark:#BD976A> pagetable</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> uint64 </span><span style=color:#b07d48;--shiki-dark:#BD976A>dstva</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#ab5959;--shiki-dark:#CB7676> char</span><span style=color:#ab5959;--shiki-dark:#CB7676> *</span><span style=color:#b07d48;--shiki-dark:#BD976A>src</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> uint64 </span><span style=color:#b07d48;--shiki-dark:#BD976A>len</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  uint64 n</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> va0</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> pa0</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  while</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>len </span><span style=color:#ab5959;--shiki-dark:#CB7676>></span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>){</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    va0 </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> PGROUNDDOWN</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>dstva</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    pa0 </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> walkaddr</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>pagetable</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> va0</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>pa0 </span><span style=color:#ab5959;--shiki-dark:#CB7676>==</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>      return</span><span style=color:#ab5959;--shiki-dark:#CB7676> -</span><span style=color:#2f798a;--shiki-dark:#4C9A91>1</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    n </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> PGSIZE </span><span style=color:#ab5959;--shiki-dark:#CB7676>-</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>dstva </span><span style=color:#ab5959;--shiki-dark:#CB7676>-</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> va0</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>n </span><span style=color:#ab5959;--shiki-dark:#CB7676>></span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> len</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>      n </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> len</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>    memmove</span><span style=color:#999;--shiki-dark:#666666>((</span><span style=color:#ab5959;--shiki-dark:#CB7676>void</span><span style=color:#ab5959;--shiki-dark:#CB7676> *</span><span style=color:#999;--shiki-dark:#666666>)(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>pa0 </span><span style=color:#ab5959;--shiki-dark:#CB7676>+</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>dstva </span><span style=color:#ab5959;--shiki-dark:#CB7676>-</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> va0</span><span style=color:#999;--shiki-dark:#666666>)),</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> src</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> n</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    len </span><span style=color:#ab5959;--shiki-dark:#CB7676>-=</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> n</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    src </span><span style=color:#ab5959;--shiki-dark:#CB7676>+=</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> n</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    dstva </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> va0 </span><span style=color:#ab5959;--shiki-dark:#CB7676>+</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> PGSIZE</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>  }</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  return</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span></code></pre></div><p>其实也很简单，直接拿到当前进程的 pagetable，然后虚拟地址其实就是第一个参数，其他的直接传进去用就好了。</p><p>至于活跃进程数量和空闲内存数：</p><ul><li>xv6 中的进程比较简单，是一个固定的数组（64个）。遍历一遍，剔除 <code>UNUSED</code> 的数量就好了；</li><li>先获取空闲的页数，然后乘以 4K 就可以得到空闲字节数。</li></ul><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>uint64</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>sys_sysinfo</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>void</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD>  // printf("hello\n");</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> sysinfo info</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  uint64 user_addr</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> proc </span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>p </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> myproc</span><span style=color:#999;--shiki-dark:#666666>();</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#59873a;--shiki-dark:#80A665>argaddr</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#2f798a;--shiki-dark:#4C9A91>0</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#ab5959;--shiki-dark:#CB7676> &#x26;</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>user_addr</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#ab5959;--shiki-dark:#CB7676> &#x3C;</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    return</span><span style=color:#ab5959;--shiki-dark:#CB7676> -</span><span style=color:#2f798a;--shiki-dark:#4C9A91>1</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#b07d48;--shiki-dark:#BD976A>  info</span><span style=color:#999;--shiki-dark:#666666>.</span><span style=color:#b07d48;--shiki-dark:#BD976A>freemem</span><span style=color:#999;--shiki-dark:#666666> =</span><span style=color:#59873a;--shiki-dark:#80A665> free_memory_number</span><span style=color:#999;--shiki-dark:#666666>();</span></span>
<span class=line><span style=color:#b07d48;--shiki-dark:#BD976A>  info</span><span style=color:#999;--shiki-dark:#666666>.</span><span style=color:#b07d48;--shiki-dark:#BD976A>nproc</span><span style=color:#999;--shiki-dark:#666666> =</span><span style=color:#59873a;--shiki-dark:#80A665> process_number</span><span style=color:#999;--shiki-dark:#666666>();</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#59873a;--shiki-dark:#80A665>copyout</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#b07d48;--shiki-dark:#BD976A>p</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>pagetable</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> user_addr</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#ab5959;--shiki-dark:#CB7676>char*</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#ab5959;--shiki-dark:#CB7676>&#x26;</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>info</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#ab5959;--shiki-dark:#CB7676> sizeof</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> sysinfo</span><span style=color:#999;--shiki-dark:#666666>))</span><span style=color:#ab5959;--shiki-dark:#CB7676>&#x3C;</span><span style=color:#2f798a;--shiki-dark:#4C9A91>0</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    return</span><span style=color:#ab5959;--shiki-dark:#CB7676> -</span><span style=color:#2f798a;--shiki-dark:#4C9A91>1</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  return</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span></code></pre></div><h2 id=page-table>Page table</h2><h3 id=每个进程的-kernel-page-table>每个进程的 kernel page table</h3><p>说实话，做到这一步的时候，我很莫名其妙为什么要去修改内核的这个机制，也就是「内核拥有一个自己的页表」机制。</p><p>读了一下 xv6 的 rec-book，这个 lab 的意思大致就是因为 xv6 的内核采用的是 direct-mapping 机制，所以可以让「内核拥有一个自己的页表」，但这样的话在运行内核代码的时候，就要用一个「转换机制」来访问用户的数据，接下来几个事情就是为了改变这个事情，至于改了之后到底有什么好处，我也不知道，做了再说。</p><p>大致的思路是这样：</p><ul><li>首先是需要给每个 process 维护一个 kernel_pagetable 域。</li><li>需要给每个 process 创建时（也就是在函数 <code>allocproc</code> 中）填充这个 process 的 kernel_pagetable ，目前来说每个进程的内核页表是和内核独有的页表是一模一样的。</li><li>除了上面和内核独有页表的内容一样以外，每个进程都要在自己的页表里再增加自己的内核 stack 映射。而这个映射原本在未修改的 xv6 中是由内核提前为所有的预备进程做好的（ <code>procinit</code> 函数），现在需要把这个事情延迟到在每个进程被创建的时候再做。</li><li>在调度函数中确保在切换到某个进程的之前，使用该进程的内核页表（也就是在 <code>swtch(&#x26;c->context, &#x26;p->context)</code> 之前），在重新回到调度程序后，再切换回内核自己的页表。</li><li>在进程被 free 的时候，顺便把 kernel_pagetable 也删了，但不用删除页表的叶结点，只需要删前两层的索引。</li></ul><p>在差不多做完这些事情后，还遇到了一些问题。</p><ol><li>改完之后 <code>make qemu</code> 直接报 <code>panic: kvmpa</code> 。</li></ol><p><code>kvmpa</code> 函数的用处是「将内核的一个虚拟地址转换为一个物理地址」，而 xv6 的内核地址大多都是 direct-mapping 的，换言之其实就是转换内核栈的地址而已，而在改完之后，进程的内核栈的地址已经不属于内核的页表了，而属于每个进程自己的内核页表，因此需要修改 <code>pte = walk(kernel_pagetable, va, 0)</code> 为 <code>pte = walk(myproc()->kernel_pagetable, va, 0)</code> 。（调用 <code>myproc()</code> 需要加两个头文件）</p><ol start=2><li>进程内核栈的内存泄漏问题</li></ol><p>要注意，每个进程被 free 的时候，即使不用释放进程内核页表绝大多数的叶子 page ，但是进程内核栈的 page 是必须要释放的，不然跑 usertests 的时候会在 sbrkfail 处报 kvmmap 的 panic ，我没有用 gdb 去调试出到底出了什么差错。但在我添加了对内核栈的手动释放后，就不报错了，所以很大可能的原因就是内存泄漏了，每当创建一个进程就浪费掉 1 个 page，free 的时候又不回收，最后就导致内存用尽没得用了。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>p</span><span style=color:#ab5959;--shiki-dark:#CB7676>-></span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>kstack</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>    uvmunmap</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>p</span><span style=color:#ab5959;--shiki-dark:#CB7676>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>kernel_pagetable</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> p</span><span style=color:#ab5959;--shiki-dark:#CB7676>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>kstack</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 1</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 1</span><span style=color:#999;--shiki-dark:#666666>);</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> </span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  p</span><span style=color:#ab5959;--shiki-dark:#CB7676>-></span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>kstack </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>p</span><span style=color:#ab5959;--shiki-dark:#CB7676>-></span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>kernel_pagetable</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>    proc_freekernelpagetable</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>p</span><span style=color:#ab5959;--shiki-dark:#CB7676>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>kernel_pagetable</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  p</span><span style=color:#ab5959;--shiki-dark:#CB7676>-></span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>kernel_pagetable </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line></span></code></pre></div><h2 id=trap>Trap</h2><p>一些关键的寄存器：</p><ul><li><code>stvec</code> 用于存储 trap handler 的地址，由内核写入</li><li><code>sepc</code> 来保存进入 trap 前的 <code>pc</code></li><li><code>scause</code> 保存 trap 的原因</li><li><code>sccratch</code> 在调用 trap handler 的时候会用到这个寄存器</li><li><code>sstatus</code> 中的 SIE 位表示是否阻塞设备中断，SPP 位表示 trap 来自于用户态还是内核态</li></ul><p>当 RISC-V CPU 要开始一个 trap 的时候依次做如下的事情：</p><ol><li>如果是一个设备终端且 <code>sstatus</code> 中的 SIE 位是空的，就不往下走了；</li><li>清楚 SIE 位（保证原子性）；</li><li>将当前的 <code>pc</code> 复制到 <code>sepc</code> ；</li><li>将当前的 mode 复制到 <code>sstatus</code> 的 SPP 位；</li><li>设置 <code>scause</code>；</li><li>将 mode 设置为 supervisor mode；</li><li>将 <code>stvec</code> 复制到 <code>pc</code> ；</li><li>go on 运行指令。</li></ol><h3 id=user-mode-下的-trap>User mode 下的 trap</h3><p>流程是</p><ol><li><code>trampoline.S</code> 中的 <code>uservec</code> 函数，这个函数被 <code>stvec</code> 所指</li><li>转到 <code>trap.c</code> 中的 <code>usertrap</code> 函数</li><li>trap 结束后转到 <code>trap.c</code> 中的 <code>usertrapret</code> 函数</li><li>然后转到 <code>trampoline.S</code> 中的 <code>userret</code> 函数</li></ol><p>首先，硬件并不会在发生 trap 时切换页表，因此用户的页表需要存在一个虚拟地址映射到 <code>uservec</code> ；同时 <code>uservec</code> 函数必须显示将 <code>satp</code> 切换到内核的页表（不然不能直接访问物理内存）。xv6 用了一个 <code>TRAMPOLINE</code> 的虚拟地址和 <code>trampoline</code> 页来映射 <code>trampoline.S</code> 的代码，并且不管是用户空间还是内核空间，虚拟地址都是一样的。也就是说，当 trap 发生时，首先从 <code>stvec</code> 中读到 <code>uservec</code> 的虚拟地址，也就是 <code>TRAMPOLINE</code> 然后经过页表映射到 <code>trampoline</code> 。</p><h4 id=trampolines-的部分代码><code>trampoline.S</code> 的部分代码：</h4><p>Xv6 还开辟了另外一个 page （就在 <code>trampoline</code> 下面）用来保存发生 trap 时被打断的指令的寄存器值，这个 page 叫做 <code>trapframe</code> 。一开始，寄存器 <code>sscratch</code> 保存着映射到 <code>trapframe</code> 页的<strong>虚拟地址</strong>，也就是 <code>TRAPFRAME</code> 。（想想这里为什么是虚拟地址而不是物理地址，因为运行到这的时候仍然没有切换页表，所以用户空间页表也需要保证好 <code>TRAPFRAME</code> 的映射）</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">plaintext</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=plaintext lang=plaintext style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span>				csrrw a0, sscratch, a0</span></span>
<span class=line><span></span></span></code></pre></div><p>这个时候，<code>a0</code> 的值和 <code>sscratch</code> 就被交换了。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">plaintext</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=plaintext lang=plaintext style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span>				sd ra, 40(a0)</span></span>
<span class=line><span>        sd sp, 48(a0)</span></span>
<span class=line><span>        sd gp, 56(a0)</span></span>
<span class=line><span>        sd tp, 64(a0)</span></span>
<span class=line><span>        sd t0, 72(a0)</span></span>
<span class=line><span>        sd t1, 80(a0)</span></span>
<span class=line><span>        sd t2, 88(a0)</span></span>
<span class=line><span>        sd s0, 96(a0)</span></span>
<span class=line><span>        sd s1, 104(a0)</span></span>
<span class=line><span>        sd a1, 120(a0)</span></span>
<span class=line><span>        sd a2, 128(a0)</span></span>
<span class=line><span>        sd a3, 136(a0)</span></span>
<span class=line><span>        sd a4, 144(a0)</span></span>
<span class=line><span>        sd a5, 152(a0)</span></span>
<span class=line><span>        sd a6, 160(a0)</span></span>
<span class=line><span>        sd a7, 168(a0)</span></span>
<span class=line><span>        sd s2, 176(a0)</span></span>
<span class=line><span>        sd s3, 184(a0)</span></span>
<span class=line><span>        sd s4, 192(a0)</span></span>
<span class=line><span>        sd s5, 200(a0)</span></span>
<span class=line><span>        sd s6, 208(a0)</span></span>
<span class=line><span>        sd s7, 216(a0)</span></span>
<span class=line><span>        sd s8, 224(a0)</span></span>
<span class=line><span>        sd s9, 232(a0)</span></span>
<span class=line><span>        sd s10, 240(a0)</span></span>
<span class=line><span>        sd s11, 248(a0)</span></span>
<span class=line><span>        sd t3, 256(a0)</span></span>
<span class=line><span>        sd t4, 264(a0)</span></span>
<span class=line><span>        sd t5, 272(a0)</span></span>
<span class=line><span>        sd t6, 280(a0)</span></span>
<span class=line><span></span></span></code></pre></div><p>这里把除了 <code>a0</code> 以外的寄存器都保存到了 <code>trapframe</code> 中。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">plaintext</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=plaintext lang=plaintext style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span>        csrr t0, sscratch</span></span>
<span class=line><span>        sd t0, 112(a0)</span></span>
<span class=line><span></span></span></code></pre></div><p>这里把 <code>a0</code> 也保存到了 <code>trapframe</code> 中。</p><p>而注意到，这里的指令是从 <code>40(a0)</code> 开始的，说明 <code>trapframe</code> 里面原本还存了 5 个值，其中包括了<strong>内核的页表</strong>、<strong>进程的内核栈</strong>、<strong><code>usertrap()</code></strong> 的地址和当前 CPU 的 <code>hartid</code> 。为什么还缺一个呢，我也不知道缺了什么，反正代码里看不出来。为了进入 <code>usertrap()</code> ，需要恢复这些值。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">plaintext</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=plaintext lang=plaintext style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span>        # restore kernel stack pointer from p->trapframe->kernel_sp</span></span>
<span class=line><span>        ld sp, 8(a0)</span></span>
<span class=line><span></span></span>
<span class=line><span>        # make tp hold the current hartid, from p->trapframe->kernel_hartid</span></span>
<span class=line><span>        ld tp, 32(a0)</span></span>
<span class=line><span></span></span>
<span class=line><span>        # load the address of usertrap(), p->trapframe->kernel_trap</span></span>
<span class=line><span>        ld t0, 16(a0)</span></span>
<span class=line><span></span></span>
<span class=line><span>        # restore kernel page table from p->trapframe->kernel_satp</span></span>
<span class=line><span>        ld t1, 0(a0)</span></span>
<span class=line><span>        csrw satp, t1</span></span>
<span class=line><span>        sfence.vma zero, zero</span></span>
<span class=line><span></span></span></code></pre></div><p>注意到，运行完最后的指令（也就是切换到内核页表）后，<code>a0</code> 中保存的 <code>TRAPFRAME</code> 虚拟地址已经失效了。</p><p>最后，跳转到 <code>usertrap()</code>。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">plaintext</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=plaintext lang=plaintext style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span>        jr t0</span></span>
<span class=line><span></span></span></code></pre></div><p>读到这里，我仍然有些许的疑问，因为 xv6 的文档上说其实用户空间涉及到了 32 个寄存器，但这里其实只保存了 31 个寄存器，我的疑惑是缺了哪一个？</p><h4 id=进入-usertrap-后>进入 <code>usertrap()</code> 后</h4><p>首先，验证是不是从 user mode 来的，然后修改了 <code>stvec</code> 的值（为什么？）。因为如果这个时候再次发生一些 trap ，就需要内核的 handler 来解决了，所以将这个入口改为了内核的 handler 的函数地址。然后根据 trap 的成因（<code>scause</code> 寄存器）来决定是系统调用、设备中断还是一个单纯的异常，做完这些事情后调用 <code>usertrapret()</code> 。</p><h4 id=usertrapret-干了什么><code>usertrapret()</code> 干了什么</h4><p>首先，关闭了中断（保证不被打断）。</p><p>然后重新设置了 <code>stvec</code> 的值，让它重新指向 <code>TRAPOLINE</code> 。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#59873a;--shiki-dark:#80A665>w_stvec</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>TRAMPOLINE </span><span style=color:#ab5959;--shiki-dark:#CB7676>+</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>uservec </span><span style=color:#ab5959;--shiki-dark:#CB7676>-</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> trampoline</span><span style=color:#999;--shiki-dark:#666666>));</span></span>
<span class=line></span></code></pre></div><p>再重新设置 <code>trapframe</code> 中的一些值，包括 <code>satp</code> （这是页表）、内核栈指针等。</p><blockquote><p>我这里其实没有明白为什么要重新设置，之前的行为会修改这些值吗？因为我只看到从 <code>trapframe</code> 中读取这些值。</p></blockquote><p>再设置好 <code>sepc</code> 后（从之前保存的 <code>trapframe</code> 中），就调用 <code>userret</code> 函数。这里也值得思考的是，<code>userret</code> 函数是在 <code>trampoline</code> 页里的，这个时候仍然是内核页表，因此对于 <code>TRAMPOLINE</code> 虚拟地址的映射是用户页表和内核页表都做了的，而 <code>TRAPFRAME</code> 的映射只有用户页表。</p><h4 id=userret><code>userret()</code></h4><p>在进入这个函数之前，<code>usertrapret()</code> 函数传了两个参数：当前进程的用户空间页表和虚拟地址 <code>TRAPFRAME</code> ，C 代码如下。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD>  // tell trampoline.S the user page table to switch to.</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  uint64 satp </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> MAKE_SATP</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>p</span><span style=color:#ab5959;--shiki-dark:#CB7676>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>pagetable</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line></span>
<span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD>  // jump to trampoline.S at the top of memory, which </span></span>
<span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD>  // switches to the user page table, restores user registers,</span></span>
<span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD>  // and switches to user mode with sret.</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  uint64 fn </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> TRAMPOLINE </span><span style=color:#ab5959;--shiki-dark:#CB7676>+</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>userret </span><span style=color:#ab5959;--shiki-dark:#CB7676>-</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> trampoline</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>  ((</span><span style=color:#ab5959;--shiki-dark:#CB7676>void</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#999;--shiki-dark:#666666>)(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>uint64</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>uint64</span><span style=color:#999;--shiki-dark:#666666>))</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>fn</span><span style=color:#999;--shiki-dark:#666666>)(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>TRAPFRAME</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> satp</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line></span></code></pre></div><p>进入之后，首先当然是切换页表（因为所有有用的东西都在用户页表才能翻译的地址里）。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">plaintext</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=plaintext lang=plaintext style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span>        # switch to the user page table.</span></span>
<span class=line><span>        csrw satp, a1</span></span>
<span class=line><span>        sfence.vma zero, zero</span></span>
<span class=line><span></span></span></code></pre></div><p>然后把所有的寄存器都还原，这里用到了 <code>sscratch</code> 这个寄存器，使得一系列操作完成之后 <code>sscratch</code> 的值又恢复到了 <code>TRAPFRAME</code> 后执行了 <code>sret</code> 指令，皆大欢喜地回到了用户的程序中。</p><h3 id=syscall-中如何传递参数>Syscall 中如何传递参数</h3><p>由于在进入系统调用之前，所有的寄存器都被存在了 <code>trapframe</code> 页中，因此 syscall 函数只需要从当前进程的 <code>trapframe</code> 中获取寄存器内容。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>static</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> uint64</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>argraw</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>int</span><span style=color:#b07d48;--shiki-dark:#BD976A> n</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> proc </span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>p </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> myproc</span><span style=color:#999;--shiki-dark:#666666>();</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  switch</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>n</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#999;--shiki-dark:#666666> {</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  case</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>:</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    return</span><span style=color:#b07d48;--shiki-dark:#BD976A> p</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>trapframe</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>a0</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  case</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 1</span><span style=color:#999;--shiki-dark:#666666>:</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    return</span><span style=color:#b07d48;--shiki-dark:#BD976A> p</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>trapframe</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>a1</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  case</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 2</span><span style=color:#999;--shiki-dark:#666666>:</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    return</span><span style=color:#b07d48;--shiki-dark:#BD976A> p</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>trapframe</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>a2</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  case</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 3</span><span style=color:#999;--shiki-dark:#666666>:</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    return</span><span style=color:#b07d48;--shiki-dark:#BD976A> p</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>trapframe</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>a3</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  case</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 4</span><span style=color:#999;--shiki-dark:#666666>:</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    return</span><span style=color:#b07d48;--shiki-dark:#BD976A> p</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>trapframe</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>a4</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  case</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 5</span><span style=color:#999;--shiki-dark:#666666>:</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    return</span><span style=color:#b07d48;--shiki-dark:#BD976A> p</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>trapframe</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>a5</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>  }</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>  panic</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#b5695999;--shiki-dark:#C98A7D99>"</span><span style=color:#b56959;--shiki-dark:#C98A7D>argraw</span><span style=color:#b5695999;--shiki-dark:#C98A7D99>"</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  return</span><span style=color:#ab5959;--shiki-dark:#CB7676> -</span><span style=color:#2f798a;--shiki-dark:#4C9A91>1</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span></code></pre></div><h3 id=kernel-mode-下的-trap>Kernel mode 下的 trap</h3><p>CPU 处于 kernel mode 的时候， <code>stvec</code> 寄存器的值指向的是 <code>kernelvec</code> 函数，这个函数的行为和 <code>uservec</code> 很相似，存下当前的所有寄存器（31个），然后调用 <code>kerneltrap</code> 。</p><p>注意这里的机制需要两个东西来帮助：</p><ol><li>内核的页表需要保证某个虚拟地址到 <code>kernelvec</code> 的映射；</li><li>需要内核 stack 帮忙保存寄存器。</li></ol><p>Kernel mode 下的 trap 只有两类：设备中断和异常，xv6 的异常处理比较简单，直接报错。</p><p>设备中断中有一个特殊的中断叫做<strong>时钟中断</strong>，这个时候会调用 <code>yield</code> 来挂起自己。（这个机制和调度函数 <code>scheduler</code> 有关系）</p><p>在某个时间点，<code>kerneltrap</code> 准备返回后，它会重新设置回之前保存在<strong>内核栈</strong>上的 <code>sepc</code> 、<code>sstatus</code> （这里是在 <code>kerneltrap</code> 函数里保存的），然后再回到 <code>kernelvec</code> ，恢复之前的那 31 个寄存器，然后运行 <code>sret</code> 指令，恢复原本的执行流。</p><h3 id=trap-lab>Trap lab</h3><p>Trap 的东西快读完了，还剩一个 COW 没读，先做做看 lab 吧。</p><p>首先是要加一个 <code>backtrace</code> 来追踪 function calls ，这其实很简单，因为大致就能知道要怎么办了，先用一个实例代码来看看 RISC-V 的函数调用。首先看一段简单的 C 代码。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>int</span><span style=color:#59873a;--shiki-dark:#80A665> g</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>int</span><span style=color:#b07d48;--shiki-dark:#BD976A> x</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#999;--shiki-dark:#666666> {</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  return</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> x</span><span style=color:#ab5959;--shiki-dark:#CB7676>+</span><span style=color:#2f798a;--shiki-dark:#4C9A91>3</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span></code></pre></div><p>翻译成汇编是这样：</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">plaintext</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=plaintext lang=plaintext style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span>   0:	1141                	addi	sp,sp,-16</span></span>
<span class=line><span>   2:	e422                	sd	s0,8(sp)</span></span>
<span class=line><span>   4:	0800                	addi	s0,sp,16</span></span>
<span class=line><span>   6:	250d                	addiw	a0,a0,3</span></span>
<span class=line><span>   8:	6422                	ld	s0,8(sp)</span></span>
<span class=line><span>   a:	0141                	addi	sp,sp,16</span></span>
<span class=line><span>   c:	8082                	ret</span></span>
<span class=line><span></span></span></code></pre></div><p>首先，进入函数后将栈指针（<code>sp</code>）减 16（我也不知道为什么是 16，我猜是为了对齐），然后把旧的 <code>s0</code> 存到了前 8 个字节中，再把旧的 <code>sp</code> （减 16 之前的）存到了 <code>s0</code> 当中；</p><p>在函数返回的时候，先把刚刚进入这个 stack frame 时保存在栈上的旧值返回到 <code>s0</code> 中，再重置 <code>sp</code> ，运行 <code>ret</code> 指令。</p><p>可以想象一下函数 A 调用函数 B 再调用函数 C 的过程：</p><p>这里假设函数 A 是这个进程最初最初的函数，也就是说它的栈是从新分配的栈页的最高地址开始的。</p><ol><li>一开始在函数 A 中，<code>s0</code> 保存的是 A 的 stack frame 的首指针（高地址）；</li><li>进入函数 B 后，A 的 frame pointer 被保存到了 B 的 stack 的前八个字节中，此时 <code>s0</code> 保存的是 B 的 frame pointer；</li><li>进入 C 后，B 的 pointer 被保存在了 C 的 stack 上，<code>s0</code> 保存 C 的 pointer。</li></ol><p>如果想要回溯，那只需要在函数 C 中取出 <code>s0</code> 的值，然后用这个值取到 B 的 frame pointer，然后层层循环，直到取到 0 为止。注意循环的终止条件：<strong>pointer 如果等于这个 pointer 所在的 page 的最高地址，那就停止，因为这意味着这是最最最初始的一个函数调用。</strong></p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>void</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> </span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>backtrace</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>void</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  uint64 s0 </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> r_fp</span><span style=color:#999;--shiki-dark:#666666>();</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  uint64 last_s0 </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#ab5959;--shiki-dark:#CB7676> *</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>uint64</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#999;--shiki-dark:#666666>)(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>s0 </span><span style=color:#ab5959;--shiki-dark:#CB7676>-</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 16</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  uint64 ra </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#ab5959;--shiki-dark:#CB7676> *</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>uint64</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#999;--shiki-dark:#666666>)(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>s0 </span><span style=color:#ab5959;--shiki-dark:#CB7676>-</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 8</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>  printf</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#b5695999;--shiki-dark:#C98A7D99>"</span><span style=color:#b56959;--shiki-dark:#C98A7D>backtrace:</span><span style=color:#a65e2b;--shiki-dark:#C99076>\n</span><span style=color:#b5695999;--shiki-dark:#C98A7D99>"</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  while</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>s0 </span><span style=color:#ab5959;--shiki-dark:#CB7676>!=</span><span style=color:#59873a;--shiki-dark:#80A665> PGROUNDUP</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>s0</span><span style=color:#999;--shiki-dark:#666666>))</span><span style=color:#999;--shiki-dark:#666666> {</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>    printf</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#b5695999;--shiki-dark:#C98A7D99>"</span><span style=color:#a65e2b;--shiki-dark:#C99076>%p\n</span><span style=color:#b5695999;--shiki-dark:#C98A7D99>"</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> ra</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    s0 </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> last_s0</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    last_s0 </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#ab5959;--shiki-dark:#CB7676> *</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>uint64</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#999;--shiki-dark:#666666>)(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>s0 </span><span style=color:#ab5959;--shiki-dark:#CB7676>-</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 16</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    ra </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#ab5959;--shiki-dark:#CB7676> *</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>uint64</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#999;--shiki-dark:#666666>)(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>s0 </span><span style=color:#ab5959;--shiki-dark:#CB7676>-</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 8</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>  }</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span></code></pre></div><p>然后要加一个简易的 signal 机制，其实很简单。</p><ul><li>首先要知道 <code>sigalarm</code> 和 <code>sigreturn</code> 都是属于 syscall ，也就是说这些函数的调用和返回中间都会和当前进程的 <code>trapframe</code> 域打交道。</li><li>对于 <code>sigalarm</code> 只要在 <code>proc</code> 结构体中保存相应的 <code>alarm_ticks</code> 和 <code>handler</code> 的地址就好了。同时在保存一个 <code>ticks</code> 让它每产生一次时钟中断就自增，如果在时钟中断发生时既设置了 <code>alarm_ticks</code> 、 <code>ticks</code> 又超过了 <code>alarm_ticks</code> 就修改返回的指令地址，让它跳转到 <code>handler</code>。</li><li>接下来的问题就是如何让 <code>handler</code> 结束后再返回到原本被打断的指令。根据 MIT 的提示，只需要在修改 <code>pc</code> 为 <code>handler</code> 之前，把整个 <code>trapframe</code> 保存下来就好了（在 <code>proc</code> 结构体中再开一个域用来保存）。因为 <code>sigreturn</code> 也是一个 syscall ，在它返回之前再把之前的整个 <code>saved_trapframe</code> 覆盖当前的 <code>trapframe</code> ，然后再返回交给操作系统，就能顺利回到原本的指令。</li><li>最后需要注意的是，需要一个 <code>flag</code> 来表明此时该进程已经进入 <code>signal_handler</code> ，来避免 signal 的重入问题。</li></ul><h2 id=lazy-page-allocation>Lazy page allocation</h2><p>起因很简单，假如说用户要求内核分配很多很多的页，内核需要花很多时间来分配，所以产生了 lazy allocation 的概念。值得注意的是，这里的 allocation 是针对用户的 heap ，没有涉及到 stack 。但其实这里我有一个疑惑，为什么对栈不实现一个 lazy allocation 呢？虽然这其实显得很反常，因为栈的增长其实是不可控的。</p><h3 id=追溯-panic>追溯 panic</h3><p>首先很简单，由于用户申请堆实际上只能通过 system call <code>sbrk()</code> ，那实现懒加载的第一步就是<strong>不加载</strong>，修改这个系统调用对应的函数 <code>sys_sbrk(void)</code> 。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>uint64</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>sys_sbrk</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>void</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  int</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> addr</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  int</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> n</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#59873a;--shiki-dark:#80A665>argint</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#2f798a;--shiki-dark:#4C9A91>0</span><span style=color:#ab5959;--shiki-dark:#CB7676> &#x26;</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>n</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#ab5959;--shiki-dark:#CB7676>&#x3C;</span><span style=color:#2f798a;--shiki-dark:#4C9A91>0</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    return</span><span style=color:#ab5959;--shiki-dark:#CB7676> -</span><span style=color:#2f798a;--shiki-dark:#4C9A91>1</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  addr </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> myproc</span><span style=color:#999;--shiki-dark:#666666>()-></span><span style=color:#b07d48;--shiki-dark:#BD976A>sz</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  </span></span>
<span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD>  /**</span></span>
<span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD>   * 删除对于 growproc() 的调用</span></span>
<span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD>   */</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>  myproc</span><span style=color:#999;--shiki-dark:#666666>()-></span><span style=color:#b07d48;--shiki-dark:#BD976A>sz</span><span style=color:#ab5959;--shiki-dark:#CB7676> +=</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> n</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  return</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> addr</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span></code></pre></div><p>这样改了之后当然会 panic ，因为其实压根就没有没有分配空间，所以对于这些用户以为已经分配了空间的虚拟地址的访问会触发一个用户态下的 page fault 。但我此时在想的是，在调用了 <code>echo</code> 程序后，到底在哪一步调用了 <code>sys_sbrk()</code> 呢？这个事情其实很难去追溯，因为操作系统在背后做了太多的事情。我用 gdb 看了一下。</p><p>最后发现了几件事情：</p><ol><li>在用户输入命令 <code>echo hi</code> 后、 Shell 调用 exec 之前，就已经进入了 trap 并导致 panic 。</li><li><code>sys_sbrk</code> 的调用是在输入命令之后，但是也在 Shell 调用 exec 之前。</li><li>其实自始自终只调用了一次 <code>sys_sbrk</code> 。</li><li>上面的那次 <code>sys_sbrk</code> 的调用是触发了 trap 的关键 。</li></ol><p>我用 gdb 追踪到的事情：</p><ol><li><p>首先 xv6 非常正常的启动，直到进入到终端，也就是 <code>sh</code> 程序被加载进来。</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD>/**</span></span>
<span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD> * sh 程序的部分代码</span></span>
<span class=line><span style=color:#a0ada0;--shiki-dark:#758575DD> */</span></span>
<span class=line></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>int</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>main</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>void</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  ...</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  </span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#59873a;--shiki-dark:#80A665>fork1</span><span style=color:#999;--shiki-dark:#666666>()</span><span style=color:#ab5959;--shiki-dark:#CB7676> ==</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>    runcmd</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#59873a;--shiki-dark:#80A665>parsecmd</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>buf</span><span style=color:#999;--shiki-dark:#666666>));</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>  wait</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#2f798a;--shiki-dark:#4C9A91>0</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  </span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  ...</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> cmd</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>parsecmd</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>char</span><span style=color:#ab5959;--shiki-dark:#CB7676> *</span><span style=color:#b07d48;--shiki-dark:#BD976A>s</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  ...</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  </span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  cmd </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> parseline</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>&#x26;</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>s</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> es</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  </span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  ...</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> cmd</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>parseline</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>char</span><span style=color:#ab5959;--shiki-dark:#CB7676> **</span><span style=color:#b07d48;--shiki-dark:#BD976A>ps</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#ab5959;--shiki-dark:#CB7676> char</span><span style=color:#ab5959;--shiki-dark:#CB7676> *</span><span style=color:#b07d48;--shiki-dark:#BD976A>es</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> cmd </span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>cmd</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  cmd </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> parsepipe</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>ps</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> es</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  </span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  ...</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> cmd</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>parsepipe</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>char</span><span style=color:#ab5959;--shiki-dark:#CB7676> **</span><span style=color:#b07d48;--shiki-dark:#BD976A>ps</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#ab5959;--shiki-dark:#CB7676> char</span><span style=color:#ab5959;--shiki-dark:#CB7676> *</span><span style=color:#b07d48;--shiki-dark:#BD976A>es</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> cmd </span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>cmd</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  cmd </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> parseexec</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>ps</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> es</span><span style=color:#999;--shiki-dark:#666666>);</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  </span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  ...</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> cmd</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>parseexec</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>char</span><span style=color:#ab5959;--shiki-dark:#CB7676> **</span><span style=color:#b07d48;--shiki-dark:#BD976A>ps</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#ab5959;--shiki-dark:#CB7676> char</span><span style=color:#ab5959;--shiki-dark:#CB7676> *</span><span style=color:#b07d48;--shiki-dark:#BD976A>es</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  ...</span></span>
<span class=line></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  ret </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> execcmd</span><span style=color:#999;--shiki-dark:#666666>();</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  </span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  ...</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> cmd</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>execcmd</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>void</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> execcmd </span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>cmd</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  cmd </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> malloc</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>sizeof</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>cmd</span><span style=color:#999;--shiki-dark:#666666>));</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>  memset</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>cmd</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>,</span><span style=color:#ab5959;--shiki-dark:#CB7676> sizeof</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>cmd</span><span style=color:#999;--shiki-dark:#666666>));</span></span>
<span class=line><span style=color:#b07d48;--shiki-dark:#BD976A>  cmd</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>type</span><span style=color:#999;--shiki-dark:#666666> =</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> EXEC</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  return</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#ab5959;--shiki-dark:#CB7676>struct</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> cmd</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>cmd</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span></code></pre></div><p>经过了一个下午的目力 gdb，我终于发现了这个非常非常恶心的调用栈：在用户输入了任何命令后，终端程序（也就是 <code>sh</code> ）的执行流是这样走的： <code>main -> parsecmd -> parseline -> parsepipe -> parseexec -> execcmd</code> ，最后到达了 <code>execcmd</code> 函数中的 <code>malloc</code> 调用，这里的 <code>malloc</code> 函数定义在另一个文件 <code>user/umalloc.c</code> 中。很操蛋的是，gdb 似乎没有办法识别 <code>umalloc.c</code> 的符号，因此执行流进入到这个函数后，我只能对着看不懂的 RISCV 汇编纯猜了，不过也大致猜到了：<code>malloc</code> 函数调用了同一个文件中定义的 <code>morecore</code> 函数，该函数如下：</p><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">c</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=c lang=c style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>static</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> Header</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>morecore</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#ab5959;--shiki-dark:#CB7676>uint</span><span style=color:#b07d48;--shiki-dark:#BD976A> nu</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>{</span></span>
<span class=line><span style=color:#ab5959;--shiki-dark:#CB7676>  char</span><span style=color:#ab5959;--shiki-dark:#CB7676> *</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>p</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  Header </span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>hp</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>nu </span><span style=color:#ab5959;--shiki-dark:#CB7676>&#x3C;</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 4096</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>    nu </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 4096</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  p </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#59873a;--shiki-dark:#80A665> sbrk</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>nu </span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#ab5959;--shiki-dark:#CB7676> sizeof</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>Header</span><span style=color:#999;--shiki-dark:#666666>));</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  if</span><span style=color:#999;--shiki-dark:#666666>(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>p </span><span style=color:#ab5959;--shiki-dark:#CB7676>==</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#ab5959;--shiki-dark:#CB7676>char*</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#ab5959;--shiki-dark:#CB7676>-</span><span style=color:#2f798a;--shiki-dark:#4C9A91>1</span><span style=color:#999;--shiki-dark:#666666>)</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>    return</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 0</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#393a34;--shiki-dark:#DBD7CAEE>  hp </span><span style=color:#999;--shiki-dark:#666666>=</span><span style=color:#999;--shiki-dark:#666666> (</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>Header</span><span style=color:#ab5959;--shiki-dark:#CB7676>*</span><span style=color:#999;--shiki-dark:#666666>)</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>p</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#b07d48;--shiki-dark:#BD976A>  hp</span><span style=color:#999;--shiki-dark:#666666>-></span><span style=color:#b07d48;--shiki-dark:#BD976A>s</span><span style=color:#999;--shiki-dark:#666666>.</span><span style=color:#b07d48;--shiki-dark:#BD976A>size</span><span style=color:#999;--shiki-dark:#666666> =</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> nu</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#59873a;--shiki-dark:#80A665>  free</span><span style=color:#999;--shiki-dark:#666666>((</span><span style=color:#ab5959;--shiki-dark:#CB7676>void*</span><span style=color:#999;--shiki-dark:#666666>)(</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE>hp </span><span style=color:#ab5959;--shiki-dark:#CB7676>+</span><span style=color:#2f798a;--shiki-dark:#4C9A91> 1</span><span style=color:#999;--shiki-dark:#666666>));</span></span>
<span class=line><span style=color:#1e754f;--shiki-dark:#4D9375>  return</span><span style=color:#393a34;--shiki-dark:#DBD7CAEE> freep</span><span style=color:#999;--shiki-dark:#666666>;</span></span>
<span class=line><span style=color:#999;--shiki-dark:#666666>}</span></span>
<span class=line></span></code></pre></div><p>这里才得知，是 <code>morecore</code> 函数真正正正的调用了系统调用 <code>sbrk</code> （在汇编曾经调用了 <code>ecall</code>）。从调试的过程中发现，实际上 <code>sbrk</code> 调用是成功的，<code>ecall</code> 和 <code>eret</code> 都没有出差错，真正出问题的地方在 <code>hp->s.size = nu;</code> 这句 C 程序上。从汇编的层面上看，机器在运行指令 <code>sw s6, 8(a0)</code> 后直接报了 panic 。也就是说，在操作系统仅仅修改了进程的一个字段而没有真正的分配一个页给它后，当该进程试图去写（这里 <code>sw</code> 指令就是写内存）时，触发了用户态的 trap 。</p></li></ol><h3 id=解决-panic>解决 panic</h3><hr><p>2021 年 8 月 10 日，此时我已经做完了 lazy lab 和 cow lab。由于对并发的 lab 并不感兴趣，持久化的内容准备下学期在 CSE 上再学，因此 6.S081 的学习到这里暂时结束，有空再补上 lazy 和 cow 的思考，开了个新坑：6.824 。</p></article><hr class="mx-auto bg-zinc-200 border-0 dark:bg-zinc-700 h-1 md:my-10 my-4 rounded w-48"><div class="[&_main]:transition-colors giscus"></div></main></div><footer class="text-center lg:mt-[4dvh] mt-[3dvh]" data-astro-transition-persist=astro-tvayyljk-4><p class="lg:mb-[2dvh] mb-[1dvh]">In Search of Identity</p><p class="opacity-75 text-neutral-700 dark:text-neutral-300">&copy; 2024 Ladit. Powered by <a href=https://astro.build class=underline aria-label="Read more about Astro" rel=noopener target=_blank>Astro</a>. <a href=https://github.com/ladit/astro-blog-zozo class=underline aria-label="Read more about this theme" rel=noopener target=_blank>Theme</a> by Ladit.</p></footer><button aria-label="Back to top" class="hidden fixed 	bottom-6 	right-6 size-10 	cursor-pointer 	place-content-center 	rounded-full 	bg-[#f0f0f0] 	opacity-60 	hover:opacity-100 	dark:bg-[#555555]" title="Back to top" data-astro-transition-persist=astro-w6n6ksoh-5 id=back-to-top><svg class="fill-current self-center size-8" viewBox="0 0 24 24" data-icon=ri:arrow-up-double-fill height=1em width=1em><symbol id=ai:ri:arrow-up-double-fill><path d="m12 4.836l-6.207 6.207l1.414 1.414L12 7.664l4.793 4.793l1.414-1.414zm0 5.65l-6.207 6.207l1.414 1.414L12 13.314l4.793 4.793l1.414-1.414z" fill=currentColor /></symbol><use xlink:href=#ai:ri:arrow-up-double-fill></use></svg></button></body></html><script type=module>const copy=async t=>{const e=t.nextElementSibling?.children[0];e&&(await navigator.clipboard.writeText(e.textContent),t.setAttribute("aria-pressed","true"),setTimeout((()=>{t.setAttribute("aria-pressed","false")}),700))},copyButtons=Array.from(document.querySelectorAll(".prose button.copy"));for(const t of copyButtons)t.addEventListener("click",(()=>copy(t)))</script>