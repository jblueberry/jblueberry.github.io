<!doctype html><html lang=en-us><head><title>Raft | Junhui Zhu</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="2023.02.05 update: å®é™…ä¸Šè¿™ä¸ª lab æˆ‘åšçš„å¤æ‚äº†ï¼Œä¸ä¸€å®šéœ€è¦ç”¨æ¡ä»¶å˜é‡ã€‚"><meta name=generator content="Hugo 0.110.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>â†</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a>
<a href=/about>About</a>
<a href=https://www.zhihu.com/people/zhu-jun-hui-40-47>Zhihu</a>
<a class=button href=https://jhzhu.xyz/index.xml>Subscribe</a></nav><main class=main><section id=single><h1 class=title>Raft</h1><div class=tip><time datetime="2022-06-10 00:00:00 +0000 UTC">Jun 10, 2022</time>
<span class=split>Â·</span>
<span>3316 words</span>
<span class=split>Â·</span>
<span>7 minute read</span></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#raft>Raft</a><ul><li><a href=#leader-election>Leader election</a></li><li><a href=#log-replication>Log replication</a></li><li><a href=#safety>Safety</a></li></ul></li><li><a href=#6824-lab2>6.824 lab2</a></li></ul></nav></div></details></aside><div class=content><p>2023.02.05 update: å®é™…ä¸Šè¿™ä¸ª lab æˆ‘åšçš„å¤æ‚äº†ï¼Œä¸ä¸€å®šéœ€è¦ç”¨æ¡ä»¶å˜é‡ã€‚</p><h2 id=raft>Raft <a href=#raft class=anchor>ğŸ”—</a></h2><p>Raft æ˜¯ç®€åŒ–ç‰ˆçš„ã€å·¥ç¨‹åŒ–çš„ Paxosï¼Œåˆ†æˆäº† Leader electionã€Log replication å’Œ Safety ä¸‰ä¸ªç›¸å¯¹ç‹¬ç«‹çš„æ¨¡å—ã€‚</p><p><a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf target=_blank rel=noopener>Extended Raft paper</a> è¯¦ç»†é˜æ˜äº† Raft çš„é€»è¾‘ï¼Œ6.824 çš„ 2Aã€2B å’Œ 2C éƒ½å¯ä»¥ç”¨ paper é‡Œçš„ Figure 2 æ¥æ¦‚æ‹¬ã€‚</p><p><p class=markdown-image><img src=/images/raft.png alt=Raft></p></p><h3 id=leader-election>Leader election <a href=#leader-election class=anchor>ğŸ”—</a></h3><ol><li>æ¯ä¸€ä¸ª server éƒ½æœ‰å†…éƒ¨çš„ term ï¼ˆä» 1 å¼€å§‹ï¼‰å’ŒæŠ•ç¥¨çŠ¶æ€ <code>votedFor</code>ã€‚term åœ¨ Raft ä¸­æ˜¯ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„çŠ¶æ€å˜é‡ï¼Œå¯¹äºæŸä¸€ä¸ª server æ¥è¯´ï¼Œåªæœ‰åœ¨<strong>åœ¨ä¸€å®šæ—¶é—´æ²¡æœ‰æ”¶åˆ° leader çš„ heartbeat</strong> åï¼ˆåŒ…æ‹¬å‡ºç° split votes çš„æƒ…å†µä¸‹ï¼‰ï¼Œæ‰ä¼šå¼•å‘ term çš„è‡ªå¢ï¼Œè€Œ term çš„è‡ªå¢æ€»ä¼šä¼´éšç€ä¸€é˜µæ–°çš„ electionã€‚</li><li>æ¯ä¸€ä¸ª candidate å‘ peer å‘é€ <code>RequestVote</code> åï¼Œå¦‚æœå¾—åˆ°äº†è¶…è¿‡åŠæ•°çš„ votesï¼Œä¾¿ä¼šè½¬åŒ–ä¸º leaderã€‚è‡ªæ­¤ï¼Œè¯¥ server ä¼šå°è¯•ç€ç»´æŒç°åœ¨çš„ termï¼Œå¹¶ä½œä¸º leader å‘¨æœŸæ€§ heartbeat followersã€‚</li><li>å½“ follower æ”¶åˆ°æŸä¸ª leader çš„ heartbeat åï¼Œå¦‚æœï¼ˆåœ¨è¿™ä¸ª RPC ä¸­ï¼‰è¯¥ leader çš„ term æ¯”è‡ªå·±çš„ term å°ï¼ˆè¿™æ„å‘³ç€è¯¥ leader ä¸åº”è¯¥å†æ˜¯ leaderï¼Œå› ä¸ºä¸€å®šå­˜åœ¨ä¸€ä¸ª server å·²ç»è‡ªå¢ term å¹¶å°è¯•æˆä¸ºæ–°çš„ leaderï¼‰ï¼Œæ­¤æ—¶éœ€è¦å°†è¯¥ä¿¡æ¯ response ç»™è¯¥ leaderï¼Œè®©å…¶é€€åŒ–ä¸º followerã€‚<strong>è¿™é‡Œçš„è¯¥ leader çš„çœŸå®çŠ¶æ€ä¸ä¸€å®šçœŸçš„æ˜¯ leaderï¼Œå› ä¸ºå¯èƒ½å­˜åœ¨ç½‘ç»œå»¶è¿Ÿçš„é—®é¢˜ï¼Œè¿™ä¸ª heartbeat RPC è¢«æ¨è¿Ÿé€è¾¾ã€‚</strong></li><li>å½“æŸä¸ª leader çš„ heartbeat ä¿¡æ¯ä¸­çš„ term å¤§äºç­‰äº follower çš„ term æ—¶ï¼Œfollower <strong>æ— æ¡ä»¶</strong>è®¤å¯è¯¥ leader çš„ä¿¡æ¯ã€‚å¯èƒ½ä¼šè§‰å¾— follower çš„è¡Œä¸ºè¿‡äºè¢«åŠ¨ï¼Œä½†æ˜¯ follower ç”¨ <strong>term</strong> å¯¹ leader çš„ check æœ¬èº«å°±ä¿è¯äº†å®‰å…¨æ€§ã€‚<strong>å¯¹äºæ¯ä¸€ä¸ª follower æœ¬èº«æ¥è¯´ï¼Œåªè¦ leader çš„ term è‡³å°‘æ¯”æˆ‘çš„ term å¤§ï¼Œé‚£å®ƒçš„çŠ¶æ€ä¾¿æ˜¯è¶…å‰äºæˆ‘çš„ï¼Œæˆ‘ä¾¿å¯ä»¥æ¥å—å®ƒçš„æŒ‡ä»¤ï¼Œå³ä½¿å®ƒç°åœ¨å¯èƒ½æ—©å°±ä¸æ˜¯ leader äº†ã€‚</strong></li><li>Raft é‡‡ç”¨ random election timeouts æ¥é¿å… split votesã€‚</li></ol><h3 id=log-replication>Log replication <a href=#log-replication class=anchor>ğŸ”—</a></h3><ol><li>æ¯ä¸€ä¸ª leader éœ€è¦ç»´æŠ¤ peers çš„ matchIndex å’Œ nextIndex çŠ¶æ€ã€‚<ol><li>æ¯ä¸€ä¸ª heartbeat RPC é‡Œæºå¸¦äº†éœ€è¦ç»™è¯¥ follower åŒæ­¥çš„ log entriesï¼Œåœ¨ <a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf target=_blank rel=noopener>Extended Raft paper</a> é‡Œæ¯ä¸ª RPC åªæœ‰ä¸€ä¸ªæˆ–è€…é›¶ä¸ªï¼ˆpure heartbeatï¼‰ï¼Œä½†æ˜¯åœ¨ 6.824 lab2C é‡Œä¼šä¼˜åŒ–è¿™ä¸ªæœºåˆ¶ï¼Œè®©æ¯ä¸ª RPC æºå¸¦å¤šä¸ª entriesï¼Œæé«˜æ•ˆç‡ã€‚<strong>è€Œå¯¹äºæ¯ä¸ª follower æ¥è¯´ï¼Œå…¶ heartbeat RPC é‡Œè¦æ”¾å“ªäº› entriesï¼Œå–å†³äºè¯¥ leader ä¸ºå…¶ç»´æŠ¤çš„ nextIndexã€‚</strong></li><li>å½“æŸä¸ª heartbeat æºå¸¦äº† entries å¹¶å¾—åˆ°äº†å¯¹æ–¹ follower çš„è‚¯å®šå›å¤æ—¶ï¼Œè¯¥ leader ä¾¿å¯ä»¥æ–­å®šè¯¥ follower å·²ç»åŒæ­¥äº† heartbeat ä¸­æ¶µç›–çš„ log ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ï¼Œå®Œæˆäº† replicationï¼Œæ­¤æ—¶å¯ä»¥ä¿®æ”¹è¯¥ follower çš„ matchIndex å’Œ nextIndexã€‚</li><li>æ¯ä¸€ä¸ª heartbeat RPC éƒ½åŒ…å«ç€å‘é€è¯¥ RPC çš„ leader è®¤ä¸ºè¯¥ follower å½“å‰æ‰€éœ€è¦åŒæ­¥çš„ entry indexã€‚æ˜¾ç„¶è¿™å¹¶ä¸æ˜¯ä»»ä½•æ—¶å€™éƒ½æˆç«‹çš„ï¼Œå› æ­¤ï¼Œå¯¹äºæŸä¸ª followerï¼Œå‡å¦‚è¯¥ heartbeat æ˜¯åˆæ³•çš„ï¼ˆterm checkedï¼‰ï¼Œä½†æ˜¯ leader æé”™äº† follower å®é™…éœ€è¦çš„ entry indexï¼Œfollower ä¾¿ä¼šè¿”å› <code>false</code>ï¼Œè®© leader å»ä¿®æ­£å…¶ä¸ºè¯¥ follower ç»´æŠ¤çš„ nextIndexï¼Œ<strong>ç›´åˆ°è¢« follower è‚¯å®šå›å¤</strong>ã€‚</li><li>åœ¨æŸä¸ª server åˆšåˆšè½¬åŒ–ä¸º leader æ—¶ï¼Œåˆå§‹åŒ–æ¯ä¸ª follower çš„ matchIndex ä¸º <code>0</code>ï¼Œå¹¶åˆå§‹åŒ–æ¯ä¸ª follower çš„ nextIndex ä¸º <code>nextLogIndex</code>ã€‚æ¯ä¸€ä¸ª server çš„ <code>nextLogIndex</code> æ˜¯è¯¥ server ä¸‹ä¸€ä¸ª potential log entry çš„ indexã€‚</li></ol></li><li>æ¯ä¸€ä¸ª server éƒ½éœ€è¦ç»´æŠ¤ commitIndex å’Œ lastAppliedã€‚commitIndex è¡¨ç¤ºï¼šåˆ° commitIndex ä¹‹å‰ï¼Œæ‰€æœ‰çš„ log entry éƒ½è¢«è¯¥ç³»ç»Ÿä¸­çš„ majority æ‰€è®¤å¯ï¼Œå¯ä»¥ç›´æ¥æ”¾å¿ƒä½œç”¨äºçŠ¶æ€æœºï¼›lastApplied è¡¨ç¤ºå½“å‰çœŸæ­£å·²ç»è¢«ä½œç”¨äºçŠ¶æ€æœºï¼ˆè¿™ä¸ªåŠ¨ä½œç§°ä¸º applyï¼‰çš„æœ€åä¸€ä¸ª entry çš„ indexã€‚<ol><li>å¯¹äº leader æ¥è¯´ï¼Œç”±äºå¤–éƒ¨ï¼ˆä¸Šå±‚åº”ç”¨çš„ï¼‰entry åªèƒ½è¢« leader æ‰€æ¥å—ï¼Œè€Œä¹Ÿåªæœ‰ leader ä¼šå°è¯•å°† entry åŒæ­¥ç»™ followersï¼Œå› æ­¤ leader ä¼šåœ¨æŸäº› entry è¢«å¤§éƒ¨åˆ†æœºå™¨æ‰€æ‰¿è®¤æ—¶ï¼Œ<strong>ä¸»åŠ¨</strong>ä¿®æ”¹ commitIndexï¼ˆåœ¨è¿™é‡Œï¼Œè¿™äº› entry è¢«æˆä¸º<strong>è¢« commit</strong> äº†ã€‚ï¼‰ï¼Œå¹¶å°†å…¶ä½œä¸º heartbeat RPC çš„ä¸€éƒ¨åˆ†ä¿¡æ¯åŒæ­¥ç»™ followersï¼›</li><li>å¯¹äº follower æ¥è¯´ï¼Œæ‰€æœ‰å¯¹ commitIndex çš„ä¿®æ”¹éƒ½æºè‡ªäº leader çš„ heartbeatã€‚åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“ leader çš„ commitIndex å¤§äºè‡ªèº«çš„æ—¶ï¼Œä¾¿åŒæ­¥æˆ leader çš„ã€‚</li><li>æ¯ä¸€ä¸ª server éƒ½éœ€è¦æ£€æŸ¥è‡ªèº«çš„ commitIndex å’Œ lastAppliedï¼Œå½“å‰è€…å¤§äºåè€…æ—¶ï¼Œä¾¿æ„å‘³ç€æœ‰äº‹æƒ…åšäº†ï¼Œå¯ä»¥æŠŠä¸€äº› entry ç»™ apply æ‰äº†ã€‚</li></ol></li></ol><h3 id=safety>Safety <a href=#safety class=anchor>ğŸ”—</a></h3><p>Leader election å’Œ log replication æ˜¾ç„¶æ˜¯éœ€è¦æŸäº›çº¦æŸæ‰èƒ½ä¿è¯ Raft çš„æ­£ç¡®æ€§çš„ã€‚<a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf target=_blank rel=noopener>Extended Raft paper</a> ä¸­ç¬¼ç»Ÿæ¦‚æ‹¬äº†ä¸€äº› Safety propertiesï¼Œä½†æ˜¯åœ¨å†™ lab çš„æ—¶å€™ï¼Œå…¶å®æœ‰æ›´å¤šçš„ç»†èŠ‚éœ€è¦å»è€ƒè™‘åˆ°ã€‚</p><ol><li>é¦–å…ˆï¼Œå½“æ‰€æœ‰çš„ RPC ä¸­åŒ…å«çš„ term å°äº server è‡ªèº«çš„ term æ—¶ï¼Œå¿½ç•¥å®ƒï¼Œæˆ–è€…æ˜¯è¿”å› <code>false</code>ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚</li><li>å½“ä¸€ä¸ª candidate å‘å…¶ä»– server requests votes æ—¶ï¼Œå¯¹äºæŸä¸€ä¸ªç‰¹å®šçš„ serverï¼Œåªæœ‰è¯¥ candidate çš„ log ä¸å®ƒè‡ªå·±çš„ log ç›¸æ¯” <strong>least as up-to-date</strong> æ—¶ï¼Œæ‰ä¼šç»™äºˆ voteã€‚Log ä¹‹é—´çš„ up-to-date æ˜¯ä¸€ä¸ªéå¸¸å¾®å¦™çš„æ¯”è¾ƒå…³ç³»ï¼Œå‚è€ƒ paper ç¬¬ 8 é¡µã€‚</li><li>Leader ç»å¯¹ä¸å¯ä»¥ commit ä¸æ˜¯å½“å‰ term çš„ entryï¼Œå³ä½¿å®ƒç¡®å®å·²ç»è¢«é›†ç¾¤ majority æ‰€å…±è¯†ã€‚è¯¥æ€§è´¨è§£å†³äº† paper ä¸­ Figure 8 é˜è¿°çš„é—®é¢˜ï¼Œç®€å•æ¥è¯´ä¾¿æ˜¯ï¼Œå¦‚æœ leader å¯ä»¥éšæ„ commit ä»»æ„è¢«é›†ç¾¤å¤šæ•°æ‰€å…±è¯†çš„ entryï¼Œä¼šäº§ç”ŸæŸä¸ª index çš„ entry è¢« apply å¤šæ¬¡çš„ç¾éš¾ç°è±¡ï¼Œè€Œè¿™æ˜¯ç»å¯¹ä¸å…è®¸çš„ã€‚<a href=https://zhuanlan.zhihu.com/p/369989974 target=_blank rel=noopener>è¿™ç¯‡çŸ¥ä¹æ–‡ç« </a>è¯¦ç»†è§£é‡Šäº† Figure 8ï¼Œå¹¶ä½¿ç”¨äº†ä¸€ä¸ª no-op æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æœ€åçš„ä»£ç å®ç°å¹¶æ²¡æœ‰é‡‡ç”¨é¢å¤–çš„ no-op æ¥åšè¿™ä»¶äº‹ï¼Œè€Œæ˜¯<strong>åœ¨ leader å°è¯•è¿›è¡Œ commitIndex å‰ï¼Œè¿›è¡Œé¢å¤–çš„ term å¯¹æ¯”</strong>ï¼Œå‡å¦‚è¯¥ leader åªèƒ½æ‰¾åˆ°ä¸æ˜¯å½“å‰ term çš„ã€ä½†æ˜¯è¢«å¤šæ•°æœºå™¨æ‰€è®¤å¯çš„ entryï¼Œä¾¿<strong>ä¸ä¿®æ”¹ commitIndex</strong>ã€‚</li></ol><h2 id=6824-lab2>6.824 lab2 <a href=#6824-lab2 class=anchor>ğŸ”—</a></h2><p>å³ä½¿çœ‹æ‡‚äº† paper é‡Œ electionã€replication å’Œ safety çš„ä¸‰å—é˜è¿°ï¼Œç¼–å†™ lab2 æ—¶è¿˜æ˜¯ä¼šå‡ºç°å„ç§å„æ ·çš„å¥‡æ€ª bugï¼Œæˆ‘æœ€åçš„ç‰ˆæœ¬åœ¨è¿ç»­è·‘äº† 800 æ¬¡ test åæ²¡æœ‰æŠ¥é”™ï¼Œæä¸€äº›ç»†èŠ‚å¤„ç†ã€‚</p><ol><li>æ§åˆ¶é”çš„ç²’åº¦ï¼Œå°±åƒ <a href="https://www.youtube.com/watch?v=UzzcUS2OHqo&list=PLrw6a1wE39_tb2fErI4-WkMbsvGQk9_UB&index=5" target=_blank rel=noopener>6.824 åŠ©æ•™è¯´çš„</a>ä¸€æ ·ï¼Œåƒä¸‡ä¸è¦ç”¨å¾ˆå¤šå°é”æ¥ä¿æŠ¤å„ç§å„æ ·çš„ shared dataï¼Œé”çš„ç²’åº¦å¤ªå°æ—¶è·Ÿæ²¡æœ‰é”æ˜¯ä¸€æ ·çš„ã€‚<strong>é”çš„ç»ˆæç›®çš„ï¼Œå¹¶ä¸æ˜¯ä¸ºäº†ä¿æŠ¤ shared data çš„åŸå­è¯»å†™ï¼Œè€Œæ˜¯è®©æŸäº›ä»£ç ï¼ˆæŸäº›è¡Œä¸ºï¼‰è¿ç»­å‘ç”Ÿï¼Œå› æ­¤è¦ç«™åœ¨ç¨‹åºè¿è¡Œçš„è§’åº¦ä¸Šå»è€ƒè™‘é”çš„ç”¨å¤„ã€‚</strong></li><li>å°½é‡ç”¨ä¸€æŠŠå¤§é”å»ä¿æŠ¤ä¸´ç•ŒåŒºï¼Œæ§åˆ¶å¹¶å‘çš„åŠ›åº¦ï¼Œå¯ä»¥å…ˆä»ä¸å¹¶å‘çš„ä¸²è¡Œç¨‹åºå¼€å§‹ï¼Œå°å¿ƒæ…¢æ…¢æé«˜å¹¶å‘çš„åŠ›åº¦ã€‚å¹¶å‘çš„åŠ›åº¦å¤ªå¤§ä¼šå¯¼è‡´å¾ˆå¤šéš¾ä»¥ç†è§£çš„è¡Œä¸ºï¼Œä¸ªäººå»ºè®®åªéœ€è®©â€œçœŸæ­£å‘é€ RPCâ€ è¿™ä»¶äº‹ï¼ˆä¹Ÿå°±æ˜¯è°ƒç”¨ Callï¼‰å¹¶å‘åŒ–ï¼Œä¼šå‡å°‘å¾ˆå¤šé—®é¢˜çš„äº§ç”Ÿã€‚</li><li><code>votedFor</code> è¿™ä¸ªå˜é‡éœ€è¦é¢å¤–å°å¿ƒï¼Œå®ƒéœ€è¦ä¸€ä¸ª default valueï¼ˆæ¯”å¦‚ <code>-1</code> ï¼‰ã€‚<ol><li>æ ¹æ® Figure 2 å’Œ <a href=https://raft.github.io target=_blank rel=noopener>Raft æ¼”ç¤º</a>ï¼Œå½“ follower åšå‡ºæŠ•ç¥¨è¡Œä¸ºæ—¶ï¼Œéœ€è¦ä¿®æ”¹ <code>votedFor</code>ï¼›</li><li>åœ¨ server æ”¶åˆ° RequestVote RPC æ—¶ï¼Œå¦‚æœå®ƒåœ¨å…ˆå‰å·²ç»æŠ•ç¥¨ç»™äº†ä¸€ä¸ª serverï¼Œè€Œæ­¤æ—¶æ–°çš„ candidate çš„ term æ›´è¶…å‰æ—¶ï¼Œé¦–å…ˆè¦ä¿®æ”¹ <code>votedFor</code> ä¸º default valueï¼ˆæ„å‘³ç€å›åˆ°æ²¡æœ‰ç»™å‡ºæŠ•ç¥¨çš„çŠ¶æ€ï¼‰ï¼›</li><li>åœ¨ server æ¥æ”¶ leader çš„ heartbeat æ—¶ï¼Œå¦‚æœè¯¥ server å…ˆå‰æ²¡æœ‰æŠ•ç¥¨ç»™è¯¥ leaderï¼Œset <code>votedFor</code> to default valueã€‚æ‹è„‘è¢‹ä¸€æƒ³ï¼Œä¼šè§‰å¾—è¿™æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œå› ä¸º 2 å·²ç»ä¿è¯äº† election å¼€å§‹æ—¶ï¼Œserver ä¼šæ£€æŸ¥ term é‡ç½® <code>votedFor</code>ï¼Œä½†åœ¨ç½‘ç»œä¸ç¨³å®šçš„ Figure 8 çš„æƒ…å†µä¸‹ï¼Œä¼šæ›´å®¹æ˜“äº§ç”Ÿè°éƒ½é€‰ä¸ä¸Šçš„æ´»é”ï¼›</li><li>åœ¨æ‰€æœ‰çš„ RPC è°ƒç”¨ä¹‹åï¼Œéœ€è¦æ£€æŸ¥ reply ä¸­çš„ termï¼Œå¦‚æœå¯¹æ–¹çš„ term æ¯”è‡ªå·±è¿˜è¦è¶…å‰ï¼Œä¾¿é€€åŒ–ä¸º followerï¼Œé€€åŒ–æ—¶ä¹Ÿè¦ <strong>set <code>votedFor</code> to default value</strong>ã€‚</li></ol></li><li>åœ¨ leader çœŸæ­£å‘é€ heartbeat RPC å’Œ candidate çœŸæ­£å‘é€ <code>ReuqustVote</code> ä¹‹å‰ï¼ˆè°ƒç”¨ labrpc ä¸­ Call æ–¹æ³•å‰ï¼‰ï¼Œæ£€æŸ¥å½“å‰ go routine æ˜¯å¦å·²ç»è¿‡æœŸã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå› ä¸ºè°ƒåº¦å™¨çš„åŸå› ï¼ŒæŸä¸ªè¿‡æœŸ leader çš„ heartbeat routine åœ¨å®ƒè¢«å…¶ä»– leader heartbeat åæ‰åˆšåˆšè¢«è°ƒåº¦è¿è¡Œï¼Œè€Œæ­¤æ—¶çš„ term å·²ç»è¶…å‰äºåˆ›å»ºè¯¥ routine æ—¶å€™çš„ termï¼Œéœ€è¦è®¾è®¡ä¸€ä¸ªæœºåˆ¶æ¥è¿‡æ»¤è¿™æ ·çš„è¿‡æœŸ routineï¼ˆåœ¨åˆ›å»ºæ—¶ä¼ å…¥å½“å‰ termï¼‰ï¼›</li><li>ç”¨å¤šä¸ª routine å¯¹ commitIndex å’Œ lastApplied è¿›è¡Œç›‘æ§ï¼Œç”¨æ¡ä»¶å˜é‡è¿›è¡Œ routine ä¹‹é—´çš„é€šä¿¡ï¼›</li><li>å¯¹ nextIndex å®šä½çš„ä¼˜åŒ–å¯ä»¥å‚è€ƒ <a href=https://thesquareplanet.com/blog/students-guide-to-raft/ target=_blank rel=noopener>6.824 åŠ©æ•™çš„æ–‡ç« </a>ï¼Œè¿™ç¯‡æ–‡ç« ä¹Ÿæåˆ°äº†è®¸å¤šå®ç° Raft æ—¶éœ€è¦æ³¨æ„çš„ç»†èŠ‚ã€‚è¦æ³¨æ„ï¼Œè¿™ç¯‡æ–‡ç« å‡å®šäº† log entry çš„ index ä» 0 å¼€å§‹ï¼Œå¦‚æœä½ å’Œæˆ‘ä¸€æ ·ä¸¥æ ¼éµå®ˆ Figure 2 è®© entry index ä» 1 å¼€å§‹ï¼Œéœ€è¦è‡ªå·±åœ¨å…¶æ€è·¯ä¸Šé¢å¤–åšä¸€äº›ä¿®æ”¹ï¼Œ<strong>å¹¶ä¸”åœ¨å®Œæˆ lab2D Snapshot éƒ¨åˆ†æ—¶ï¼Œä¹Ÿéœ€è¦é’ˆå¯¹è¯¥ optimization å†å¤„ç†ä¸€äº›é¢å¤–çš„è¾¹ç•Œæ¡ä»¶</strong>ï¼›</li><li>åœ¨å‘é€ apply entry æ—¶ï¼ˆå‘é€ ApplyMsg ç»™ channel æ—¶ï¼‰ï¼Œéœ€è¦æ³¨æ„<strong>é”</strong>ã€‚ä¸€ä¸ªæ¨èçš„è¡Œä¸ºæ˜¯ï¼Œåœ¨ç­‰å¾… channel æ¶ˆè´¹ ApplyMsg æ—¶æŠŠé”é‡Šæ”¾ï¼Œæ¢å¥è¯è¯´ï¼Œåœ¨ <code>rf.applyCh &lt;- msg</code> å‰æŠŠé”é‡Šæ”¾ï¼Œå¦åˆ™åœ¨ 2D æœ‰å¯èƒ½ä¼šäº§ç”Ÿæ— é™ç­‰å¾…çš„æ­»é”æƒ…å†µï¼ˆè¿™ä¸ªæ­»é”è¿˜ä¸ä¼šè¢«æ£€æµ‹åˆ°ï¼‰ã€‚</li></ol><p>æœ€ç»ˆå®ç°çš„ç‰ˆæœ¬çš„æµ‹è¯•ç»“æœçš„ time consumingã€RPC numbers å¯ä»¥å‚è€ƒï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>âœ  raft git:<span style=color:#666>(</span>master<span style=color:#666>)</span> âœ— go <span style=color:#a2f>test</span> -race
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2A<span style=color:#666>)</span>: initial election ...
</span></span><span style=display:flex><span>  ... Passed --   3.0  <span style=color:#666>3</span>   <span style=color:#666>74</span>   <span style=color:#666>24538</span>    <span style=color:#666>0</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2A<span style=color:#666>)</span>: election after network failure ...
</span></span><span style=display:flex><span>  ... Passed --   4.5  <span style=color:#666>3</span>  <span style=color:#666>156</span>   <span style=color:#666>31934</span>    <span style=color:#666>0</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2A<span style=color:#666>)</span>: multiple elections ...
</span></span><span style=display:flex><span>  ... Passed --   5.5  <span style=color:#666>7</span>  <span style=color:#666>636</span>  <span style=color:#666>138233</span>    <span style=color:#666>0</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2B<span style=color:#666>)</span>: basic agreement ...
</span></span><span style=display:flex><span>  ... Passed --   0.7  <span style=color:#666>3</span>   <span style=color:#666>16</span>    <span style=color:#666>5272</span>    <span style=color:#666>3</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2B<span style=color:#666>)</span>: RPC byte count ...
</span></span><span style=display:flex><span>  ... Passed --   2.0  <span style=color:#666>3</span>   <span style=color:#666>48</span>  <span style=color:#666>116836</span>   <span style=color:#666>11</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2B<span style=color:#666>)</span>: agreement after follower reconnects ...
</span></span><span style=display:flex><span>  ... Passed --   5.8  <span style=color:#666>3</span>  <span style=color:#666>156</span>   <span style=color:#666>48680</span>    <span style=color:#666>8</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2B<span style=color:#666>)</span>: no agreement <span style=color:#a2f;font-weight:700>if</span> too many followers disconnect ...
</span></span><span style=display:flex><span>  ... Passed --   3.7  <span style=color:#666>5</span>  <span style=color:#666>248</span>   <span style=color:#666>56540</span>    <span style=color:#666>3</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2B<span style=color:#666>)</span>: concurrent Start<span style=color:#666>()</span>s ...
</span></span><span style=display:flex><span>  ... Passed --   0.7  <span style=color:#666>3</span>   <span style=color:#666>14</span>    <span style=color:#666>4602</span>    <span style=color:#666>6</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2B<span style=color:#666>)</span>: rejoin of partitioned leader ...
</span></span><span style=display:flex><span>  ... Passed --   4.2  <span style=color:#666>3</span>  <span style=color:#666>182</span>   <span style=color:#666>44785</span>    <span style=color:#666>4</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2B<span style=color:#666>)</span>: leader backs up quickly over incorrect follower logs ...
</span></span><span style=display:flex><span>  ... Passed --  20.3  <span style=color:#666>5</span> <span style=color:#666>2256</span> <span style=color:#666>1296886</span>  <span style=color:#666>102</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2B<span style=color:#666>)</span>: RPC counts aren<span>&#39;</span>t too high ...
</span></span><span style=display:flex><span>  ... Passed --   2.2  <span style=color:#666>3</span>   <span style=color:#666>50</span>   <span style=color:#666>17328</span>   <span style=color:#666>12</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2C<span style=color:#666>)</span>: basic persistence ...
</span></span><span style=display:flex><span>  ... Passed --   4.0  <span style=color:#666>3</span>  <span style=color:#666>112</span>   <span style=color:#666>31325</span>    <span style=color:#666>6</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2C<span style=color:#666>)</span>: more persistence ...
</span></span><span style=display:flex><span>  ... Passed --  16.6  <span style=color:#666>5</span> <span style=color:#666>1168</span>  <span style=color:#666>272848</span>   <span style=color:#666>16</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2C<span style=color:#666>)</span>: partitioned leader and one follower crash, leader restarts ...
</span></span><span style=display:flex><span>  ... Passed --   1.8  <span style=color:#666>3</span>   <span style=color:#666>42</span>   <span style=color:#666>12032</span>    <span style=color:#666>4</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2C<span style=color:#666>)</span>: Figure <span style=color:#666>8</span> ...
</span></span><span style=display:flex><span>  ... Passed --  34.7  <span style=color:#666>5</span> <span style=color:#666>1528</span>  <span style=color:#666>341677</span>   <span style=color:#666>36</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2C<span style=color:#666>)</span>: unreliable agreement ...
</span></span><span style=display:flex><span>  ... Passed --   4.2  <span style=color:#666>5</span>  <span style=color:#666>212</span>   <span style=color:#666>84694</span>  <span style=color:#666>246</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2C<span style=color:#666>)</span>: Figure <span style=color:#666>8</span> <span style=color:#666>(</span>unreliable<span style=color:#666>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  38.8  <span style=color:#666>5</span> <span style=color:#666>4064</span> <span style=color:#666>7936640</span>  <span style=color:#666>209</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2C<span style=color:#666>)</span>: churn ...
</span></span><span style=display:flex><span>  ... Passed --  16.6  <span style=color:#666>5</span>  <span style=color:#666>912</span>  <span style=color:#666>837728</span>  <span style=color:#666>251</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2C<span style=color:#666>)</span>: unreliable churn ...
</span></span><span style=display:flex><span>  ... Passed --  16.3  <span style=color:#666>5</span>  <span style=color:#666>620</span>  <span style=color:#666>216412</span>   <span style=color:#666>50</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2D<span style=color:#666>)</span>: snapshots basic ...
</span></span><span style=display:flex><span>  ... Passed --   5.6  <span style=color:#666>3</span>  <span style=color:#666>140</span>   <span style=color:#666>57416</span>  <span style=color:#666>220</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2D<span style=color:#666>)</span>: install snapshots <span style=color:#666>(</span>disconnect<span style=color:#666>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  62.2  <span style=color:#666>3</span> <span style=color:#666>1758</span>  <span style=color:#666>727536</span>  <span style=color:#666>308</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2D<span style=color:#666>)</span>: install snapshots <span style=color:#666>(</span>disconnect+unreliable<span style=color:#666>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  75.2  <span style=color:#666>3</span> <span style=color:#666>2098</span>  <span style=color:#666>838116</span>  <span style=color:#666>355</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2D<span style=color:#666>)</span>: install snapshots <span style=color:#666>(</span>crash<span style=color:#666>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  32.3  <span style=color:#666>3</span>  <span style=color:#666>818</span>  <span style=color:#666>412298</span>  <span style=color:#666>335</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2D<span style=color:#666>)</span>: install snapshots <span style=color:#666>(</span>unreliable+crash<span style=color:#666>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  38.0  <span style=color:#666>3</span>  <span style=color:#666>956</span>  <span style=color:#666>409544</span>  <span style=color:#666>268</span>
</span></span><span style=display:flex><span>Test <span style=color:#666>(</span>2D<span style=color:#666>)</span>: crash and restart all servers ...
</span></span><span style=display:flex><span>  ... Passed --  10.0  <span style=color:#666>3</span>  <span style=color:#666>248</span>   <span style=color:#666>84358</span>   <span style=color:#666>53</span>
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      6.824/raft      410.052s
</span></span></code></pre></div></div><div class=tags><a href=https://jhzhu.xyz/tags/go>Go</a>
<a href=https://jhzhu.xyz/tags/distributed-systems>Distributed Systems</a>
<a href=https://jhzhu.xyz/tags/raft>Raft</a></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/daniel-junhui rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a><a class=symbol href=https://twitter.com/jhzhuuu rel=me target=_blank><svg fill="#bbb" width="28" height="28" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="438.536" height="438.536" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536"><g><path d="M414.41 24.123C398.333 8.042 378.963.0 356.315.0H82.228C59.58.0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648.0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225C438.532 59.576 430.49 40.204 414.41 24.123zM335.471 168.735c.191 1.713.288 4.278.288 7.71.0 15.989-2.334 32.025-6.995 48.104-4.661 16.087-11.8 31.504-21.416 46.254-9.606 14.749-21.074 27.791-34.396 39.115-13.325 11.32-29.311 20.365-47.968 27.117-18.648 6.762-38.637 10.143-59.953 10.143-33.116.0-63.76-8.952-91.931-26.836 4.568.568 9.329.855 14.275.855 27.6.0 52.439-8.565 74.519-25.7-12.941-.185-24.506-4.179-34.688-11.991-10.185-7.803-17.273-17.699-21.271-29.691 4.947.76 8.658 1.137 11.132 1.137 4.187.0 9.042-.76 14.56-2.279-13.894-2.669-25.598-9.562-35.115-20.697-9.519-11.136-14.277-23.84-14.277-38.114v-.571c10.085 4.755 19.602 7.229 28.549 7.422-17.321-11.613-25.981-28.265-25.981-49.963.0-10.66 2.758-20.747 8.278-30.264 15.035 18.464 33.311 33.213 54.816 44.252 21.507 11.038 44.54 17.227 69.092 18.558-.95-3.616-1.427-8.186-1.427-13.704.0-16.562 5.853-30.692 17.56-42.399 11.703-11.706 25.837-17.561 42.394-17.561 17.515.0 32.079 6.283 43.688 18.846 13.134-2.474 25.892-7.33 38.26-14.56-4.757 14.652-13.613 25.788-26.55 33.402 12.368-1.716 23.88-4.95 34.537-9.708C357.458 149.793 347.462 160.166 335.471 168.735z"/></g></svg></a></div><div class=copyright>Â© Copyright
2023
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Junhui Zhu</div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-mini>nodejh</a></div></footer></body></html>