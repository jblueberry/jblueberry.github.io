<!DOCTYPE html><html class=scrollbar-none lang=zh><head><meta charset=utf-8><link href=http://jzhu.xyz/posts/mr.html rel=canonical><meta content="width=device-width,initial-scale=1" name=viewport><meta content="ie=edge" http-equiv=x-ua-compatible><link href=/favicon.ico rel=icon><link href=/apple-touch-icon.png rel=apple-touch-icon><title>MapReduce</title><meta content=MapReduce name=title><meta name=description><link href=/rss.xml rel=alternate title="Junhui's garage RSS Feed" type=application/rss+xml><link href=/sitemap-index.xml rel=sitemap title="Junhui's garage site map" type=application/xml><meta content=http://jzhu.xyz/posts/mr.html property=og:url><meta content=MapReduce property=og:title><meta content=website property=og:type><meta property=og:description><meta content=http://jzhu.xyz/posts/mr.html.png property=og:image><meta content="Junhui's garage" property=og:site_name><meta content=summary_large_image name=twitter:card><meta content=http://jzhu.xyz/posts/mr.html name=twitter:url><meta content=MapReduce name=twitter:title><meta name=twitter:description><meta content=http://jzhu.xyz/posts/mr.html.png name=twitter:image><meta content=true name=astro-view-transitions-enabled><meta content=animate name=astro-view-transitions-fallback><link href=/_astro/about.BrhoeKCr.css rel=stylesheet><link href=/_astro/about.44ThaYkS.css rel=stylesheet><script type=module src=/_astro/hoisted.CfD9_vnQ.js></script><script type=module src=/_astro/page.si7EJ8pT.js></script></head><body class="flex flex-col bg-local bg-[#f7f7f7] dark:bg-[#202124] dark:text-neutral-50 justify-between lg:pb-[3dvh] lg:pt-[6dvh] min-h-dvh py-[2dvh] text-neutral-600"><div class="flex flex-col bg-local bg-neutral-50 dark:bg-[#212223] dark:shadow-[0_0_0.5em_0.25em_rgba(136,136,136,0.35)] grow lg:p-[2dvw] max-w-[1400px] mx-auto p-[3dvw] shadow-[0_0.5em_1em_0_rgba(236,236,236,0.86)] w-[90dvw]"><header class="grid grid-cols-2 items-start justify-between lg:flex"><a href=/ aria-label="go to index" class="" data-astro-transition-persist=astro-tpw7oqt3-1>Junhui's garage </a><button aria-label="open menu" class="justify-self-end lg:hidden" title="open menu" data-astro-transition-persist=astro-rgoj5e2l-2 id=menu-btn aria-controls=menu-items aria-expanded=false><svg class=size-8 viewBox="0 0 24 24" data-icon=ri:menu-fill height=1em width=1em><symbol id=ai:ri:menu-fill><path d="M3 4h18v2H3zm0 7h18v2H3zm0 7h18v2H3z" fill=currentColor /></symbol><use xlink:href=#ai:ri:menu-fill></use></svg></button><div class="flex-col gap-3 col-span-2 hidden lg:flex lg:items-end text-center" id=menu><div class="flex flex-col lg:flex-row gap-3 items-center lg:gap-8 lg:mb-7 mb-[2dvh]"><nav><ul class="flex flex-col lg:flex-row gap-3 font-default-sans"><li><button aria-label="Navigate to Home" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=false type=button data-nav=Home><a href=/ >Home</a></button></li><li><button aria-label="Navigate to Blog" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=true type=button data-nav=Blog><a href=/blog>Blog</a></button></li><li><button aria-label="Navigate to Tags" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=false type=button data-nav=Tags><a href=/tags>Tags</a></button></li><li><button aria-label="Navigate to Archives" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=false type=button data-nav=Archives><a href=/archives>Archives</a></button></li><li><button aria-label="Navigate to About" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 dark:text-neutral-50 text-neutral-700" aria-pressed=false type=button data-nav=About><a href=/about>About</a></button></li></ul></nav><a href=/search aria-label="Navigate to search page" title="Navigate to search page"><svg class="hover:opacity-100 opacity-75" viewBox="0 0 24 24" data-icon=ri:search-2-line height=1em width=1em><symbol id=ai:ri:search-2-line><path d="M11 2c4.968 0 9 4.032 9 9s-4.032 9-9 9s-9-4.032-9-9s4.032-9 9-9m0 16c3.867 0 7-3.133 7-7s-3.133-7-7-7s-7 3.133-7 7s3.133 7 7 7m8.485.071l2.829 2.828l-1.415 1.415l-2.828-2.829z" fill=currentColor /></symbol><use xlink:href=#ai:ri:search-2-line></use></svg></a><div class="flex gap-3 forced-colors:hidden" data-astro-transition-persist=astro-t5bszqxv-6><button aria-label="Switch to os-default theme" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 theme-toggler" aria-pressed=false type=button data-theme=os-default><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:contrast-fill height=1em width=1em><symbol id=ai:ri:contrast-fill><path d="M12 21.997c-5.523 0-10-4.477-10-10s4.477-10 10-10s10 4.477 10 10s-4.477 10-10 10m0-2v-16a8 8 0 0 0 0 16" fill=currentColor /></symbol><use xlink:href=#ai:ri:contrast-fill></use></svg></button><button aria-label="Switch to light theme" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 theme-toggler" aria-pressed=false type=button data-theme=light><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:sun-fill height=1em width=1em><symbol id=ai:ri:sun-fill><path d="M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12M11 1h2v3h-2zm0 19h2v3h-2zM3.515 4.929l1.414-1.414L7.05 5.636L5.636 7.05zM16.95 18.364l1.414-1.414l2.121 2.121l-1.414 1.414zm2.121-14.85l1.414 1.415l-2.121 2.121l-1.414-1.414zM5.636 16.95l1.414 1.414l-2.121 2.121l-1.414-1.414zM23 11v2h-3v-2zM4 11v2H1v-2z" fill=currentColor /></symbol><use xlink:href=#ai:ri:sun-fill></use></svg></button><button aria-label="Switch to dark theme" class="hover:opacity-100 opacity-75 aria-pressed:opacity-100 theme-toggler" aria-pressed=false type=button data-theme=dark><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:moon-line height=1em width=1em><symbol id=ai:ri:moon-line><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2h.1A6.98 6.98 0 0 0 10 7m-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938A8 8 0 0 0 4 12" fill=currentColor /></symbol><use xlink:href=#ai:ri:moon-line></use></svg></button></div></div><div>再见无脚鸟</div><div class="flex gap-3 flex-wrap justify-center lg:mt-0 mt-[2dvh]"><a href=edison.jzhu@gmail.com aria-label=mail><svg class="hover:opacity-100 opacity-75 fill-current" viewBox="0 0 24 24" data-icon=ri:mail-fill height=1em width=1em><title>mail</title><symbol id=ai:ri:mail-fill><path d="M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1m9.06 8.683L5.648 6.238L4.353 7.762l7.72 6.555l7.581-6.56l-1.308-1.513z" fill=currentColor /></symbol><use xlink:href=#ai:ri:mail-fill></use></svg> </a><a href=https://github.com/jblueberry aria-label=github><svg class="hover:opacity-100 opacity-75 fill-current" viewBox="0 0 24 24" data-icon=ri:github-fill height=1em width=1em><title>github</title><symbol id=ai:ri:github-fill><path d="M12.001 2c-5.525 0-10 4.475-10 10a9.99 9.99 0 0 0 6.837 9.488c.5.087.688-.213.688-.476c0-.237-.013-1.024-.013-1.862c-2.512.463-3.162-.612-3.362-1.175c-.113-.288-.6-1.175-1.025-1.413c-.35-.187-.85-.65-.013-.662c.788-.013 1.35.725 1.538 1.025c.9 1.512 2.337 1.087 2.912.825c.088-.65.35-1.087.638-1.337c-2.225-.25-4.55-1.113-4.55-4.938c0-1.088.387-1.987 1.025-2.687c-.1-.25-.45-1.275.1-2.65c0 0 .837-.263 2.75 1.024a9.3 9.3 0 0 1 2.5-.337c.85 0 1.7.112 2.5.337c1.913-1.3 2.75-1.024 2.75-1.024c.55 1.375.2 2.4.1 2.65c.637.7 1.025 1.587 1.025 2.687c0 3.838-2.337 4.688-4.562 4.938c.362.312.675.912.675 1.85c0 1.337-.013 2.412-.013 2.75c0 .262.188.574.688.474A10.02 10.02 0 0 0 22 12c0-5.525-4.475-10-10-10" fill=currentColor /></symbol><use xlink:href=#ai:ri:github-fill></use></svg> </a><a href=/rss.xml aria-label="the RSS link"><svg class="hover:opacity-100 opacity-75 fill-current" viewBox="0 0 24 24" data-icon=ri:rss-fill height=1em width=1em><title>the RSS link</title><symbol id=ai:ri:rss-fill><path d="M3 3c9.941 0 18 8.059 18 18h-3c0-8.284-6.716-15-15-15zm0 7c6.075 0 11 4.925 11 11h-3a8 8 0 0 0-8-8zm0 7a4 4 0 0 1 4 4H3z" fill=currentColor /></symbol><use xlink:href=#ai:ri:rss-fill></use></svg></a></div></div></header><main class="pt-[2dvh] lg:pt-[6dvh] px-[2dvw]"><h1 class="font-extrabold text-5xl">MapReduce</h1><div class="dark:text-neutral-300 lg:my-[3dvh] my-[1dvh] text-neutral-600"><div class="flex flex-col lg:flex-row *:flex *:items-center lg:gap-4 opacity-70"><time datetime=2021-08-10T04:00:00.000Z><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:time-line height=1em width=1em aria-label=date><title>date</title><symbol id=ai:ri:time-line><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10m0-2a8 8 0 1 0 0-16a8 8 0 0 0 0 16m1-8h4v2h-6V7h2z" fill=currentColor /></symbol><use xlink:href=#ai:ri:time-line></use></svg> 8/10/2021, 4:00:00 AM </time><time datetime=2024-07-21T14:42:02.451Z><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:history-line height=1em width=1em aria-label="last modified date"><title>last modified date</title><symbol id=ai:ri:history-line><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12h2a8 8 0 1 0 1.385-4.5H8v2H2v-6h2V6a9.99 9.99 0 0 1 8-4m1 5v4.585l3.243 3.243l-1.415 1.415L11 12.413V7z" fill=currentColor /></symbol><use xlink:href=#ai:ri:history-line></use></svg> 7/21/2024, 2:42:02 PM </time><span><svg class=fill-current viewBox="0 0 24 24" data-icon=ri:hourglass-fill height=1em width=1em aria-label="read time"><title>read time</title><symbol id=ai:ri:hourglass-fill><path d="M6 4H4V2h16v2h-2v2c0 1.615-.816 2.915-1.844 3.977c-.703.726-1.558 1.395-2.425 2.023c.867.628 1.722 1.297 2.425 2.023C17.184 15.085 18 16.385 18 18v2h2v2H4v-2h2v-2c0-1.615.816-2.915 1.844-3.977c.703-.726 1.558-1.395 2.425-2.023c-.867-.628-1.722-1.297-2.425-2.023C6.816 8.915 6 7.615 6 6zm2 0v2c0 .685.26 1.335.771 2h6.458c.51-.665.771-1.315.771-2V4zm4 9.222c-1.045.738-1.992 1.441-2.719 2.192a7 7 0 0 0-.51.586h6.458a7 7 0 0 0-.51-.586c-.727-.751-1.674-1.454-2.719-2.192" fill=currentColor /></symbol><use xlink:href=#ai:ri:hourglass-fill></use></svg> 3 min read</span></div><div><a href=/tags/Golang/1 aria-label="More posts of tag Golang" class="hover:opacity-100 mr-2 opacity-80 text-xl">Golang </a><a href="/tags/Distributed Systems/1" aria-label="More posts of tag Distributed Systems" class="hover:opacity-100 mr-2 opacity-80 text-xl">Distributed Systems</a></div></div><article class="[&#38;_.toc-item]:my-0 [&#38;_.toc-level]:mt-0 [&#38;_iframe]:rounded-lg [&#38;_p_code]:after:content-none [&#38;_p_code]:before:content-none [&#38;_p_code]:bg-neutral-100 [&#38;_p_code]:p-1 [&#38;_p_code]:rounded dark:[&#38;_p_code]:bg-[#121212] dark:prose-invert max-w-full prose prose-img:rounded-lg prose-p:hyphens-auto prose-p:text-justify prose-pre:!bg-neutral-100 prose-pre:rounded-lg prose-video:rounded-lg"><nav class=toc><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a href=#mapreduce class="toc-link toc-link-h2">MapReduce</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a href=#map-和-reduce class="toc-link toc-link-h3">Map 和 Reduce</a></li><li class="toc-item toc-item-h3"><a href=#google-的-mapreduce-implementation class="toc-link toc-link-h3">Google 的 MapReduce Implementation</a></li></ol></li><li class="toc-item toc-item-h2"><a href=#6824-lab1 class="toc-link toc-link-h2">6.824 lab1</a></li></ol></nav><p>6.824 lab1 的 notes。</p><h2 id=mapreduce>MapReduce</h2><p>简言之，MapReduce 是一种 programming model。</p><h3 id=map-和-reduce>Map 和 Reduce</h3><p>输入是一个 KV 集合，输出也是一个 KV 集合，用户可以自行实现 Map 和 Reduce。</p><ul><li>Map 接收一个 KV <code>&#x3C;k1,v1></code> 作为输入，输出一个 KV 集合 <code>list(&#x3C;k2, v2>)</code>，集合被称为 intermediate KV pairs；</li><li>对 intermediate 中相同 key 的数据进行聚合，这一步称为 Shuffle；</li><li>将 Shuffle 好的数据传给 Reduce，每一个 <code>&#x3C;k2, list(v2)></code> 最终将映射到另一个集合 <code>&#x3C;k2, v3></code>。</li></ul><div class="relative group"><span class="absolute right-2 -top-3 group-hover:hidden text-sm">plaintext</span><button aria-label="Copy code" class="hidden absolute bg-[#121212] copy dark:bg-neutral-100 group group-hover:block px-1 right-2 rounded-md top-2" aria-pressed=false type=button title="Copy code"><svg class="dark:fill-[#121212] fill-neutral-100 size-6 group-aria-pressed:hidden" viewBox="0 0 24 24" aria-label=Copy role=img xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6ZM7 11H13V13H7V11ZM7 15H13V17H7V15Z"></path></svg><svg class="hidden dark:fill-[#121212] fill-neutral-100 group-aria-pressed:block size-6" viewBox="0 0 24 24" aria-label=Done role=img xmlns=http://www.w3.org/2000/svg><path d="M9.9997 15.1709L19.1921 5.97852L20.6063 7.39273L9.9997 17.9993L3.63574 11.6354L5.04996 10.2212L9.9997 15.1709Z"></path></svg></button><pre class="astro-code astro-code-themes vitesse-dark vitesse-light" data-language=plaintext lang=plaintext style=background-color:#fff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee;overflow-x:auto tabindex=0><code><span class=line><span>map: &#x3C;k1,v1> -> list(&#x3C;k2,v2>)</span></span>
<span class=line><span>shuffle: list(&#x3C;k2, v2>) -> list(&#x3C;k2, list(v2)>)</span></span>
<span class=line><span>reduce: &#x3C;k2,list(v2)> -> &#x3C;k2, v3></span></span>
<span class=line><span></span></span></code></pre></div><p><img alt=mr decoding=async height=1776 loading=lazy src=/_astro/mr.drawio.zN9abxOt_Z18ndD8.webp width=2586></p><ol><li>将输入数据分割为 M 个 splits；</li><li>一共有 M 个 map 任务和 R 个 reduce 任务；</li><li>如果一个 worker 被分配了一个 map 任务，那它会读取特定的那个 split ，从数据中提取出 KV 对集合传输给用户定义的 <code>Map</code> 函数，<code>Map</code> 函数产生的 intermediate KV 对存在内存缓冲区中；</li><li>内存缓冲区中的 intermediate 数据会被周期性写到磁盘上并被分割为 R 个 intermediate；</li><li>如果一个 worker 被分配了一个 map 任务，会通过 RPC 读取该任务对应的 intermediate data，并调用 <code>Reduce</code>；</li><li>master 负责指派、协调 map worker 和 reduce worker。</li></ol><h3 id=google-的-mapreduce-implementation>Google 的 MapReduce Implementation</h3><ol><li>机器大多是 x86 架构，跑 Linux ，内存 2-4 GB；</li><li>商用网络，通常是 100 Mb/s 或者 1Gb/s；</li><li>一个集群有上百或者上千个机器，出故障很正常；</li><li>用便宜的 IDE 硬盘直接保存每个机器自己的数据，用内部开发的分布式文件系统来管理文件；</li><li>用户向一个调度系统提交 jobs ，每个 job 是一个 task 集合，由调度系统来分配到集群中的可用机器上。</li></ol><h2 id=6824-lab1>6.824 lab1</h2><p>一些自己的思路。</p><ul><li>master 管理 task 的状态，M 个 mapTask 和 R 个 reduceTask；</li><li>整个过程分为 2 个 phase，mapPhase 和 reducePhase，因为 reduceTask 需要从每个完成的 mapTask 中的部分数据进行 shuffle；</li><li>master 在 assign task 给 worker 后启动定时器，如果时间耗尽时该 task 还未完成，该 task 变回 unassigned 状态；</li></ul></article><hr class="bg-zinc-200 border-0 dark:bg-zinc-700 h-1 md:my-10 mx-auto my-4 rounded w-48"><div class="[&_main]:transition-colors giscus"></div></main></div><footer class="lg:mt-[4dvh] mt-[3dvh] text-center" data-astro-transition-persist=astro-tvayyljk-4><p class="lg:mb-[2dvh] mb-[1dvh]">In Search of Identity</p><p class="opacity-75 text-neutral-700 dark:text-neutral-300">&copy; 2024 Ladit. Powered by <a href=https://astro.build aria-label="Read more about Astro" class=underline rel=noopener target=_blank>Astro</a>. <a href=https://github.com/ladit/astro-blog-zozo aria-label="Read more about this theme" class=underline rel=noopener target=_blank>Theme</a> by Ladit.</p></footer><button aria-label="Back to top" class="hidden fixed 	bottom-6 	right-6 size-10 	cursor-pointer 	place-content-center 	rounded-full 	bg-[#f0f0f0] 	opacity-60 	hover:opacity-100 	dark:bg-[#555555]" title="Back to top" data-astro-transition-persist=astro-w6n6ksoh-5 id=back-to-top><svg class="fill-current self-center size-8" viewBox="0 0 24 24" data-icon=ri:arrow-up-double-fill height=1em width=1em><symbol id=ai:ri:arrow-up-double-fill><path d="m12 4.836l-6.207 6.207l1.414 1.414L12 7.664l4.793 4.793l1.414-1.414zm0 5.65l-6.207 6.207l1.414 1.414L12 13.314l4.793 4.793l1.414-1.414z" fill=currentColor /></symbol><use xlink:href=#ai:ri:arrow-up-double-fill></use></svg></button></body></html><script type=module>const copy=async t=>{const e=t.nextElementSibling?.children[0];e&&(await navigator.clipboard.writeText(e.textContent),t.setAttribute("aria-pressed","true"),setTimeout((()=>{t.setAttribute("aria-pressed","false")}),700))},copyButtons=Array.from(document.querySelectorAll(".prose button.copy"));for(const t of copyButtons)t.addEventListener("click",(()=>copy(t)))</script>