<!doctype html><html lang=en-us><head><title>6.S081 Notes | Junhui Zhu</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="6.S081 çš„ä¸€äº› notesã€‚"><meta name=generator content="Hugo 0.110.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>â†</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a>
<a href=/about>About</a>
<a href=https://www.zhihu.com/people/zhu-jun-hui-40-47>Zhihu</a>
<a class=button href=https://jhzhu.xyz/index.xml>Subscribe</a></nav><main class=main><section id=single><h1 class=title>6.S081 Notes</h1><div class=tip><time datetime="2021-07-15 00:00:00 +0000 UTC">Jul 15, 2021</time>
<span class=split>Â·</span>
<span>6172 words</span>
<span class=split>Â·</span>
<span>13 minute read</span></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#system-call>System call</a><ul><li><a href=#syscall-system-call>Syscall system call</a></li><li><a href=#risc-v-ç³»ç»Ÿè°ƒç”¨çš„ä¸€äº›è§„åˆ™æ‘˜å½•>RISC-V ç³»ç»Ÿè°ƒç”¨çš„ä¸€äº›è§„åˆ™æ‘˜å½•</a></li><li><a href=#sysinfo-system-call>Sysinfo system call</a></li></ul></li><li><a href=#page-table>Page table</a><ul><li><a href=#æ¯ä¸ªè¿›ç¨‹çš„-kernel-page-table>æ¯ä¸ªè¿›ç¨‹çš„ kernel page table</a></li></ul></li><li><a href=#trap>Trap</a><ul><li><a href=#user-mode-ä¸‹çš„-trap>User mode ä¸‹çš„ trap</a></li><li><a href=#syscall-ä¸­å¦‚ä½•ä¼ é€’å‚æ•°>Syscall ä¸­å¦‚ä½•ä¼ é€’å‚æ•°</a></li><li><a href=#kernel-mode-ä¸‹çš„-trap>Kernel mode ä¸‹çš„ trap</a></li><li><a href=#trap-lab>Trap lab</a></li></ul></li><li><a href=#lazy-page-allocation>Lazy page allocation</a><ul><li><a href=#è¿½æº¯-panic>è¿½æº¯ panic</a></li><li><a href=#è§£å†³-panic>è§£å†³ panic</a></li></ul></li></ul></nav></div></details></aside><div class=content><p>6.S081 çš„ä¸€äº› notesã€‚</p><p>å› ä¸ºå…¶å®ä¸€ç›´éƒ½æ²¡æœ‰å¥½å¥½è¯»è¿‡ OSTEPï¼Œæ‰€ä»¥æˆ‘åœ¨æœ€è¿‘ä¸€å‘¨ä¸€å£æ°”æŠŠè¿™æœ¬ä¹¦è¯»å®Œäº†ï¼Œä½†è¿˜æ˜¯æ„Ÿè§‰ä¸å¤Ÿï¼Œå› ä¸ºæˆ‘çŸ¥é“è¦å­¦ä¼šè¿™ç©æ„å¿…é¡»è¦ make hands dirtyã€‚äºæ˜¯å‡†å¤‡å¿«é€Ÿçš„æŠŠ 6.S081 è¿‡å®Œï¼Œç„¶åæŠŠ lab åšæ‰ï¼Œå†é…åˆè¯» xv6 çš„ä»£ç ã€‚</p><h2 id=system-call>System call <a href=#system-call class=anchor>ğŸ”—</a></h2><h3 id=syscall-system-call>Syscall system call <a href=#syscall-system-call class=anchor>ğŸ”—</a></h3><p>ç¬¬ä¸€ä¸ª lab æ²¡ä»€ä¹ˆå¥½è®°å½•çš„ï¼Œåªä¸è¿‡ç”¨ system call å°æ‰“å°é—¹è€Œå·²ï¼Œä»ç¬¬äºŒä¸ª lab å¼€å§‹æ‰æ˜¯çœŸçš„å¯¹ kernel åšäº‹æƒ…ã€‚</p><h4 id=é‡åˆ°çš„ä¸€äº›ç–‘é—®>é‡åˆ°çš„ä¸€äº›ç–‘é—® <a href=#%e9%81%87%e5%88%b0%e7%9a%84%e4%b8%80%e4%ba%9b%e7%96%91%e9%97%ae class=anchor>ğŸ”—</a></h4><ul><li><p>è‹±è¯­å¤ªåƒï¼Œçœ‹ä¸æ‡‚è¿™å¥è¯ï¼š</p><blockquote><p>Add a <code>sys_trace()</code> function in <code>kernel/sysproc.c</code> that implements the new system call by remembering its argument in a new variable in the proc structure (see <code>kernel/proc.h</code>). The functions to retrieve system call arguments from user space are in <code>kernel/syscall.c</code>, and you can see examples of their use in <code>kernel/sysproc.c</code>.</p></blockquote></li></ul><p>é¾™é¸£ç¿»è¯‘ï¼šè¦åŠ ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é€šè¿‡åœ¨ <code>proc</code> ç»“æ„ä¸­å¢åŠ çš„ä¸€ä¸ªæ–°çš„å˜é‡æ¥å®ç°ç³»ç»Ÿè°ƒç”¨ï¼Œä»ç”¨æˆ·ç©ºé—´æ‹¿åˆ°ç³»ç»Ÿè°ƒç”¨å‚æ•°çš„å‡½æ•°åœ¨ <code>syscall.c</code> ä¸­ã€‚ç¡®å®æ²¡æ€ä¹ˆçœ‹æ‡‚ï¼Œé‚£å°±å…ˆçœ‹çœ‹ä»£ç ã€‚</p><p>ä¸€ä¸ªå¾ˆå…³é”®çš„æ±‡ç¼–æ–‡ä»¶ï¼š<code>usys.S</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>sleep:
</span></span><span style=display:flex><span> li a7, SYS_sleep
</span></span><span style=display:flex><span> ecall
</span></span><span style=display:flex><span> ret
</span></span><span style=display:flex><span>.global uptime
</span></span><span style=display:flex><span>uptime:
</span></span><span style=display:flex><span> li a7, SYS_uptime
</span></span><span style=display:flex><span> ecall
</span></span><span style=display:flex><span> ret
</span></span><span style=display:flex><span>.global trace
</span></span><span style=display:flex><span>trace:
</span></span><span style=display:flex><span> li a7, SYS_trace
</span></span><span style=display:flex><span> ecall
</span></span><span style=display:flex><span> ret
</span></span></code></pre></div><p>è¿™ä¸ªæ–‡ä»¶å¯ä»¥çœ‹åˆ°è°ƒç”¨ system call çš„ä¸€äº›æŒ‡ä»¤ï¼Œå…¶ä¸­ <code>a7</code> æ˜¯ RISC-V çš„ä¸€ä¸ªå¯„å­˜å™¨ï¼Œå†çœ‹ <code>kernel/syscall.c</code> å½“ä¸­çš„ä¸€ä¸ªå…³é”®çš„å‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#0b0;font-weight:700>void</span>
</span></span><span style=display:flex><span><span style=color:#00a000>syscall</span>(<span style=color:#0b0;font-weight:700>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#0b0;font-weight:700>int</span> num;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>struct</span> proc <span style=color:#666>*</span>p <span style=color:#666>=</span> <span style=color:#00a000>myproc</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  num <span style=color:#666>=</span> p<span style=color:#666>-&gt;</span>trapframe<span style=color:#666>-&gt;</span>a7;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span>(num <span style=color:#666>&gt;</span> <span style=color:#666>0</span> <span style=color:#666>&amp;&amp;</span> num <span style=color:#666>&lt;</span> <span style=color:#00a000>NELEM</span>(syscalls) <span style=color:#666>&amp;&amp;</span> syscalls[num]) {
</span></span><span style=display:flex><span>    p<span style=color:#666>-&gt;</span>trapframe<span style=color:#666>-&gt;</span>a0 <span style=color:#666>=</span> syscalls[num]();
</span></span><span style=display:flex><span>  } <span style=color:#a2f;font-weight:700>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#00a000>printf</span>(<span style=color:#b44>&#34;%d %s: unknown sys call %d</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#b44>&#34;</span>,
</span></span><span style=display:flex><span>            p<span style=color:#666>-&gt;</span>pid, p<span style=color:#666>-&gt;</span>name, num);
</span></span><span style=display:flex><span>    p<span style=color:#666>-&gt;</span>trapframe<span style=color:#666>-&gt;</span>a0 <span style=color:#666>=</span> <span style=color:#666>-</span><span style=color:#666>1</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™ä¸ªå‡½æ•°åº”è¯¥å°±æ˜¯ç”¨æˆ·æ€å’Œç³»ç»Ÿè°ƒç”¨çš„æ¥å£ï¼Œé¦–å…ˆè·å–å½“å‰è¿›ç¨‹çš„ <code>a7</code> å¯„å­˜å™¨ï¼Œå¦‚æœè¿™ä¸ªå¯„å­˜å™¨ä¸­çš„ç³»ç»Ÿè°ƒç”¨å·å­˜åœ¨ï¼ˆä¹Ÿå°±æ˜¯ <code>num > 0 && num &lt; NELEM(syscalls) && syscalls[num] </code>è¯­å¥ä¸ºçœŸï¼‰ï¼Œé‚£å°±è°ƒç”¨å®ƒå¹¶è¿”å›ï¼ˆæŠŠ <code>a0</code> å¯„å­˜å™¨è®¾ç½®ä¸ºè¿”å›å€¼ï¼‰ï¼Œå¦åˆ™å°±è¿”å› <code>-1</code> ã€‚</p><p>é€’å½’å­¦ä¹ ï¼šçœ‹ä¸å¤ªæ‡‚ä¸‹é¢è¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„åˆ°åº•æ˜¯ä»€ä¹ˆç©æ„ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a2f;font-weight:700>static</span> <span style=color:#00a000>uint64</span> (<span style=color:#666>*</span>syscalls[])(<span style=color:#0b0;font-weight:700>void</span>) <span style=color:#666>=</span> {
</span></span><span style=display:flex><span>[SYS_fork]    sys_fork,
</span></span><span style=display:flex><span>[SYS_exit]    sys_exit,
</span></span><span style=display:flex><span>[SYS_wait]    sys_wait,
</span></span><span style=display:flex><span>[SYS_pipe]    sys_pipe,
</span></span><span style=display:flex><span>[SYS_read]    sys_read,
</span></span><span style=display:flex><span>[SYS_kill]    sys_kill,
</span></span><span style=display:flex><span>[SYS_exec]    sys_exec,
</span></span><span style=display:flex><span>[SYS_fstat]   sys_fstat,
</span></span><span style=display:flex><span>[SYS_chdir]   sys_chdir,
</span></span><span style=display:flex><span>[SYS_dup]     sys_dup,
</span></span><span style=display:flex><span>[SYS_getpid]  sys_getpid,
</span></span><span style=display:flex><span>[SYS_sbrk]    sys_sbrk,
</span></span><span style=display:flex><span>[SYS_sleep]   sys_sleep,
</span></span><span style=display:flex><span>[SYS_uptime]  sys_uptime,
</span></span><span style=display:flex><span>[SYS_open]    sys_open,
</span></span><span style=display:flex><span>[SYS_write]   sys_write,
</span></span><span style=display:flex><span>[SYS_mknod]   sys_mknod,
</span></span><span style=display:flex><span>[SYS_unlink]  sys_unlink,
</span></span><span style=display:flex><span>[SYS_link]    sys_link,
</span></span><span style=display:flex><span>[SYS_mkdir]   sys_mkdir,
</span></span><span style=display:flex><span>[SYS_close]   sys_close,
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>å…¶å®å°±æ˜¯çœ‹ä¸æ‡‚ <code>uint64 (*syscalls[])(void)</code> çš„æ„æ€ï¼Œå‚è€ƒä¹‹å‰çŸ¥ä¹ä¸Šçœ‹åˆ°çš„ä¸€ä¸ªå›ç­”ï¼ŒæŠŠè¿™ä¸ªä¸œè¥¿ç¿»è¯‘æˆè‹±æ–‡ï¼š
an array of pointers to a function that returns uint64ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆçš„æ•°ç»„ï¼Œè¿™ä¸ªåˆå§‹åŒ–çš„æ–¹å¼ä¹Ÿç¡®å®ç»™æˆ‘æ•´éº»äº†ï¼Œä½†æ— æ‰€è°“çœ‹æ‡‚äº†å°±è¡Œï¼Œä¸çº ç»“è¯­æ³•ã€‚</p><p>å…¶å®è¿˜æœ‰ä¸€ä¸ªç»ˆæé—®é¢˜ï¼šå½“è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼ŒçœŸæ­£çš„æµç¨‹åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿå¾ˆé—æ†¾è¿™å¯èƒ½éœ€è¦ç”¨ gdb ç›®åŠ›è°ƒè¯•æ‰èƒ½çŸ¥é“ï¼Œä½†å…¶å®åœ¨ä¸çŸ¥é“è¿™ä¸ªäº‹æƒ…çš„æµç¨‹ä¸‹ä¹Ÿèƒ½å¤Ÿå®Œæˆè¿™ä¸ªå®éªŒï¼Œåªéœ€è¦è§‚å¯Ÿä¸€ä¸‹ <code>sys_exit</code> çš„ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>uint64
</span></span><span style=display:flex><span><span style=color:#00a000>sys_exit</span>(<span style=color:#0b0;font-weight:700>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#0b0;font-weight:700>int</span> n;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span>(<span style=color:#00a000>argint</span>(<span style=color:#666>0</span>, <span style=color:#666>&amp;</span>n) <span style=color:#666>&lt;</span> <span style=color:#666>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>-</span><span style=color:#666>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#00a000>exit</span>(n);
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>0</span>;  <span style=color:#080;font-style:italic>// not reached
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>}
</span></span></code></pre></div><p>å®ƒè°ƒç”¨äº† <code>argint(0, &n)</code> æ¥è·å–äº†è¿›ç¨‹é€€å‡ºæ—¶çš„çŠ¶æ€å·ï¼Œå†çœ‹åˆ° <code>syscall.c</code> ä¸­å¯¹äº <code>argint</code> å‡½æ•°çš„æ³¨é‡Šï¼š<code>// Fetch the nth 32-bit system call argument.</code> å°±å¯ä»¥çŸ¥é“è¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥è·å–ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°çš„ï¼Œé‚£ç›´æ¥å…ˆæ‹¿æ¥ç”¨å°±å¥½äº†ï¼ˆæ‹¿æ¥ä¸»ä¹‰ï¼‰ã€‚</p><p>æœ€ç»ˆå¢åŠ çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼šï¼ˆè¿˜æœ‰ä¸€äº›æ‚ä¸ƒæ‚å…«çš„ä¸œè¥¿è¦åŠ ï¼Œæ¯”å¦‚ç³»ç»Ÿè°ƒç”¨çš„æ‰“å°ï¼‰</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>uint64
</span></span><span style=display:flex><span><span style=color:#00a000>sys_trace</span>(<span style=color:#0b0;font-weight:700>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  uint mask;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span>(<span style=color:#00a000>argint</span>(<span style=color:#666>0</span>, (<span style=color:#0b0;font-weight:700>int</span> <span style=color:#666>*</span>)<span style=color:#666>&amp;</span>mask) <span style=color:#666>&lt;</span> <span style=color:#666>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>-</span><span style=color:#666>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#00a000>myproc</span>()<span style=color:#666>-&gt;</span>trace_mask <span style=color:#666>=</span> mask;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=risc-v-ç³»ç»Ÿè°ƒç”¨çš„ä¸€äº›è§„åˆ™æ‘˜å½•>RISC-V ç³»ç»Ÿè°ƒç”¨çš„ä¸€äº›è§„åˆ™æ‘˜å½• <a href=#risc-v-%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e7%9a%84%e4%b8%80%e4%ba%9b%e8%a7%84%e5%88%99%e6%91%98%e5%bd%95 class=anchor>ğŸ”—</a></h3><ul><li>syscall number is passed in <code>a7</code></li><li>syscall arguments are passed in <code>a0</code> to <code>a5</code></li><li>unused arguments are set to <code>0</code></li><li>return value is returned in <code>a0</code></li></ul><h3 id=sysinfo-system-call>Sysinfo system call <a href=#sysinfo-system-call class=anchor>ğŸ”—</a></h3><p>å·®ä¸å¤šå’Œå‰é¢çš„ system call ä¸€æ ·ï¼Œéœ€è¦æŠŠä¸€äº›ä¿¡æ¯æ‹·è´åˆ° user ç©ºé—´ï¼Œè¦ç”¨åˆ° <code>copyout()</code> å‡½æ•°ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#080;font-style:italic>// Copy from kernel to user.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>// Copy len bytes from src to virtual address dstva in a given page table.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>// Return 0 on success, -1 on error.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#0b0;font-weight:700>int</span>
</span></span><span style=display:flex><span><span style=color:#00a000>copyout</span>(<span style=color:#0b0;font-weight:700>pagetable_t</span> pagetable, uint64 dstva, <span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>*</span>src, uint64 len)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  uint64 n, va0, pa0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>while</span>(len <span style=color:#666>&gt;</span> <span style=color:#666>0</span>){
</span></span><span style=display:flex><span>    va0 <span style=color:#666>=</span> <span style=color:#00a000>PGROUNDDOWN</span>(dstva);
</span></span><span style=display:flex><span>    pa0 <span style=color:#666>=</span> <span style=color:#00a000>walkaddr</span>(pagetable, va0);
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>if</span>(pa0 <span style=color:#666>==</span> <span style=color:#666>0</span>)
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>-</span><span style=color:#666>1</span>;
</span></span><span style=display:flex><span>    n <span style=color:#666>=</span> PGSIZE <span style=color:#666>-</span> (dstva <span style=color:#666>-</span> va0);
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>if</span>(n <span style=color:#666>&gt;</span> len)
</span></span><span style=display:flex><span>      n <span style=color:#666>=</span> len;
</span></span><span style=display:flex><span>    <span style=color:#00a000>memmove</span>((<span style=color:#0b0;font-weight:700>void</span> <span style=color:#666>*</span>)(pa0 <span style=color:#666>+</span> (dstva <span style=color:#666>-</span> va0)), src, n);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    len <span style=color:#666>-=</span> n;
</span></span><span style=display:flex><span>    src <span style=color:#666>+=</span> n;
</span></span><span style=display:flex><span>    dstva <span style=color:#666>=</span> va0 <span style=color:#666>+</span> PGSIZE;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥æ‹¿åˆ°å½“å‰è¿›ç¨‹çš„ pagetableï¼Œç„¶åè™šæ‹Ÿåœ°å€å…¶å®å°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå…¶ä»–çš„ç›´æ¥ä¼ è¿›å»ç”¨å°±å¥½äº†ã€‚</p><p>è‡³äºæ´»è·ƒè¿›ç¨‹æ•°é‡å’Œç©ºé—²å†…å­˜æ•°ï¼š</p><ul><li>xv6 ä¸­çš„è¿›ç¨‹æ¯”è¾ƒç®€å•ï¼Œæ˜¯ä¸€ä¸ªå›ºå®šçš„æ•°ç»„ï¼ˆ64ä¸ªï¼‰ã€‚éå†ä¸€éï¼Œå‰”é™¤ <code>UNUSED</code> çš„æ•°é‡å°±å¥½äº†ï¼›</li><li>å…ˆè·å–ç©ºé—²çš„é¡µæ•°ï¼Œç„¶åä¹˜ä»¥ 4K å°±å¯ä»¥å¾—åˆ°ç©ºé—²å­—èŠ‚æ•°ã€‚</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>uint64
</span></span><span style=display:flex><span><span style=color:#00a000>sys_sysinfo</span>(<span style=color:#0b0;font-weight:700>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>// printf(&#34;hello\n&#34;);
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  <span style=color:#a2f;font-weight:700>struct</span> sysinfo info;
</span></span><span style=display:flex><span>  uint64 user_addr;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>struct</span> proc <span style=color:#666>*</span>p <span style=color:#666>=</span> <span style=color:#00a000>myproc</span>();
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span>(<span style=color:#00a000>argaddr</span>(<span style=color:#666>0</span>, <span style=color:#666>&amp;</span>user_addr) <span style=color:#666>&lt;</span> <span style=color:#666>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>-</span><span style=color:#666>1</span>;
</span></span><span style=display:flex><span>  info.freemem <span style=color:#666>=</span> <span style=color:#00a000>free_memory_number</span>();
</span></span><span style=display:flex><span>  info.nproc <span style=color:#666>=</span> <span style=color:#00a000>process_number</span>();
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span>(<span style=color:#00a000>copyout</span>(p<span style=color:#666>-&gt;</span>pagetable, user_addr, (<span style=color:#0b0;font-weight:700>char</span><span style=color:#666>*</span>)<span style=color:#666>&amp;</span>info, <span style=color:#a2f;font-weight:700>sizeof</span>(<span style=color:#a2f;font-weight:700>struct</span> sysinfo))<span style=color:#666>&lt;</span><span style=color:#666>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>-</span><span style=color:#666>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=page-table>Page table <a href=#page-table class=anchor>ğŸ”—</a></h2><h3 id=æ¯ä¸ªè¿›ç¨‹çš„-kernel-page-table>æ¯ä¸ªè¿›ç¨‹çš„ kernel page table <a href=#%e6%af%8f%e4%b8%aa%e8%bf%9b%e7%a8%8b%e7%9a%84-kernel-page-table class=anchor>ğŸ”—</a></h3><p>è¯´å®è¯ï¼Œåšåˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ï¼Œæˆ‘å¾ˆè«åå…¶å¦™ä¸ºä»€ä¹ˆè¦å»ä¿®æ”¹å†…æ ¸çš„è¿™ä¸ªæœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ã€Œå†…æ ¸æ‹¥æœ‰ä¸€ä¸ªè‡ªå·±çš„é¡µè¡¨ã€æœºåˆ¶ã€‚</p><p>è¯»äº†ä¸€ä¸‹ xv6 çš„ rec-bookï¼Œè¿™ä¸ª lab çš„æ„æ€å¤§è‡´å°±æ˜¯å› ä¸º xv6 çš„å†…æ ¸é‡‡ç”¨çš„æ˜¯ direct-mapping æœºåˆ¶ï¼Œæ‰€ä»¥å¯ä»¥è®©ã€Œå†…æ ¸æ‹¥æœ‰ä¸€ä¸ªè‡ªå·±çš„é¡µè¡¨ã€ï¼Œä½†è¿™æ ·çš„è¯åœ¨è¿è¡Œå†…æ ¸ä»£ç çš„æ—¶å€™ï¼Œå°±è¦ç”¨ä¸€ä¸ªã€Œè½¬æ¢æœºåˆ¶ã€æ¥è®¿é—®ç”¨æˆ·çš„æ•°æ®ï¼Œæ¥ä¸‹æ¥å‡ ä¸ªäº‹æƒ…å°±æ˜¯ä¸ºäº†æ”¹å˜è¿™ä¸ªäº‹æƒ…ï¼Œè‡³äºæ”¹äº†ä¹‹ååˆ°åº•æœ‰ä»€ä¹ˆå¥½å¤„ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œåšäº†å†è¯´ã€‚</p><p>å¤§è‡´çš„æ€è·¯æ˜¯è¿™æ ·ï¼š</p><ul><li>é¦–å…ˆæ˜¯éœ€è¦ç»™æ¯ä¸ª process ç»´æŠ¤ä¸€ä¸ª kernel_pagetable åŸŸã€‚</li><li>éœ€è¦ç»™æ¯ä¸ª process åˆ›å»ºæ—¶ï¼ˆä¹Ÿå°±æ˜¯åœ¨å‡½æ•° <code>allocproc</code> ä¸­ï¼‰å¡«å……è¿™ä¸ª process çš„ kernel_pagetable ï¼Œç›®å‰æ¥è¯´æ¯ä¸ªè¿›ç¨‹çš„å†…æ ¸é¡µè¡¨æ˜¯å’Œå†…æ ¸ç‹¬æœ‰çš„é¡µè¡¨æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚</li><li>é™¤äº†ä¸Šé¢å’Œå†…æ ¸ç‹¬æœ‰é¡µè¡¨çš„å†…å®¹ä¸€æ ·ä»¥å¤–ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½è¦åœ¨è‡ªå·±çš„é¡µè¡¨é‡Œå†å¢åŠ è‡ªå·±çš„å†…æ ¸ stack æ˜ å°„ã€‚è€Œè¿™ä¸ªæ˜ å°„åŸæœ¬åœ¨æœªä¿®æ”¹çš„ xv6 ä¸­æ˜¯ç”±å†…æ ¸æå‰ä¸ºæ‰€æœ‰çš„é¢„å¤‡è¿›ç¨‹åšå¥½çš„ï¼ˆ <code>procinit</code> å‡½æ•°ï¼‰ï¼Œç°åœ¨éœ€è¦æŠŠè¿™ä¸ªäº‹æƒ…å»¶è¿Ÿåˆ°åœ¨æ¯ä¸ªè¿›ç¨‹è¢«åˆ›å»ºçš„æ—¶å€™å†åšã€‚</li><li>åœ¨è°ƒåº¦å‡½æ•°ä¸­ç¡®ä¿åœ¨åˆ‡æ¢åˆ°æŸä¸ªè¿›ç¨‹çš„ä¹‹å‰ï¼Œä½¿ç”¨è¯¥è¿›ç¨‹çš„å†…æ ¸é¡µè¡¨ï¼ˆä¹Ÿå°±æ˜¯åœ¨ <code>swtch(&c->context, &p->context)</code> ä¹‹å‰ï¼‰ï¼Œåœ¨é‡æ–°å›åˆ°è°ƒåº¦ç¨‹åºåï¼Œå†åˆ‡æ¢å›å†…æ ¸è‡ªå·±çš„é¡µè¡¨ã€‚</li><li>åœ¨è¿›ç¨‹è¢« free çš„æ—¶å€™ï¼Œé¡ºä¾¿æŠŠ kernel_pagetable ä¹Ÿåˆ äº†ï¼Œä½†ä¸ç”¨åˆ é™¤é¡µè¡¨çš„å¶ç»“ç‚¹ï¼Œåªéœ€è¦åˆ å‰ä¸¤å±‚çš„ç´¢å¼•ã€‚</li></ul><p>åœ¨å·®ä¸å¤šåšå®Œè¿™äº›äº‹æƒ…åï¼Œè¿˜é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚</p><ol><li>æ”¹å®Œä¹‹å <code>make qemu</code> ç›´æ¥æŠ¥ <code>panic: kvmpa</code> ã€‚</li></ol><p><code>kvmpa</code> å‡½æ•°çš„ç”¨å¤„æ˜¯ã€Œå°†å†…æ ¸çš„ä¸€ä¸ªè™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºä¸€ä¸ªç‰©ç†åœ°å€ã€ï¼Œè€Œ xv6 çš„å†…æ ¸åœ°å€å¤§å¤šéƒ½æ˜¯ direct-mapping çš„ï¼Œæ¢è¨€ä¹‹å…¶å®å°±æ˜¯è½¬æ¢å†…æ ¸æ ˆçš„åœ°å€è€Œå·²ï¼Œè€Œåœ¨æ”¹å®Œä¹‹åï¼Œè¿›ç¨‹çš„å†…æ ¸æ ˆçš„åœ°å€å·²ç»ä¸å±äºå†…æ ¸çš„é¡µè¡¨äº†ï¼Œè€Œå±äºæ¯ä¸ªè¿›ç¨‹è‡ªå·±çš„å†…æ ¸é¡µè¡¨ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹ <code>pte = walk(kernel_pagetable, va, 0)</code> ä¸º <code>pte = walk(myproc()->kernel_pagetable, va, 0)</code> ã€‚ï¼ˆè°ƒç”¨ <code>myproc()</code> éœ€è¦åŠ ä¸¤ä¸ªå¤´æ–‡ä»¶ï¼‰</p><ol start=2><li>è¿›ç¨‹å†…æ ¸æ ˆçš„å†…å­˜æ³„æ¼é—®é¢˜</li></ol><p>è¦æ³¨æ„ï¼Œæ¯ä¸ªè¿›ç¨‹è¢« free çš„æ—¶å€™ï¼Œå³ä½¿ä¸ç”¨é‡Šæ”¾è¿›ç¨‹å†…æ ¸é¡µè¡¨ç»å¤§å¤šæ•°çš„å¶å­ page ï¼Œä½†æ˜¯è¿›ç¨‹å†…æ ¸æ ˆçš„ page æ˜¯å¿…é¡»è¦é‡Šæ”¾çš„ï¼Œä¸ç„¶è·‘ usertests çš„æ—¶å€™ä¼šåœ¨ sbrkfail å¤„æŠ¥ kvmmap çš„ panic ï¼Œæˆ‘æ²¡æœ‰ç”¨ gdb å»è°ƒè¯•å‡ºåˆ°åº•å‡ºäº†ä»€ä¹ˆå·®é”™ã€‚ä½†åœ¨æˆ‘æ·»åŠ äº†å¯¹å†…æ ¸æ ˆçš„æ‰‹åŠ¨é‡Šæ”¾åï¼Œå°±ä¸æŠ¥é”™äº†ï¼Œæ‰€ä»¥å¾ˆå¤§å¯èƒ½çš„åŸå› å°±æ˜¯å†…å­˜æ³„æ¼äº†ï¼Œæ¯å½“åˆ›å»ºä¸€ä¸ªè¿›ç¨‹å°±æµªè´¹æ‰ 1 ä¸ª pageï¼Œfree çš„æ—¶å€™åˆä¸å›æ”¶ï¼Œæœ€åå°±å¯¼è‡´å†…å­˜ç”¨å°½æ²¡å¾—ç”¨äº†ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span>(p<span style=color:#666>-&gt;</span>kstack)
</span></span><span style=display:flex><span>    <span style=color:#00a000>uvmunmap</span>(p<span style=color:#666>-&gt;</span>kernel_pagetable, p<span style=color:#666>-&gt;</span>kstack, <span style=color:#666>1</span>, <span style=color:#666>1</span>); 
</span></span><span style=display:flex><span>  p<span style=color:#666>-&gt;</span>kstack <span style=color:#666>=</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span>(p<span style=color:#666>-&gt;</span>kernel_pagetable)
</span></span><span style=display:flex><span>    <span style=color:#00a000>proc_freekernelpagetable</span>(p<span style=color:#666>-&gt;</span>kernel_pagetable);
</span></span><span style=display:flex><span>  p<span style=color:#666>-&gt;</span>kernel_pagetable <span style=color:#666>=</span> <span style=color:#666>0</span>;
</span></span></code></pre></div><h2 id=trap>Trap <a href=#trap class=anchor>ğŸ”—</a></h2><p>ä¸€äº›å…³é”®çš„å¯„å­˜å™¨ï¼š</p><ul><li><code>stvec</code> ç”¨äºå­˜å‚¨ trap handler çš„åœ°å€ï¼Œç”±å†…æ ¸å†™å…¥</li><li><code>sepc</code> æ¥ä¿å­˜è¿›å…¥ trap å‰çš„ <code>pc</code></li><li><code>scause</code> ä¿å­˜ trap çš„åŸå› </li><li><code>sccratch</code> åœ¨è°ƒç”¨ trap handler çš„æ—¶å€™ä¼šç”¨åˆ°è¿™ä¸ªå¯„å­˜å™¨</li><li><code>sstatus</code> ä¸­çš„ SIE ä½è¡¨ç¤ºæ˜¯å¦é˜»å¡è®¾å¤‡ä¸­æ–­ï¼ŒSPP ä½è¡¨ç¤º trap æ¥è‡ªäºç”¨æˆ·æ€è¿˜æ˜¯å†…æ ¸æ€</li></ul><p>å½“ RISC-V CPU è¦å¼€å§‹ä¸€ä¸ª trap çš„æ—¶å€™ä¾æ¬¡åšå¦‚ä¸‹çš„äº‹æƒ…ï¼š</p><ol><li>å¦‚æœæ˜¯ä¸€ä¸ªè®¾å¤‡ç»ˆç«¯ä¸” <code>sstatus</code> ä¸­çš„ SIE ä½æ˜¯ç©ºçš„ï¼Œå°±ä¸å¾€ä¸‹èµ°äº†ï¼›</li><li>æ¸…æ¥š SIE ä½ï¼ˆä¿è¯åŸå­æ€§ï¼‰ï¼›</li><li>å°†å½“å‰çš„ <code>pc</code> å¤åˆ¶åˆ° <code>sepc</code> ï¼›</li><li>å°†å½“å‰çš„ mode å¤åˆ¶åˆ° <code>sstatus</code> çš„ SPP ä½ï¼›</li><li>è®¾ç½® <code>scause</code>ï¼›</li><li>å°† mode è®¾ç½®ä¸º supervisor modeï¼›</li><li>å°† <code>stvec</code> å¤åˆ¶åˆ° <code>pc</code> ï¼›</li><li>go on è¿è¡ŒæŒ‡ä»¤ã€‚</li></ol><h3 id=user-mode-ä¸‹çš„-trap>User mode ä¸‹çš„ trap <a href=#user-mode-%e4%b8%8b%e7%9a%84-trap class=anchor>ğŸ”—</a></h3><p>æµç¨‹æ˜¯</p><ol><li><code>trampoline.S</code> ä¸­çš„ <code>uservec</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¢« <code>stvec</code> æ‰€æŒ‡</li><li>è½¬åˆ° <code>trap.c</code> ä¸­çš„ <code>usertrap</code> å‡½æ•°</li><li>trap ç»“æŸåè½¬åˆ° <code>trap.c</code> ä¸­çš„ <code>usertrapret</code> å‡½æ•°</li><li>ç„¶åè½¬åˆ° <code>trampoline.S</code> ä¸­çš„ <code>userret</code> å‡½æ•°</li></ol><p>é¦–å…ˆï¼Œç¡¬ä»¶å¹¶ä¸ä¼šåœ¨å‘ç”Ÿ trap æ—¶åˆ‡æ¢é¡µè¡¨ï¼Œå› æ­¤ç”¨æˆ·çš„é¡µè¡¨éœ€è¦å­˜åœ¨ä¸€ä¸ªè™šæ‹Ÿåœ°å€æ˜ å°„åˆ° <code>uservec</code> ï¼›åŒæ—¶ <code>uservec</code> å‡½æ•°å¿…é¡»æ˜¾ç¤ºå°† <code>satp</code> åˆ‡æ¢åˆ°å†…æ ¸çš„é¡µè¡¨ï¼ˆä¸ç„¶ä¸èƒ½ç›´æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼‰ã€‚xv6 ç”¨äº†ä¸€ä¸ª <code>TRAMPOLINE</code> çš„è™šæ‹Ÿåœ°å€å’Œ <code>trampoline</code> é¡µæ¥æ˜ å°„ <code>trampoline.S</code> çš„ä»£ç ï¼Œå¹¶ä¸”ä¸ç®¡æ˜¯ç”¨æˆ·ç©ºé—´è¿˜æ˜¯å†…æ ¸ç©ºé—´ï¼Œè™šæ‹Ÿåœ°å€éƒ½æ˜¯ä¸€æ ·çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ trap å‘ç”Ÿæ—¶ï¼Œé¦–å…ˆä» <code>stvec</code> ä¸­è¯»åˆ° <code>uservec</code> çš„è™šæ‹Ÿåœ°å€ï¼Œä¹Ÿå°±æ˜¯ <code>TRAMPOLINE</code> ç„¶åç»è¿‡é¡µè¡¨æ˜ å°„åˆ° <code>trampoline</code> ã€‚</p><h4 id=trampolines-çš„éƒ¨åˆ†ä»£ç ><code>trampoline.S</code> çš„éƒ¨åˆ†ä»£ç ï¼š <a href=#trampolines-%e7%9a%84%e9%83%a8%e5%88%86%e4%bb%a3%e7%a0%81 class=anchor>ğŸ”—</a></h4><p>Xv6 è¿˜å¼€è¾Ÿäº†å¦å¤–ä¸€ä¸ª page ï¼ˆå°±åœ¨ <code>trampoline</code> ä¸‹é¢ï¼‰ç”¨æ¥ä¿å­˜å‘ç”Ÿ trap æ—¶è¢«æ‰“æ–­çš„æŒ‡ä»¤çš„å¯„å­˜å™¨å€¼ï¼Œè¿™ä¸ª page å«åš <code>trapframe</code> ã€‚ä¸€å¼€å§‹ï¼Œå¯„å­˜å™¨ <code>sscratch</code> ä¿å­˜ç€æ˜ å°„åˆ° <code>trapframe</code> é¡µçš„<strong>è™šæ‹Ÿåœ°å€</strong>ï¼Œä¹Ÿå°±æ˜¯ <code>TRAPFRAME</code> ã€‚ï¼ˆæƒ³æƒ³è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯è™šæ‹Ÿåœ°å€è€Œä¸æ˜¯ç‰©ç†åœ°å€ï¼Œå› ä¸ºè¿è¡Œåˆ°è¿™çš„æ—¶å€™ä»ç„¶æ²¡æœ‰åˆ‡æ¢é¡µè¡¨ï¼Œæ‰€ä»¥ç”¨æˆ·ç©ºé—´é¡µè¡¨ä¹Ÿéœ€è¦ä¿è¯å¥½ <code>TRAPFRAME</code> çš„æ˜ å°„ï¼‰</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>				csrrw a0, sscratch, a0
</span></span></code></pre></div><p>è¿™ä¸ªæ—¶å€™ï¼Œ<code>a0</code> çš„å€¼å’Œ <code>sscratch</code> å°±è¢«äº¤æ¢äº†ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>				sd ra, 40(a0)
</span></span><span style=display:flex><span>        sd sp, 48(a0)
</span></span><span style=display:flex><span>        sd gp, 56(a0)
</span></span><span style=display:flex><span>        sd tp, 64(a0)
</span></span><span style=display:flex><span>        sd t0, 72(a0)
</span></span><span style=display:flex><span>        sd t1, 80(a0)
</span></span><span style=display:flex><span>        sd t2, 88(a0)
</span></span><span style=display:flex><span>        sd s0, 96(a0)
</span></span><span style=display:flex><span>        sd s1, 104(a0)
</span></span><span style=display:flex><span>        sd a1, 120(a0)
</span></span><span style=display:flex><span>        sd a2, 128(a0)
</span></span><span style=display:flex><span>        sd a3, 136(a0)
</span></span><span style=display:flex><span>        sd a4, 144(a0)
</span></span><span style=display:flex><span>        sd a5, 152(a0)
</span></span><span style=display:flex><span>        sd a6, 160(a0)
</span></span><span style=display:flex><span>        sd a7, 168(a0)
</span></span><span style=display:flex><span>        sd s2, 176(a0)
</span></span><span style=display:flex><span>        sd s3, 184(a0)
</span></span><span style=display:flex><span>        sd s4, 192(a0)
</span></span><span style=display:flex><span>        sd s5, 200(a0)
</span></span><span style=display:flex><span>        sd s6, 208(a0)
</span></span><span style=display:flex><span>        sd s7, 216(a0)
</span></span><span style=display:flex><span>        sd s8, 224(a0)
</span></span><span style=display:flex><span>        sd s9, 232(a0)
</span></span><span style=display:flex><span>        sd s10, 240(a0)
</span></span><span style=display:flex><span>        sd s11, 248(a0)
</span></span><span style=display:flex><span>        sd t3, 256(a0)
</span></span><span style=display:flex><span>        sd t4, 264(a0)
</span></span><span style=display:flex><span>        sd t5, 272(a0)
</span></span><span style=display:flex><span>        sd t6, 280(a0)
</span></span></code></pre></div><p>è¿™é‡ŒæŠŠé™¤äº† <code>a0</code> ä»¥å¤–çš„å¯„å­˜å™¨éƒ½ä¿å­˜åˆ°äº† <code>trapframe</code> ä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>        csrr t0, sscratch
</span></span><span style=display:flex><span>        sd t0, 112(a0)
</span></span></code></pre></div><p>è¿™é‡ŒæŠŠ <code>a0</code> ä¹Ÿä¿å­˜åˆ°äº† <code>trapframe</code> ä¸­ã€‚</p><p>è€Œæ³¨æ„åˆ°ï¼Œè¿™é‡Œçš„æŒ‡ä»¤æ˜¯ä» <code>40(a0)</code> å¼€å§‹çš„ï¼Œè¯´æ˜ <code>trapframe</code> é‡Œé¢åŸæœ¬è¿˜å­˜äº† 5 ä¸ªå€¼ï¼Œå…¶ä¸­åŒ…æ‹¬äº†<strong>å†…æ ¸çš„é¡µè¡¨</strong>ã€<strong>è¿›ç¨‹çš„å†…æ ¸æ ˆ</strong>ã€<strong><code>usertrap()</code></strong> çš„åœ°å€å’Œå½“å‰ CPU çš„ <code>hartid</code> ã€‚ä¸ºä»€ä¹ˆè¿˜ç¼ºä¸€ä¸ªå‘¢ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ç¼ºäº†ä»€ä¹ˆï¼Œåæ­£ä»£ç é‡Œçœ‹ä¸å‡ºæ¥ã€‚ä¸ºäº†è¿›å…¥ <code>usertrap()</code> ï¼Œéœ€è¦æ¢å¤è¿™äº›å€¼ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>        # restore kernel stack pointer from p-&gt;trapframe-&gt;kernel_sp
</span></span><span style=display:flex><span>        ld sp, 8(a0)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        # make tp hold the current hartid, from p-&gt;trapframe-&gt;kernel_hartid
</span></span><span style=display:flex><span>        ld tp, 32(a0)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        # load the address of usertrap(), p-&gt;trapframe-&gt;kernel_trap
</span></span><span style=display:flex><span>        ld t0, 16(a0)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        # restore kernel page table from p-&gt;trapframe-&gt;kernel_satp
</span></span><span style=display:flex><span>        ld t1, 0(a0)
</span></span><span style=display:flex><span>        csrw satp, t1
</span></span><span style=display:flex><span>        sfence.vma zero, zero
</span></span></code></pre></div><p>æ³¨æ„åˆ°ï¼Œè¿è¡Œå®Œæœ€åçš„æŒ‡ä»¤ï¼ˆä¹Ÿå°±æ˜¯åˆ‡æ¢åˆ°å†…æ ¸é¡µè¡¨ï¼‰åï¼Œ<code>a0</code> ä¸­ä¿å­˜çš„ <code>TRAPFRAME</code> è™šæ‹Ÿåœ°å€å·²ç»å¤±æ•ˆäº†ã€‚</p><p>æœ€åï¼Œè·³è½¬åˆ° <code>usertrap()</code>ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>        jr t0
</span></span></code></pre></div><p>è¯»åˆ°è¿™é‡Œï¼Œæˆ‘ä»ç„¶æœ‰äº›è®¸çš„ç–‘é—®ï¼Œå› ä¸º xv6 çš„æ–‡æ¡£ä¸Šè¯´å…¶å®ç”¨æˆ·ç©ºé—´æ¶‰åŠåˆ°äº† 32 ä¸ªå¯„å­˜å™¨ï¼Œä½†è¿™é‡Œå…¶å®åªä¿å­˜äº† 31 ä¸ªå¯„å­˜å™¨ï¼Œæˆ‘çš„ç–‘æƒ‘æ˜¯ç¼ºäº†å“ªä¸€ä¸ªï¼Ÿ</p><h4 id=è¿›å…¥-usertrap-å>è¿›å…¥ <code>usertrap()</code> å <a href=#%e8%bf%9b%e5%85%a5-usertrap-%e5%90%8e class=anchor>ğŸ”—</a></h4><p>é¦–å…ˆï¼ŒéªŒè¯æ˜¯ä¸æ˜¯ä» user mode æ¥çš„ï¼Œç„¶åä¿®æ”¹äº† <code>stvec</code> çš„å€¼ï¼ˆä¸ºä»€ä¹ˆï¼Ÿï¼‰ã€‚å› ä¸ºå¦‚æœè¿™ä¸ªæ—¶å€™å†æ¬¡å‘ç”Ÿä¸€äº› trap ï¼Œå°±éœ€è¦å†…æ ¸çš„ handler æ¥è§£å†³äº†ï¼Œæ‰€ä»¥å°†è¿™ä¸ªå…¥å£æ”¹ä¸ºäº†å†…æ ¸çš„ handler çš„å‡½æ•°åœ°å€ã€‚ç„¶åæ ¹æ® trap çš„æˆå› ï¼ˆ<code>scause</code> å¯„å­˜å™¨ï¼‰æ¥å†³å®šæ˜¯ç³»ç»Ÿè°ƒç”¨ã€è®¾å¤‡ä¸­æ–­è¿˜æ˜¯ä¸€ä¸ªå•çº¯çš„å¼‚å¸¸ï¼Œåšå®Œè¿™äº›äº‹æƒ…åè°ƒç”¨ <code>usertrapret()</code> ã€‚</p><h4 id=usertrapret-å¹²äº†ä»€ä¹ˆ><code>usertrapret()</code> å¹²äº†ä»€ä¹ˆ <a href=#usertrapret-%e5%b9%b2%e4%ba%86%e4%bb%80%e4%b9%88 class=anchor>ğŸ”—</a></h4><p>é¦–å…ˆï¼Œå…³é—­äº†ä¸­æ–­ï¼ˆä¿è¯ä¸è¢«æ‰“æ–­ï¼‰ã€‚</p><p>ç„¶åé‡æ–°è®¾ç½®äº† <code>stvec</code> çš„å€¼ï¼Œè®©å®ƒé‡æ–°æŒ‡å‘ <code>TRAPOLINE</code> ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#00a000>w_stvec</span>(TRAMPOLINE <span style=color:#666>+</span> (uservec <span style=color:#666>-</span> trampoline));
</span></span></code></pre></div><p>å†é‡æ–°è®¾ç½® <code>trapframe</code> ä¸­çš„ä¸€äº›å€¼ï¼ŒåŒ…æ‹¬ <code>satp</code> ï¼ˆè¿™æ˜¯é¡µè¡¨ï¼‰ã€å†…æ ¸æ ˆæŒ‡é’ˆç­‰ã€‚</p><blockquote><p>æˆ‘è¿™é‡Œå…¶å®æ²¡æœ‰æ˜ç™½ä¸ºä»€ä¹ˆè¦é‡æ–°è®¾ç½®ï¼Œä¹‹å‰çš„è¡Œä¸ºä¼šä¿®æ”¹è¿™äº›å€¼å—ï¼Ÿå› ä¸ºæˆ‘åªçœ‹åˆ°ä» <code>trapframe</code> ä¸­è¯»å–è¿™äº›å€¼ã€‚</p></blockquote><p>å†è®¾ç½®å¥½ <code>sepc</code> åï¼ˆä»ä¹‹å‰ä¿å­˜çš„ <code>trapframe</code> ä¸­ï¼‰ï¼Œå°±è°ƒç”¨ <code>userret</code> å‡½æ•°ã€‚è¿™é‡Œä¹Ÿå€¼å¾—æ€è€ƒçš„æ˜¯ï¼Œ<code>userret</code> å‡½æ•°æ˜¯åœ¨ <code>trampoline</code> é¡µé‡Œçš„ï¼Œè¿™ä¸ªæ—¶å€™ä»ç„¶æ˜¯å†…æ ¸é¡µè¡¨ï¼Œå› æ­¤å¯¹äº <code>TRAMPOLINE</code> è™šæ‹Ÿåœ°å€çš„æ˜ å°„æ˜¯ç”¨æˆ·é¡µè¡¨å’Œå†…æ ¸é¡µè¡¨éƒ½åšäº†çš„ï¼Œè€Œ <code>TRAPFRAME</code> çš„æ˜ å°„åªæœ‰ç”¨æˆ·é¡µè¡¨ã€‚</p><h4 id=userret><code>userret()</code> <a href=#userret class=anchor>ğŸ”—</a></h4><p>åœ¨è¿›å…¥è¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œ<code>usertrapret()</code> å‡½æ•°ä¼ äº†ä¸¤ä¸ªå‚æ•°ï¼šå½“å‰è¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´é¡µè¡¨å’Œè™šæ‹Ÿåœ°å€ <code>TRAPFRAME</code> ï¼ŒC ä»£ç å¦‚ä¸‹ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>  <span style=color:#080;font-style:italic>// tell trampoline.S the user page table to switch to.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  uint64 satp <span style=color:#666>=</span> <span style=color:#00a000>MAKE_SATP</span>(p<span style=color:#666>-&gt;</span>pagetable);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>// jump to trampoline.S at the top of memory, which 
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  <span style=color:#080;font-style:italic>// switches to the user page table, restores user registers,
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  <span style=color:#080;font-style:italic>// and switches to user mode with sret.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  uint64 fn <span style=color:#666>=</span> TRAMPOLINE <span style=color:#666>+</span> (userret <span style=color:#666>-</span> trampoline);
</span></span><span style=display:flex><span>  ((<span style=color:#0b0;font-weight:700>void</span> (<span style=color:#666>*</span>)(uint64,uint64))fn)(TRAPFRAME, satp);
</span></span></code></pre></div><p>è¿›å…¥ä¹‹åï¼Œé¦–å…ˆå½“ç„¶æ˜¯åˆ‡æ¢é¡µè¡¨ï¼ˆå› ä¸ºæ‰€æœ‰æœ‰ç”¨çš„ä¸œè¥¿éƒ½åœ¨ç”¨æˆ·é¡µè¡¨æ‰èƒ½ç¿»è¯‘çš„åœ°å€é‡Œï¼‰ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>        # switch to the user page table.
</span></span><span style=display:flex><span>        csrw satp, a1
</span></span><span style=display:flex><span>        sfence.vma zero, zero
</span></span></code></pre></div><p>ç„¶åæŠŠæ‰€æœ‰çš„å¯„å­˜å™¨éƒ½è¿˜åŸï¼Œè¿™é‡Œç”¨åˆ°äº† <code>sscratch</code> è¿™ä¸ªå¯„å­˜å™¨ï¼Œä½¿å¾—ä¸€ç³»åˆ—æ“ä½œå®Œæˆä¹‹å <code>sscratch</code> çš„å€¼åˆæ¢å¤åˆ°äº† <code>TRAPFRAME</code> åæ‰§è¡Œäº† <code>sret</code> æŒ‡ä»¤ï¼Œçš†å¤§æ¬¢å–œåœ°å›åˆ°äº†ç”¨æˆ·çš„ç¨‹åºä¸­ã€‚</p><h3 id=syscall-ä¸­å¦‚ä½•ä¼ é€’å‚æ•°>Syscall ä¸­å¦‚ä½•ä¼ é€’å‚æ•° <a href=#syscall-%e4%b8%ad%e5%a6%82%e4%bd%95%e4%bc%a0%e9%80%92%e5%8f%82%e6%95%b0 class=anchor>ğŸ”—</a></h3><p>ç”±äºåœ¨è¿›å…¥ç³»ç»Ÿè°ƒç”¨ä¹‹å‰ï¼Œæ‰€æœ‰çš„å¯„å­˜å™¨éƒ½è¢«å­˜åœ¨äº† <code>trapframe</code> é¡µä¸­ï¼Œå› æ­¤ syscall å‡½æ•°åªéœ€è¦ä»å½“å‰è¿›ç¨‹çš„ <code>trapframe</code> ä¸­è·å–å¯„å­˜å™¨å†…å®¹ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a2f;font-weight:700>static</span> uint64
</span></span><span style=display:flex><span><span style=color:#00a000>argraw</span>(<span style=color:#0b0;font-weight:700>int</span> n)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>struct</span> proc <span style=color:#666>*</span>p <span style=color:#666>=</span> <span style=color:#00a000>myproc</span>();
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>switch</span> (n) {
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>case</span> <span style=color:#666>0</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> p<span style=color:#666>-&gt;</span>trapframe<span style=color:#666>-&gt;</span>a0;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>case</span> <span style=color:#666>1</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> p<span style=color:#666>-&gt;</span>trapframe<span style=color:#666>-&gt;</span>a1;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>case</span> <span style=color:#666>2</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> p<span style=color:#666>-&gt;</span>trapframe<span style=color:#666>-&gt;</span>a2;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>case</span> <span style=color:#666>3</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> p<span style=color:#666>-&gt;</span>trapframe<span style=color:#666>-&gt;</span>a3;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>case</span> <span style=color:#666>4</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> p<span style=color:#666>-&gt;</span>trapframe<span style=color:#666>-&gt;</span>a4;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>case</span> <span style=color:#666>5</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> p<span style=color:#666>-&gt;</span>trapframe<span style=color:#666>-&gt;</span>a5;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#00a000>panic</span>(<span style=color:#b44>&#34;argraw&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>-</span><span style=color:#666>1</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=kernel-mode-ä¸‹çš„-trap>Kernel mode ä¸‹çš„ trap <a href=#kernel-mode-%e4%b8%8b%e7%9a%84-trap class=anchor>ğŸ”—</a></h3><p>CPU å¤„äº kernel mode çš„æ—¶å€™ï¼Œ <code>stvec</code> å¯„å­˜å™¨çš„å€¼æŒ‡å‘çš„æ˜¯ <code>kernelvec</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„è¡Œä¸ºå’Œ <code>uservec</code> å¾ˆç›¸ä¼¼ï¼Œå­˜ä¸‹å½“å‰çš„æ‰€æœ‰å¯„å­˜å™¨ï¼ˆ31ä¸ªï¼‰ï¼Œç„¶åè°ƒç”¨ <code>kerneltrap</code> ã€‚</p><p>æ³¨æ„è¿™é‡Œçš„æœºåˆ¶éœ€è¦ä¸¤ä¸ªä¸œè¥¿æ¥å¸®åŠ©ï¼š</p><ol><li>å†…æ ¸çš„é¡µè¡¨éœ€è¦ä¿è¯æŸä¸ªè™šæ‹Ÿåœ°å€åˆ° <code>kernelvec</code> çš„æ˜ å°„ï¼›</li><li>éœ€è¦å†…æ ¸ stack å¸®å¿™ä¿å­˜å¯„å­˜å™¨ã€‚</li></ol><p>Kernel mode ä¸‹çš„ trap åªæœ‰ä¸¤ç±»ï¼šè®¾å¤‡ä¸­æ–­å’Œå¼‚å¸¸ï¼Œxv6 çš„å¼‚å¸¸å¤„ç†æ¯”è¾ƒç®€å•ï¼Œç›´æ¥æŠ¥é”™ã€‚</p><p>è®¾å¤‡ä¸­æ–­ä¸­æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ä¸­æ–­å«åš<strong>æ—¶é’Ÿä¸­æ–­</strong>ï¼Œè¿™ä¸ªæ—¶å€™ä¼šè°ƒç”¨ <code>yield</code> æ¥æŒ‚èµ·è‡ªå·±ã€‚ï¼ˆè¿™ä¸ªæœºåˆ¶å’Œè°ƒåº¦å‡½æ•° <code>scheduler</code> æœ‰å…³ç³»ï¼‰</p><p>åœ¨æŸä¸ªæ—¶é—´ç‚¹ï¼Œ<code>kerneltrap</code> å‡†å¤‡è¿”å›åï¼Œå®ƒä¼šé‡æ–°è®¾ç½®å›ä¹‹å‰ä¿å­˜åœ¨<strong>å†…æ ¸æ ˆ</strong>ä¸Šçš„ <code>sepc</code> ã€<code>sstatus</code> ï¼ˆè¿™é‡Œæ˜¯åœ¨ <code>kerneltrap</code> å‡½æ•°é‡Œä¿å­˜çš„ï¼‰ï¼Œç„¶åå†å›åˆ° <code>kernelvec</code> ï¼Œæ¢å¤ä¹‹å‰çš„é‚£ 31 ä¸ªå¯„å­˜å™¨ï¼Œç„¶åè¿è¡Œ <code>sret</code> æŒ‡ä»¤ï¼Œæ¢å¤åŸæœ¬çš„æ‰§è¡Œæµã€‚</p><h3 id=trap-lab>Trap lab <a href=#trap-lab class=anchor>ğŸ”—</a></h3><p>Trap çš„ä¸œè¥¿å¿«è¯»å®Œäº†ï¼Œè¿˜å‰©ä¸€ä¸ª COW æ²¡è¯»ï¼Œå…ˆåšåšçœ‹ lab å§ã€‚</p><p>é¦–å…ˆæ˜¯è¦åŠ ä¸€ä¸ª <code>backtrace</code> æ¥è¿½è¸ª function calls ï¼Œè¿™å…¶å®å¾ˆç®€å•ï¼Œå› ä¸ºå¤§è‡´å°±èƒ½çŸ¥é“è¦æ€ä¹ˆåŠäº†ï¼Œå…ˆç”¨ä¸€ä¸ªå®ä¾‹ä»£ç æ¥çœ‹çœ‹ RISC-V çš„å‡½æ•°è°ƒç”¨ã€‚é¦–å…ˆçœ‹ä¸€æ®µç®€å•çš„ C ä»£ç ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#0b0;font-weight:700>int</span> <span style=color:#00a000>g</span>(<span style=color:#0b0;font-weight:700>int</span> x) {
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>return</span> x<span style=color:#666>+</span><span style=color:#666>3</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç¿»è¯‘æˆæ±‡ç¼–æ˜¯è¿™æ ·ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>   0:	1141                	addi	sp,sp,-16
</span></span><span style=display:flex><span>   2:	e422                	sd	s0,8(sp)
</span></span><span style=display:flex><span>   4:	0800                	addi	s0,sp,16
</span></span><span style=display:flex><span>   6:	250d                	addiw	a0,a0,3
</span></span><span style=display:flex><span>   8:	6422                	ld	s0,8(sp)
</span></span><span style=display:flex><span>   a:	0141                	addi	sp,sp,16
</span></span><span style=display:flex><span>   c:	8082                	ret
</span></span></code></pre></div><p>é¦–å…ˆï¼Œè¿›å…¥å‡½æ•°åå°†æ ˆæŒ‡é’ˆï¼ˆ<code>sp</code>ï¼‰å‡ 16ï¼ˆæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆæ˜¯ 16ï¼Œæˆ‘çŒœæ˜¯ä¸ºäº†å¯¹é½ï¼‰ï¼Œç„¶åæŠŠæ—§çš„ <code>s0</code> å­˜åˆ°äº†å‰ 8 ä¸ªå­—èŠ‚ä¸­ï¼Œå†æŠŠæ—§çš„ <code>sp</code> ï¼ˆå‡ 16 ä¹‹å‰çš„ï¼‰å­˜åˆ°äº† <code>s0</code> å½“ä¸­ï¼›</p><p>åœ¨å‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œå…ˆæŠŠåˆšåˆšè¿›å…¥è¿™ä¸ª stack frame æ—¶ä¿å­˜åœ¨æ ˆä¸Šçš„æ—§å€¼è¿”å›åˆ° <code>s0</code> ä¸­ï¼Œå†é‡ç½® <code>sp</code> ï¼Œè¿è¡Œ <code>ret</code> æŒ‡ä»¤ã€‚</p><p>å¯ä»¥æƒ³è±¡ä¸€ä¸‹å‡½æ•° A è°ƒç”¨å‡½æ•° B å†è°ƒç”¨å‡½æ•° C çš„è¿‡ç¨‹ï¼š</p><p>è¿™é‡Œå‡è®¾å‡½æ•° A æ˜¯è¿™ä¸ªè¿›ç¨‹æœ€åˆæœ€åˆçš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒçš„æ ˆæ˜¯ä»æ–°åˆ†é…çš„æ ˆé¡µçš„æœ€é«˜åœ°å€å¼€å§‹çš„ã€‚</p><ol><li>ä¸€å¼€å§‹åœ¨å‡½æ•° A ä¸­ï¼Œ<code>s0</code> ä¿å­˜çš„æ˜¯ A çš„ stack frame çš„é¦–æŒ‡é’ˆï¼ˆé«˜åœ°å€ï¼‰ï¼›</li><li>è¿›å…¥å‡½æ•° B åï¼ŒA çš„ frame pointer è¢«ä¿å­˜åˆ°äº† B çš„ stack çš„å‰å…«ä¸ªå­—èŠ‚ä¸­ï¼Œæ­¤æ—¶ <code>s0</code> ä¿å­˜çš„æ˜¯ B çš„ frame pointerï¼›</li><li>è¿›å…¥ C åï¼ŒB çš„ pointer è¢«ä¿å­˜åœ¨äº† C çš„ stack ä¸Šï¼Œ<code>s0</code> ä¿å­˜ C çš„ pointerã€‚</li></ol><p>å¦‚æœæƒ³è¦å›æº¯ï¼Œé‚£åªéœ€è¦åœ¨å‡½æ•° C ä¸­å–å‡º <code>s0</code> çš„å€¼ï¼Œç„¶åç”¨è¿™ä¸ªå€¼å–åˆ° B çš„ frame pointerï¼Œç„¶åå±‚å±‚å¾ªç¯ï¼Œç›´åˆ°å–åˆ° 0 ä¸ºæ­¢ã€‚æ³¨æ„å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶ï¼š<strong>pointer å¦‚æœç­‰äºè¿™ä¸ª pointer æ‰€åœ¨çš„ page çš„æœ€é«˜åœ°å€ï¼Œé‚£å°±åœæ­¢ï¼Œå› ä¸ºè¿™æ„å‘³ç€è¿™æ˜¯æœ€æœ€æœ€åˆå§‹çš„ä¸€ä¸ªå‡½æ•°è°ƒç”¨ã€‚</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#0b0;font-weight:700>void</span> 
</span></span><span style=display:flex><span><span style=color:#00a000>backtrace</span>(<span style=color:#0b0;font-weight:700>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  uint64 s0 <span style=color:#666>=</span> <span style=color:#00a000>r_fp</span>();
</span></span><span style=display:flex><span>  uint64 last_s0 <span style=color:#666>=</span> <span style=color:#666>*</span>(uint64<span style=color:#666>*</span>)(s0 <span style=color:#666>-</span> <span style=color:#666>16</span>);
</span></span><span style=display:flex><span>  uint64 ra <span style=color:#666>=</span> <span style=color:#666>*</span>(uint64<span style=color:#666>*</span>)(s0 <span style=color:#666>-</span> <span style=color:#666>8</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#00a000>printf</span>(<span style=color:#b44>&#34;backtrace:</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#b44>&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>while</span> (s0 <span style=color:#666>!=</span> <span style=color:#00a000>PGROUNDUP</span>(s0)) {
</span></span><span style=display:flex><span>    <span style=color:#00a000>printf</span>(<span style=color:#b44>&#34;%p</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#b44>&#34;</span>, ra);
</span></span><span style=display:flex><span>    s0 <span style=color:#666>=</span> last_s0;
</span></span><span style=display:flex><span>    last_s0 <span style=color:#666>=</span> <span style=color:#666>*</span>(uint64<span style=color:#666>*</span>)(s0 <span style=color:#666>-</span> <span style=color:#666>16</span>);
</span></span><span style=display:flex><span>    ra <span style=color:#666>=</span> <span style=color:#666>*</span>(uint64<span style=color:#666>*</span>)(s0 <span style=color:#666>-</span> <span style=color:#666>8</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç„¶åè¦åŠ ä¸€ä¸ªç®€æ˜“çš„ signal æœºåˆ¶ï¼Œå…¶å®å¾ˆç®€å•ã€‚</p><ul><li>é¦–å…ˆè¦çŸ¥é“ <code>sigalarm</code> å’Œ <code>sigreturn</code> éƒ½æ˜¯å±äº syscall ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›å‡½æ•°çš„è°ƒç”¨å’Œè¿”å›ä¸­é—´éƒ½ä¼šå’Œå½“å‰è¿›ç¨‹çš„ <code>trapframe</code> åŸŸæ‰“äº¤é“ã€‚</li><li>å¯¹äº <code>sigalarm</code> åªè¦åœ¨ <code>proc</code> ç»“æ„ä½“ä¸­ä¿å­˜ç›¸åº”çš„ <code>alarm_ticks</code> å’Œ <code>handler</code> çš„åœ°å€å°±å¥½äº†ã€‚åŒæ—¶åœ¨ä¿å­˜ä¸€ä¸ª <code>ticks</code> è®©å®ƒæ¯äº§ç”Ÿä¸€æ¬¡æ—¶é’Ÿä¸­æ–­å°±è‡ªå¢ï¼Œå¦‚æœåœ¨æ—¶é’Ÿä¸­æ–­å‘ç”Ÿæ—¶æ—¢è®¾ç½®äº† <code>alarm_ticks</code> ã€ <code>ticks</code> åˆè¶…è¿‡äº† <code>alarm_ticks</code> å°±ä¿®æ”¹è¿”å›çš„æŒ‡ä»¤åœ°å€ï¼Œè®©å®ƒè·³è½¬åˆ° <code>handler</code>ã€‚</li><li>æ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯å¦‚ä½•è®© <code>handler</code> ç»“æŸåå†è¿”å›åˆ°åŸæœ¬è¢«æ‰“æ–­çš„æŒ‡ä»¤ã€‚æ ¹æ® MIT çš„æç¤ºï¼Œåªéœ€è¦åœ¨ä¿®æ”¹ <code>pc</code> ä¸º <code>handler</code> ä¹‹å‰ï¼ŒæŠŠæ•´ä¸ª <code>trapframe</code> ä¿å­˜ä¸‹æ¥å°±å¥½äº†ï¼ˆåœ¨ <code>proc</code> ç»“æ„ä½“ä¸­å†å¼€ä¸€ä¸ªåŸŸç”¨æ¥ä¿å­˜ï¼‰ã€‚å› ä¸º <code>sigreturn</code> ä¹Ÿæ˜¯ä¸€ä¸ª syscall ï¼Œåœ¨å®ƒè¿”å›ä¹‹å‰å†æŠŠä¹‹å‰çš„æ•´ä¸ª <code>saved_trapframe</code> è¦†ç›–å½“å‰çš„ <code>trapframe</code> ï¼Œç„¶åå†è¿”å›äº¤ç»™æ“ä½œç³»ç»Ÿï¼Œå°±èƒ½é¡ºåˆ©å›åˆ°åŸæœ¬çš„æŒ‡ä»¤ã€‚</li><li>æœ€åéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéœ€è¦ä¸€ä¸ª <code>flag</code> æ¥è¡¨æ˜æ­¤æ—¶è¯¥è¿›ç¨‹å·²ç»è¿›å…¥ <code>signal_handler</code> ï¼Œæ¥é¿å… signal çš„é‡å…¥é—®é¢˜ã€‚</li></ul><h2 id=lazy-page-allocation>Lazy page allocation <a href=#lazy-page-allocation class=anchor>ğŸ”—</a></h2><p>èµ·å› å¾ˆç®€å•ï¼Œå‡å¦‚è¯´ç”¨æˆ·è¦æ±‚å†…æ ¸åˆ†é…å¾ˆå¤šå¾ˆå¤šçš„é¡µï¼Œå†…æ ¸éœ€è¦èŠ±å¾ˆå¤šæ—¶é—´æ¥åˆ†é…ï¼Œæ‰€ä»¥äº§ç”Ÿäº† lazy allocation çš„æ¦‚å¿µã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ allocation æ˜¯é’ˆå¯¹ç”¨æˆ·çš„ heap ï¼Œæ²¡æœ‰æ¶‰åŠåˆ° stack ã€‚ä½†å…¶å®è¿™é‡Œæˆ‘æœ‰ä¸€ä¸ªç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆå¯¹æ ˆä¸å®ç°ä¸€ä¸ª lazy allocation å‘¢ï¼Ÿè™½ç„¶è¿™å…¶å®æ˜¾å¾—å¾ˆåå¸¸ï¼Œå› ä¸ºæ ˆçš„å¢é•¿å…¶å®æ˜¯ä¸å¯æ§çš„ã€‚</p><h3 id=è¿½æº¯-panic>è¿½æº¯ panic <a href=#%e8%bf%bd%e6%ba%af-panic class=anchor>ğŸ”—</a></h3><p>é¦–å…ˆå¾ˆç®€å•ï¼Œç”±äºç”¨æˆ·ç”³è¯·å †å®é™…ä¸Šåªèƒ½é€šè¿‡ system call <code>sbrk()</code> ï¼Œé‚£å®ç°æ‡’åŠ è½½çš„ç¬¬ä¸€æ­¥å°±æ˜¯<strong>ä¸åŠ è½½</strong>ï¼Œä¿®æ”¹è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å¯¹åº”çš„å‡½æ•° <code>sys_sbrk(void)</code> ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>uint64
</span></span><span style=display:flex><span><span style=color:#00a000>sys_sbrk</span>(<span style=color:#0b0;font-weight:700>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#0b0;font-weight:700>int</span> addr;
</span></span><span style=display:flex><span>  <span style=color:#0b0;font-weight:700>int</span> n;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span>(<span style=color:#00a000>argint</span>(<span style=color:#666>0</span> <span style=color:#666>&amp;</span>n)<span style=color:#666>&lt;</span><span style=color:#666>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>-</span><span style=color:#666>1</span>;
</span></span><span style=display:flex><span>  addr <span style=color:#666>=</span> <span style=color:#00a000>myproc</span>()<span style=color:#666>-&gt;</span>sz;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   * åˆ é™¤å¯¹äº growproc() çš„è°ƒç”¨
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#00a000>myproc</span>()<span style=color:#666>-&gt;</span>sz <span style=color:#666>+=</span> n;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>return</span> addr;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™æ ·æ”¹äº†ä¹‹åå½“ç„¶ä¼š panic ï¼Œå› ä¸ºå…¶å®å‹æ ¹å°±æ²¡æœ‰æ²¡æœ‰åˆ†é…ç©ºé—´ï¼Œæ‰€ä»¥å¯¹äºè¿™äº›ç”¨æˆ·ä»¥ä¸ºå·²ç»åˆ†é…äº†ç©ºé—´çš„è™šæ‹Ÿåœ°å€çš„è®¿é—®ä¼šè§¦å‘ä¸€ä¸ªç”¨æˆ·æ€ä¸‹çš„ page fault ã€‚ä½†æˆ‘æ­¤æ—¶åœ¨æƒ³çš„æ˜¯ï¼Œåœ¨è°ƒç”¨äº† <code>echo</code> ç¨‹åºåï¼Œåˆ°åº•åœ¨å“ªä¸€æ­¥è°ƒç”¨äº† <code>sys_sbrk()</code> å‘¢ï¼Ÿè¿™ä¸ªäº‹æƒ…å…¶å®å¾ˆéš¾å»è¿½æº¯ï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿåœ¨èƒŒååšäº†å¤ªå¤šçš„äº‹æƒ…ã€‚æˆ‘ç”¨ gdb çœ‹äº†ä¸€ä¸‹ã€‚</p><p>æœ€åå‘ç°äº†å‡ ä»¶äº‹æƒ…ï¼š</p><ol><li>åœ¨ç”¨æˆ·è¾“å…¥å‘½ä»¤ <code>echo hi</code> åã€ Shell è°ƒç”¨ exec ä¹‹å‰ï¼Œå°±å·²ç»è¿›å…¥äº† trap å¹¶å¯¼è‡´ panic ã€‚</li><li><code>sys_sbrk</code> çš„è°ƒç”¨æ˜¯åœ¨è¾“å…¥å‘½ä»¤ä¹‹åï¼Œä½†æ˜¯ä¹Ÿåœ¨ Shell è°ƒç”¨ exec ä¹‹å‰ã€‚</li><li>å…¶å®è‡ªå§‹è‡ªç»ˆåªè°ƒç”¨äº†ä¸€æ¬¡ <code>sys_sbrk</code> ã€‚</li><li>ä¸Šé¢çš„é‚£æ¬¡ <code>sys_sbrk</code> çš„è°ƒç”¨æ˜¯è§¦å‘äº† trap çš„å…³é”® ã€‚</li></ol><p>æˆ‘ç”¨ gdb è¿½è¸ªåˆ°çš„äº‹æƒ…ï¼š</p><ol><li><p>é¦–å…ˆ xv6 éå¸¸æ­£å¸¸çš„å¯åŠ¨ï¼Œç›´åˆ°è¿›å…¥åˆ°ç»ˆç«¯ï¼Œä¹Ÿå°±æ˜¯ <code>sh</code> ç¨‹åºè¢«åŠ è½½è¿›æ¥ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> * sh ç¨‹åºçš„éƒ¨åˆ†ä»£ç 
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0b0;font-weight:700>int</span>
</span></span><span style=display:flex><span><span style=color:#00a000>main</span>(<span style=color:#0b0;font-weight:700>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span>(<span style=color:#00a000>fork1</span>() <span style=color:#666>==</span> <span style=color:#666>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#00a000>runcmd</span>(<span style=color:#00a000>parsecmd</span>(buf));
</span></span><span style=display:flex><span>  <span style=color:#00a000>wait</span>(<span style=color:#666>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>struct</span> cmd<span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#00a000>parsecmd</span>(<span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>*</span>s)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  cmd <span style=color:#666>=</span> <span style=color:#00a000>parseline</span>(<span style=color:#666>&amp;</span>s, es);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>struct</span> cmd<span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#00a000>parseline</span>(<span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>**</span>ps, <span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>*</span>es)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>struct</span> cmd <span style=color:#666>*</span>cmd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  cmd <span style=color:#666>=</span> <span style=color:#00a000>parsepipe</span>(ps, es);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>struct</span> cmd<span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#00a000>parsepipe</span>(<span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>**</span>ps, <span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>*</span>es)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>struct</span> cmd <span style=color:#666>*</span>cmd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  cmd <span style=color:#666>=</span> <span style=color:#00a000>parseexec</span>(ps, es);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>struct</span> cmd<span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#00a000>parseexec</span>(<span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>**</span>ps, <span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>*</span>es)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ret <span style=color:#666>=</span> <span style=color:#00a000>execcmd</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>struct</span> cmd<span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#00a000>execcmd</span>(<span style=color:#0b0;font-weight:700>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>struct</span> execcmd <span style=color:#666>*</span>cmd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  cmd <span style=color:#666>=</span> <span style=color:#00a000>malloc</span>(<span style=color:#a2f;font-weight:700>sizeof</span>(<span style=color:#666>*</span>cmd));
</span></span><span style=display:flex><span>  <span style=color:#00a000>memset</span>(cmd, <span style=color:#666>0</span>, <span style=color:#a2f;font-weight:700>sizeof</span>(<span style=color:#666>*</span>cmd));
</span></span><span style=display:flex><span>  cmd<span style=color:#666>-&gt;</span>type <span style=color:#666>=</span> EXEC;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>return</span> (<span style=color:#a2f;font-weight:700>struct</span> cmd<span style=color:#666>*</span>)cmd;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç»è¿‡äº†ä¸€ä¸ªä¸‹åˆçš„ç›®åŠ› gdbï¼Œæˆ‘ç»ˆäºå‘ç°äº†è¿™ä¸ªéå¸¸éå¸¸æ¶å¿ƒçš„è°ƒç”¨æ ˆï¼šåœ¨ç”¨æˆ·è¾“å…¥äº†ä»»ä½•å‘½ä»¤åï¼Œç»ˆç«¯ç¨‹åºï¼ˆä¹Ÿå°±æ˜¯ <code>sh</code> ï¼‰çš„æ‰§è¡Œæµæ˜¯è¿™æ ·èµ°çš„ï¼š <code>main -> parsecmd -> parseline -> parsepipe -> parseexec -> execcmd</code> ï¼Œæœ€ååˆ°è¾¾äº† <code>execcmd</code> å‡½æ•°ä¸­çš„ <code>malloc</code> è°ƒç”¨ï¼Œè¿™é‡Œçš„ <code>malloc</code> å‡½æ•°å®šä¹‰åœ¨å¦ä¸€ä¸ªæ–‡ä»¶ <code>user/umalloc.c</code> ä¸­ã€‚å¾ˆæ“è›‹çš„æ˜¯ï¼Œgdb ä¼¼ä¹æ²¡æœ‰åŠæ³•è¯†åˆ« <code>umalloc.c</code> çš„ç¬¦å·ï¼Œå› æ­¤æ‰§è¡Œæµè¿›å…¥åˆ°è¿™ä¸ªå‡½æ•°åï¼Œæˆ‘åªèƒ½å¯¹ç€çœ‹ä¸æ‡‚çš„ RISCV æ±‡ç¼–çº¯çŒœäº†ï¼Œä¸è¿‡ä¹Ÿå¤§è‡´çŒœåˆ°äº†ï¼š<code>malloc</code> å‡½æ•°è°ƒç”¨äº†åŒä¸€ä¸ªæ–‡ä»¶ä¸­å®šä¹‰çš„ <code>morecore</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a2f;font-weight:700>static</span> Header<span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#00a000>morecore</span>(uint nu)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>*</span>p;
</span></span><span style=display:flex><span>  Header <span style=color:#666>*</span>hp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span>(nu <span style=color:#666>&lt;</span> <span style=color:#666>4096</span>)
</span></span><span style=display:flex><span>    nu <span style=color:#666>=</span> <span style=color:#666>4096</span>;
</span></span><span style=display:flex><span>  p <span style=color:#666>=</span> <span style=color:#00a000>sbrk</span>(nu <span style=color:#666>*</span> <span style=color:#a2f;font-weight:700>sizeof</span>(Header));
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span>(p <span style=color:#666>==</span> (<span style=color:#0b0;font-weight:700>char</span><span style=color:#666>*</span>)<span style=color:#666>-</span><span style=color:#666>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>  hp <span style=color:#666>=</span> (Header<span style=color:#666>*</span>)p;
</span></span><span style=display:flex><span>  hp<span style=color:#666>-&gt;</span>s.size <span style=color:#666>=</span> nu;
</span></span><span style=display:flex><span>  <span style=color:#00a000>free</span>((<span style=color:#0b0;font-weight:700>void</span><span style=color:#666>*</span>)(hp <span style=color:#666>+</span> <span style=color:#666>1</span>));
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>return</span> freep;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™é‡Œæ‰å¾—çŸ¥ï¼Œæ˜¯ <code>morecore</code> å‡½æ•°çœŸæ­£æ­£æ­£çš„è°ƒç”¨äº†ç³»ç»Ÿè°ƒç”¨ <code>sbrk</code> ï¼ˆåœ¨æ±‡ç¼–æ›¾ç»è°ƒç”¨äº† <code>ecall</code>ï¼‰ã€‚ä»è°ƒè¯•çš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œå®é™…ä¸Š <code>sbrk</code> è°ƒç”¨æ˜¯æˆåŠŸçš„ï¼Œ<code>ecall</code> å’Œ <code>eret</code> éƒ½æ²¡æœ‰å‡ºå·®é”™ï¼ŒçœŸæ­£å‡ºé—®é¢˜çš„åœ°æ–¹åœ¨ <code>hp->s.size = nu;</code> è¿™å¥ C ç¨‹åºä¸Šã€‚ä»æ±‡ç¼–çš„å±‚é¢ä¸Šçœ‹ï¼Œæœºå™¨åœ¨è¿è¡ŒæŒ‡ä»¤ <code>sw s6, 8(a0)</code> åç›´æ¥æŠ¥äº† panic ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ“ä½œç³»ç»Ÿä»…ä»…ä¿®æ”¹äº†è¿›ç¨‹çš„ä¸€ä¸ªå­—æ®µè€Œæ²¡æœ‰çœŸæ­£çš„åˆ†é…ä¸€ä¸ªé¡µç»™å®ƒåï¼Œå½“è¯¥è¿›ç¨‹è¯•å›¾å»å†™ï¼ˆè¿™é‡Œ <code>sw</code> æŒ‡ä»¤å°±æ˜¯å†™å†…å­˜ï¼‰æ—¶ï¼Œè§¦å‘äº†ç”¨æˆ·æ€çš„ trap ã€‚</p></li></ol><h3 id=è§£å†³-panic>è§£å†³ panic <a href=#%e8%a7%a3%e5%86%b3-panic class=anchor>ğŸ”—</a></h3><hr><p>2021 å¹´ 8 æœˆ 10 æ—¥ï¼Œæ­¤æ—¶æˆ‘å·²ç»åšå®Œäº† lazy lab å’Œ cow labã€‚ç”±äºå¯¹å¹¶å‘çš„ lab å¹¶ä¸æ„Ÿå…´è¶£ï¼ŒæŒä¹…åŒ–çš„å†…å®¹å‡†å¤‡ä¸‹å­¦æœŸåœ¨ CSE ä¸Šå†å­¦ï¼Œå› æ­¤ 6.S081 çš„å­¦ä¹ åˆ°è¿™é‡Œæš‚æ—¶ç»“æŸï¼Œæœ‰ç©ºå†è¡¥ä¸Š lazy å’Œ cow çš„æ€è€ƒï¼Œå¼€äº†ä¸ªæ–°å‘ï¼š6.824 ã€‚</p></div><div class=tags><a href=https://jhzhu.xyz/tags/os>OS</a></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/n1ujunhui rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a><a class=symbol href=https://twitter.com/niujunhui rel=me target=_blank><svg fill="#bbb" width="28" height="28" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="438.536" height="438.536" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536"><g><path d="M414.41 24.123C398.333 8.042 378.963.0 356.315.0H82.228C59.58.0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648.0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225C438.532 59.576 430.49 40.204 414.41 24.123zM335.471 168.735c.191 1.713.288 4.278.288 7.71.0 15.989-2.334 32.025-6.995 48.104-4.661 16.087-11.8 31.504-21.416 46.254-9.606 14.749-21.074 27.791-34.396 39.115-13.325 11.32-29.311 20.365-47.968 27.117-18.648 6.762-38.637 10.143-59.953 10.143-33.116.0-63.76-8.952-91.931-26.836 4.568.568 9.329.855 14.275.855 27.6.0 52.439-8.565 74.519-25.7-12.941-.185-24.506-4.179-34.688-11.991-10.185-7.803-17.273-17.699-21.271-29.691 4.947.76 8.658 1.137 11.132 1.137 4.187.0 9.042-.76 14.56-2.279-13.894-2.669-25.598-9.562-35.115-20.697-9.519-11.136-14.277-23.84-14.277-38.114v-.571c10.085 4.755 19.602 7.229 28.549 7.422-17.321-11.613-25.981-28.265-25.981-49.963.0-10.66 2.758-20.747 8.278-30.264 15.035 18.464 33.311 33.213 54.816 44.252 21.507 11.038 44.54 17.227 69.092 18.558-.95-3.616-1.427-8.186-1.427-13.704.0-16.562 5.853-30.692 17.56-42.399 11.703-11.706 25.837-17.561 42.394-17.561 17.515.0 32.079 6.283 43.688 18.846 13.134-2.474 25.892-7.33 38.26-14.56-4.757 14.652-13.613 25.788-26.55 33.402 12.368-1.716 23.88-4.95 34.537-9.708C357.458 149.793 347.462 160.166 335.471 168.735z"/></g></svg></a></div><div class=copyright>Â© Copyright
2023
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Junhui Zhu</div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-mini>nodejh</a></div></footer></body></html>